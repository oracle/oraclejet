/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojcomponentcore","ojs/ojconfig","ojs/ojhtmlutils","ojs/ojlogger","ojs/ojthemeutils","ojs/ojlistdataproviderview","ojs/ojtreedataproviderview","ojs/ojcontext","ojs/ojtimerutils","ojs/ojkeyset","ojs/ojeditablevalue","ojs/ojlistview","ojs/ojbutton","ojs/ojpopupcore","ojs/ojinputtext","ojs/ojbutton"],function(e,t,i,n,r,o,a,s,l,d,u,c){"use strict";var h={properties:{data:{type:"oj.DataProvider"},describedBy:{type:"string"},disabled:{type:"boolean",value:!1},displayOptions:{type:"object",properties:{helpInstruction:{type:"Array<string>|string",value:["notewindow"]},messages:{type:"Array<string>|string",value:["inline"]}}},help:{type:"object",properties:{instruction:{type:"string",value:""}}},helpHints:{type:"object",properties:{definition:{type:"string",value:""},source:{type:"string",value:""}}},itemText:{type:"string|function",value:"label"},labelEdge:{type:"string",enumValues:["inside","none","provided"]},labelHint:{type:"string",value:""},labelledBy:{type:"string"},messagesCustom:{type:"Array<Object>",writeback:!0,value:[]},placeholder:{type:"string",value:""},readonly:{type:"boolean",value:!1},required:{type:"boolean",value:!1},translations:{type:"object",value:{},properties:{cancel:{type:"string"},labelAccOpenDropdown:{type:"string"},multipleMatchesFound:{type:"string"},nOrMoreMatchesFound:{type:"string"},noMatchesFound:{type:"string"},noResultsLine1:{type:"string"},noResultsLine2:{type:"string"},oneMatchFound:{type:"string"},required:{type:"object",properties:{hint:{type:"string"},messageDetail:{type:"string"},messageSummary:{type:"string"}}}}},valid:{type:"string",writeback:!0,enumValues:["invalidHidden","invalidShown","pending","valid"],readOnly:!0},value:{type:"any",writeback:!0},valueItem:{type:"object",writeback:!0,value:{key:null,data:null,metadata:null}},virtualKeyboard:{type:"string",enumValues:["email","number","search","tel","text","url"],value:"search"}},methods:{refresh:{},validate:{},reset:{},showMessages:{},setProperty:{},getProperty:{},setProperties:{},getNodeBySubId:{},getSubIdByNode:{}},events:{ojAnimateStart:{},ojAnimateEnd:{}},extension:{}};function p(t){function i(e,t){var i=new function(e,t){this.next=function(){var i=e.next();return new Promise(function(e,n){i.then(function(i){var n=i.value;n.data&&(t.count+=n.data.length),t.done=i.done,e(i)},function(e){n(e)})})}}(e,t);this[Symbol.asyncIterator]=function(){return i}}this._fetchedDataCount={count:0,done:!0},this.setFilterCriterion=function(t){var i,n,r=this._filterCriterion;if(this._filterCriterion=t,i=r,n=this._filterCriterion,!(i===n||!i&&!n||i&&n&&i.text===n.text)){var o=new e.DataProviderRefreshEvent;Object.defineProperty(o,"filterCriterionChanged",{value:!0}),this.dispatchEvent(o)}},this.getFetchedDataCount=function(){return this._fetchedDataCount},this.fetchFirst=function(e){if(t)return this._filterCriterion&&(e.filterCriterion=this._filterCriterion),this._fetchedDataCount={count:0,done:!0},new i(t.fetchFirst(e)[Symbol.asyncIterator](),this._fetchedDataCount);var n={};return n[Symbol.asyncIterator]=function(){return{next:function(){return Promise.resolve({value:{data:[],fetchParameters:e,metadata:[]},done:!0})}}},n},this.containsKeys=function(e){return t?t.containsKeys(e):Promise.resolve({containsParameters:e,results:new Set})},this.fetchByKeys=function(e){return t?t.fetchByKeys(e):Promise.resolve({fetchParameters:e,results:new Map})},this.fetchByOffset=function(e){return t?t.fetchByOffset(e):Promise.resolve({done:!0,fetchParameters:e,results:[]})},this.isEmpty=function(){return t?t.isEmpty():"yes"},this.getTotalSize=function(){return t?t.getTotalSize():Promise.resolve(0)},this.addEventListener=function(e,i){t&&t.addEventListener(e,i)},this.removeEventListener=function(e,i){t&&t.removeEventListener(e,i)},this.dispatchEvent=function(e){return!t||t.dispatchEvent(e)},this.getCapability=function(e){return t?t.getCapability(e):null},t&&e.DataProviderFeatureChecker.isTreeDataProvider(t)&&(this.getChildDataProvider=function(){var e=t.getChildDataProvider.apply(t,arguments);return e&&(e=new p(e),this._filterCriterion&&e.setFilterCriterion(this._filterCriterion)),e}.bind(this))}var v,_={KEYS:{TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46},ValueChangeTriggerTypes:{OPTION_SELECTED:"option_selected"},_isControlKey:function(e){switch(e.which){case _.KEYS.SHIFT:case _.KEYS.CTRL:case _.KEYS.ALT:return!0;default:return e.metaKey||e.ctrlKey}},_isFunctionKey:function(e){var t=e.which?e.which:e;return t>=112&&t<=123},isControlOrFunctionKey:function(e){return _._isControlKey(e)||_._isFunctionKey(e)},nextUid:(v=1,function(){var e=v;return v+=1,e}),killEvent:function(e){e.preventDefault()},stopEventPropagation:function(e){e.stopPropagation()},addBusyState:function(e,t){var i={description:"The component identified by '"+e.id+"' "+t};return d.getContext(e).getBusyContext().addBusyState(i)},createValueItem:function(e,t,i){return{key:e,data:t,metadata:i}},dispatchCustomEvent:function(e,t,i,n){var r=n||{};r.subtype=i;var o={bubbles:!1,cancelable:!1,detail:r};return e.dispatchEvent(new CustomEvent(t,o))},isValueItemForPlaceholder:function(e){return null==e||_.isValueForPlaceholder(e.key)},isValueForPlaceholder:function(e){return null==e},copyAttribute:function(e,t,i,n){var r=e.getAttribute(t);null===r?i.removeAttribute(n):i.setAttribute(n,r)}},f=function(e){this._dataProvider=e.dataProvider,this._fullScreenPopup=e.fullScreenPopup,this._bodyElem=t(e.bodyElem),this._itemTemplate=e.itemTemplate,this._collectionTemplate=e.collectionTemplate,this._getTemplateEngineFunc=e.getTemplateEngineFunc,this._templateContextComponentElement=e.templateContextComponentElement,this._getTranslatedStringFunc=e.getTranslatedStringFunc,this._addBusyStateFunc=e.addBusyStateFunc,this._itemTextRendererFunc=e.itemTextRendererFunc,this._filterInputText=e.filterInputText;var i=this._addBusyStateFunc("LovDropdown initializing");this._addDataProviderEventListeners();var n,r,o=this._createInnerDom(e);this._containerElem=o;var a=new Promise(function(e,t){n=e,r=t});(this._collectionContext={parentElement:this._containerElem[0],idSuffix:e.idSuffix,renderDone:n,renderError:r,data:this._dataProvider,searchText:void 0,selected:void 0,selectedItem:void 0,selectedItemChangedListener:this._handleCollectionSelectedItemChanged.bind(this)},this._collectionRendererFunc=this._collectionTemplate?this._templateCollectionRenderer.bind(this):this._defaultCollectionRenderer.bind(this),this._collectionRendererFunc(this._collectionContext),e.fullScreenPopup)&&o.find("#cancelButton_"+e.idSuffix).on("ojAction",function(){this._dispatchEvent("cancelDropdown")}.bind(this));o.on("change","."+e.className+"-input",_.stopEventPropagation),o.on("click mouseup mousedown",_.stopEventPropagation);var s=function(){e.afterDropdownInitFunc&&e.afterDropdownInitFunc(this._resultsElem[0]),i()}.bind(this);a.then(s,s),o.on("keydown",this._handleKeyDown.bind(this))};f.prototype._dispatchEvent=function(e,t){return _.dispatchCustomEvent(this._containerElem[0],"lovDropdownEvent",e,t)},f.prototype.destroy=function(){(this._itemTemplate||this._collectionTemplate)&&this._getTemplateEngineFunc().then(function(e){e.clean(this._containerElem[0])}.bind(this)),this._removeDataProviderEventListeners()},f.prototype.getElement=function(){return this._containerElem[0]},f.prototype._createInnerDom=function(e){var i=e.idSuffix,n=e.getTranslatedStringFunc,r=document.createElement("div");if(r.setAttribute("data-oj-containerid",e.parentId),r.setAttribute("data-oj-context",""),r.setAttribute("id","lovDropdown_"+i),r.setAttribute("class","oj-listbox-drop oj-listbox-searchselect"+(this._fullScreenPopup?" oj-listbox-fullscreen":"")),r.style.display="none",r.setAttribute("role","presentation"),this._fullScreenPopup){var o=n("cancel"),a=document.createElement("oj-button");a.textContent=o,a.setAttribute("id","cancelButton_"+i),a.setAttribute("chroming","half"),a.setAttribute("data-oj-internal",""),a.setAttribute("data-oj-binding-provider","none"),a.setAttribute("class","oj-searchselect-cancel"),r.appendChild(a),r.appendChild(this._filterInputText)}var s=document.createElement("div");return s.setAttribute("class","oj-searchselect-results-placeholder"),r.appendChild(s),t(r)},f._highlighter=function(e,t){return t&&t.length>0?e.replace(new RegExp(t,"gi"),'<span class="oj-listbox-highlighter">$&</span>'):e},f.prototype._defaultItemRenderer=function(e){for(var t=e.parentElement,i=this._itemTextRendererFunc({key:e.key,data:e.data,metadata:e.metadata}),n=!1===e.leaf?i:f._highlighter(i,this._collectionContext.searchText),o=r.stringToNodeArray("<span>"+n+"</span>"),a=0;a<o.length;a++)t.appendChild(o[a])},f.prototype._templateItemRenderer=function(e,i){var n=t.extend({},i);n.componentElement=this._templateContextComponentElement,n.searchText=this._collectionContext.searchText;var r=n.parentElement;if(e)for(var o=e.execute(n.componentElement,this._itemTemplate,n),a=0;a<o.length;a++)r.appendChild(o[a])},f.prototype.renderResults=function(e,t,i){var n,r,a=this._addBusyStateFunc("LovDropdown rendering results");this._latestFilterCriteria=t,this._dataProvider.setFilterCriterion(t),this._duringListViewInitialization=!0;var s=new Promise(function(e,t){n=e,r=t}),l=this._collectionContext;l.data=this._dataProvider,l.searchText=e,l.selected=new c.KeySetImpl([i]),l.renderDone=n,l.renderError=r,this._collectionRendererFunc(l);var u=function(){this._duringListViewInitialization=!1,a()}.bind(this);return new Promise(function(e,t){s.then(function(){d.getContext(this._containerElem[0]).getBusyContext().whenReady().then(e,t)}.bind(this),t)}.bind(this)).then(function(){u()},function(e){o.warn("Select: LovDropdown.renderResults retPromise rejected: "+e),u()})},f.prototype.updateLabel=function(e,t){var i=this._resultsElem;if(!this._collectionTemplate&&i){var n=i[0];e?n.setAttribute("aria-labelledby",e):t&&n.setAttribute("aria-label",t)}},f.prototype._defaultCollectionRenderer=function(i){var n;if(this._resultsElem)n=this._resultsElem[0],d.getContext(n).getBusyContext().whenReady().then(function(){n.data=i.data,n.selected=i.selected,i.renderDone()},function(e){o.warn("Select: busyContext promise rejected before setting props on listView: "+e),i.renderError(e)});else{var r=t(i.parentElement).find(".oj-searchselect-results-placeholder")[0],a=i.idSuffix;(n=document.createElement("oj-list-view")).setAttribute("data-oj-internal",""),n.setAttribute("data-oj-binding-provider","none"),n.setAttribute("id","oj-searchselect-results-"+a),n.setAttribute("selection-mode","single"),n.setAttribute("class","oj-select-results"),n.setAttribute("drill-mode","none"),n.setAttribute("gridlines.item","hidden");var s=document.createElement("template");s.setAttribute("slot","noData");var l=document.createElement("div");l.setAttribute("class","oj-searchselect-no-results-container");var u=document.createElement("span");u.setAttribute("class","oj-searchselect-no-results-line1"),u.innerText=this._getTranslatedStringFunc("noResultsLine1"),l.appendChild(u);var c=document.createElement("span");c.setAttribute("class","oj-searchselect-no-results-line2 oj-label-nocomp"),c.innerText=this._getTranslatedStringFunc("noResultsLine2"),l.appendChild(c),s.content?s.content.appendChild(l):s.appendChild(l),n.appendChild(s),i.parentElement.replaceChild(n,r),this._resultsElem=t(n),this._resultsElem.on("click",_.killEvent),d.getContext(n).getBusyContext().whenReady().then(function(){n.addEventListener("firstSelectedItemChanged",function(e){i.selectedItemChangedListener(e.detail.value)}),i.data&&e.DataProviderFeatureChecker&&e.DataProviderFeatureChecker.isTreeDataProvider(i.data)&&(n.setProperty("item.focusable",function(e){return e.leaf}),n.setProperty("item.selectable",function(e){return e.leaf})),this._itemTemplate?this._getTemplateEngineFunc().then(function(e){n.setProperty("item.renderer",this._templateItemRenderer.bind(this,e)),i.renderDone()}.bind(this),function(e){o.warn("Select: template item renderer template engine promise rejected: "+e),i.renderError(e)}):(n.setProperty("item.renderer",this._defaultItemRenderer.bind(this)),i.renderDone())}.bind(this),function(e){o.warn("Select: creating default listView busyContext promise rejected: "+e),i.renderError(e)})}},f.prototype._templateCollectionRenderer=function(e){if(this._resultsElem){var i=this._collectionTemplateContext;i.data=e.data,i.searchText=e.searchText,i.selected=e.selected,e.renderDone()}else{var n=t(e.parentElement),r=n.find(".oj-searchselect-results-placeholder")[0];this._getTemplateEngineFunc().then(function(t){this._collectionTemplateContext=this._createCollectionTemplateContext(t,e);for(var i=t.execute(this._templateContextComponentElement,this._collectionTemplate,this._collectionTemplateContext),o=0;o<i.length;o++)r.parentNode.insertBefore(i[o],r);r.parentNode.removeChild(r),this._resultsElem=n.find(".oj-select-results"),this._resultsElem.on("click",_.killEvent),e.renderDone()}.bind(this),function(t){o.warn("Select: template collection renderer template engine promise rejected: "+t),e.renderError(t)})}},f.prototype._addDataProviderEventListeners=function(){var e=this._dataProvider;if(e){var t=this._handleDataProviderEvent.bind(this);this._savedDataProviderEH=t,e.addEventListener("mutate",t),e.addEventListener("refresh",t)}},f.prototype._removeDataProviderEventListeners=function(){var e=this._dataProvider,t=this._savedDataProviderEH;e&&t&&(e.removeEventListener("mutate",t),e.removeEventListener("refresh",t),this._savedDataProviderEH=void 0)},f.prototype._handleDataProviderEvent=function(e){var t=this._addBusyStateFunc("LovDropdown handling data provider event");d.getContext(this._containerElem[0]).getBusyContext().whenReady().then(function(){t()},function(e){o.warn("Select: LovDropdown.handleDataProviderEvent busyContext promise rejected: "+e),t()})},f.prototype.close=function(){var t=document.activeElement;e.DomUtils.isAncestor(this.getElement(),t)&&t.blur();var i={};i[e.PopupService.OPTION.POPUP]=this._containerElem,e.PopupService.getInstance().close(i),this._containerElem.detach(),this._dispatchEvent("dropdownClosed")},f.prototype.open=function(){var t=this._containerElem;t[0]!==this._bodyElem.children().last()[0]&&t.appendTo(this._bodyElem);var i={};i[e.PopupService.EVENT.POPUP_CLOSE]=function(){this._dispatchEvent("closeDropdown",{trigger:"popupCloseEvent"})}.bind(this),i[e.PopupService.EVENT.POPUP_REMOVE]=this._surrogateRemoveHandler.bind(this),i[e.PopupService.EVENT.POPUP_AUTODISMISS]=this._clickAwayHandler.bind(this),i[e.PopupService.EVENT.POPUP_REFRESH]=function(){this._dispatchEvent("sizeDropdown")}.bind(this),i[e.PopupService.EVENT.POPUP_AFTER_OPEN]=function(e){this._dispatchEvent("adjustDropdownPosition",{popupElem:e.popup[0]})}.bind(this);var n={};n[e.PopupService.OPTION.POPUP]=t,n[e.PopupService.OPTION.EVENTS]=i,n[e.PopupService.OPTION.LAYER_SELECTORS]="oj-listbox-drop-layer",n[e.PopupService.OPTION.CUSTOM_ELEMENT]=!0,this._fullScreenPopup&&(n[e.PopupService.OPTION.MODALITY]=e.PopupService.MODALITY.MODAL),this._dispatchEvent("openPopup",{psOptions:n}),this._dispatchEvent("sizeDropdown")},f.prototype._clickAwayHandler=function(e){var i=this._containerElem,n=t(e.target);if(!n.closest(i).length&&!n.closest("#"+t.escapeSelector(i.attr("data-oj-containerid"))).length){var r=i.closest(".oj-listbox-drop-layer");r.length>0&&n.closest(r).length>0||i.length>0&&this._dispatchEvent("closeDropdown",{trigger:"clickAway"})}},f.prototype._surrogateRemoveHandler=function(){this._containerElem&&this._containerElem.remove()},f.prototype._handleKeyDown=function(t){if(t.which===_.KEYS.TAB){var i=this._containerElem,n=e.FocusUtils.getFirstTabStop(i),r=e.FocusUtils.getLastTabStop(i),o=t.target;n===o&&t.shiftKey?(t.preventDefault(),r&&e.FocusUtils.focusElement(r)):r!==o||t.shiftKey||(t.preventDefault(),n&&e.FocusUtils.focusElement(n))}else t.which===_.KEYS.ESC&&this._dispatchEvent("closeDropdown",{trigger:"escKeyDown"})},f.prototype._handleCollectionSelectedItemChanged=function(e,t){if(!this._duringListViewInitialization){var i=_.isValueItemForPlaceholder(e)?null:e;this._collectionContext.selectedItem=i,this._handleSelection(i,t)}},f.prototype._handleSelection=function(e,t){if(e){var i={trigger:_.ValueChangeTriggerTypes.OPTION_SELECTED};this._dispatchEvent("handleSelection",{valueItem:e,selectionOptions:i,event:t})}},f.prototype._createCollectionTemplateContext=function(e,t){var i={};return e?(i.data=t.data,i.searchText=t.searchText,e.defineTrackableProperty(i,"selected"),e.defineTrackableProperty(i,"selectedItem",void 0,t.selectedItemChangedListener)):o.error("JET Select: template engine not available when creating context for collectionTemplate"),i};var m=function(e){this._showIndicatorDelay=e.showIndicatorDelay,this._addBusyStateFunc=e.addBusyStateFunc,this._forceReadOnly=e.forceReadOnly,this._setLoadingFunc=e.setLoadingFunc,this._clearLoadingFunc=e.clearLoadingFunc,this._containerElem=this._createInnerDom(e);var i=t(this._containerElem).find("input."+e.className+"-input");this._inputElem=i[0]};m.prototype.getElement=function(){return this._containerElem},m.prototype.getInputElem=function(){return this._inputElem},m.prototype._createInnerDom=function(e){var t=e.className,i=e.idSuffix,n=e.inputType,r=e.enabled,o=e.readOnly,a=e.ariaLabel,s=e.ariaControls,l=document.createElement("div");l.setAttribute("class","oj-text-field-container"),l.setAttribute("role","presentation");var d=document.createElement("div");d.setAttribute("class","oj-text-field-middle"),l.appendChild(d);var u=document.createElement("input");u.setAttribute("id",t+"-input-"+i),u.setAttribute("autocomplete","off"),u.setAttribute("autocorrect","off"),u.setAttribute("autocapitalize","off"),u.setAttribute("spellcheck","false"),u.setAttribute("class",t+"-input oj-text-field-input"),u.setAttribute("aria-autocomplete","list"),u.setAttribute("placeholder",e.placeholder),u.disabled=!r&&!o,(o||this._forceReadOnly&&r)&&u.setAttribute("readonly","true"),o||(u.setAttribute("role","combobox"),u.setAttribute("aria-expanded","false")),a&&u.setAttribute("aria-label",a),s&&u.setAttribute("aria-controls",s),null!==n&&""!==n?u.setAttribute("type",n):u.setAttribute("type","text"),d.appendChild(u);var c=e.getTranslatedStringFunc("labelAccOpenDropdown"),h=document.createElement("a"),p=t+"-arrow "+t+"-open-icon "+t+"-icon oj-component-icon oj-clickable-icon-nocontext";return o||r||(p+=" oj-disabled"),h.setAttribute("class",p),h.setAttribute("role","presentation"),h.setAttribute("aria-label",c),l.appendChild(h),l},m.prototype.updateLabel=function(e){e&&this._inputElem.setAttribute("aria-labelledby",e)},m.prototype.setUiLoadingState=function(e){"start"===e?(this._loadingIndicatorTimer&&this._loadingIndicatorTimer.clear(),this._loadingIndicatorTimer=u.getTimer(this._showIndicatorDelay),this._loadingIndicatorTimer.getPromise().then(function(e){e&&this._addLoadingIndicator()}.bind(this))):"stop"===e&&(this._loadingIndicatorTimer&&(this._loadingIndicatorTimer.clear(),this._loadingIndicatorTimer=null),this._removeLoadingIndicator())},m.prototype._addLoadingIndicator=function(){var e=this._containerElem;void 0===e._loadingIndicatorCount?e._loadingIndicatorCount=1:e._loadingIndicatorCount+=1,e._saveLoadingIndicator||(this._setLoadingFunc(),e._saveLoadingIndicator=!0)},m.prototype._removeLoadingIndicator=function(){var e=this._containerElem;void 0!==e._loadingIndicatorCount&&(1===e._loadingIndicatorCount?(e._loadingIndicatorCount=void 0,e._saveLoadingIndicator&&(this._clearLoadingFunc(),e._saveLoadingIndicator=void 0)):e._loadingIndicatorCount-=1)};var g=function(e){this._minLength=0,this._fetchRateLimit=150,this._className=e.className,this._dataProvider=e.dataProvider,this._containerElem=e.containerElem,this._fullScreenPopup=e.fullScreenPopup,this._idSuffix=e.idSuffix,this._enabled=e.enabled,this._readonly=e.readOnly,this._value=e.value,this._getTranslatedStringFunc=e.getTranslatedStringFunc,this._addBusyStateFunc=e.addBusyStateFunc,this._lovMainField=e.lovMainField,this._filterInputText=e.filterInputText,this._lovDropdown=e.lovDropdown,this._liveRegion=e.liveRegion,this._showMainFieldFunc=e.showMainFieldFunc,this._setFilterFieldTextFunc=e.setFilterFieldTextFunc,this._queryCount=0,this._fetchType=this.hasData()?"init":null};g.prototype.setValue=function(e){this._value=e},g.prototype.getFetchType=function(){return this._fetchType},g.prototype.destroy=function(){var e=this._closeDelayTimer;isNaN(e)||(delete this._closeDelayTimer,window.clearTimeout(e)),this.closeDropdown()},g.prototype.hasData=function(){return null!=this._dataProvider},g.prototype.isDropdownOpen=function(){return t(this._containerElem).hasClass("oj-listbox-dropdown-open")},g.prototype._usingHandler=function(i,n){if(e.PositionUtils.isAligningPositionClipped(n)){var r=this._addBusyStateFunc("closing popup");this._closeDelayTimer=window.setTimeout(function(){this.closeDropdown(),r()}.bind(this),1)}else{var o=t(this._containerElem),a=n.element.element;a.css(i),"bottom"===n.vertical?(o.addClass("oj-listbox-drop-above"),a.addClass("oj-listbox-drop-above")):(o.removeClass("oj-listbox-drop-above"),a.removeClass("oj-listbox-drop-above"))}},g.prototype.getDropdownPosition=function(){var t;if(this._fullScreenPopup){var i=window.scrollX||window.pageXOffset,n=window.scrollY||window.pageYOffset;t={my:"start top",at:"start top",of:window,offset:{x:i,y:n}}}else t={my:"start top",at:"start bottom",of:this._lovMainField.getElement(),collision:"flip",using:this._usingHandler.bind(this)};var r="rtl"===e.DomUtils.getReadingDirection();return e.PositionUtils.normalizeHorizontalAlignment(t,r)},g.prototype.sizeDropdown=function(){var e=this._lovDropdown.getElement();if(this._fullScreenPopup){var i=Math.min(window.innerWidth,window.screen.availWidth),n=Math.min(window.innerHeight,window.screen.availHeight);e.style.width=i+"px",e.style.height=n+"px"}else e.style.minWidth=t(this._containerElem).outerWidth()+"px"},g.prototype.adjustDropdownPosition=function(e){if(!this._fullScreenPopup){var i,n,r=t(e),o=e.getBoundingClientRect(),a=this._containerElem.getBoundingClientRect(),s=Math.min(window.innerHeight,window.screen.availHeight),l=Math.min(window.innerWidth,window.screen.availWidth);if(o.y>a.y)i=s-o.y-10;else{i=a.y-10;var d=r.css("height"),u=parseFloat(d);if(u>i){var c=u-i,h=r.css("top"),p=parseFloat(h);r.css("top",p+c+"px")}}if(o.x>=a.x)n=l-o.x-10;else{n=a.right-10;var v=r.css("width"),_=parseFloat(v);if(_>n){var f=_-n,m=r.css("left"),g=parseFloat(m);r.css("left",g+f+"px")}}r.css("max-height",i+"px"),r.css("max-width",n+"px")}},g.prototype.openDropdown=function(e){return!this.isDropdownOpen()&&!1!==this._enabled&&!0!==this._readonly&&(this._fullScreenPopup&&this._setFilterFieldTextFunc(""),t(this._containerElem).addClass("oj-listbox-dropdown-open"),e||this.updateResults(!0,this._fullScreenPopup),!0)},g.prototype.closeDropdown=function(){if(this.isDropdownOpen()){var e=t(this._containerElem);e.removeClass("oj-listbox-dropdown-open"),this._ariaExpanded&&(e.removeClass("oj-listbox-drop-above"),t(this._lovDropdown.getElement()).removeClass("oj-listbox-drop-above"),this._lovDropdown.close(),this._ariaExpanded=!1,this._lovMainField.getInputElem().setAttribute("aria-expanded","false"),this._lastSearchTerm=null)}},g.prototype.updateResults=function(e,t){var i=this._filterInputText.rawValue||"",n=this._lastSearchTerm;if(!0===e||!n||i!==n)if(this._lastSearchTerm=i,i.length>=this._minLength)if(this._queryTimer&&this._queryTimer.clear(),e&&!0!==e){var r=this._addBusyStateFunc("query results");this._queryTimer=u.getTimer(this._fetchRateLimit),this._queryTimer.getPromise().then(function(n){n&&this._runQuery(e,i,t)}.bind(this)).then(r)}else this._runQuery(e,i,t);else this.closeDropdown()},g.prototype._runQuery=function(t,i,n){var r,a=this._lovDropdown,s=this;this._minLength>i.length?this.closeDropdown():(this.openDropdown(!0),this._queryCount+=1,r=this._queryCount,null!=i&&(!0!==t||this._minLength>0)||(i=""),this.hasData()&&(this._ariaExpanded||(a.open(),this._ariaExpanded=!0,this._lovMainField.getInputElem().setAttribute("aria-expanded","true")),n&&e.FocusUtils.focusFirstTabStop(a.getElement()),this._fetchFromDataProvider(i).then(function(){s._handleQueryResultsFetch(r)},function(e){o.warn("Select: _fetchFromDataProvider promise was rejected: "+e),s._handleQueryResultsFetch(r)})))},g.prototype._handleQueryResultsFetch=function(e){if(e===this._queryCount&&this.isDropdownOpen()){var t,i=this._dataProvider?this._dataProvider.getFetchedDataCount():null,n=i?i.count:0,r=!i||i.done;0===n?t=this._getTranslatedStringFunc("noMatchesFound"):(this.sizeDropdown(),t=r?this._getTranslatedStringFunc("multipleMatchesFound",{num:String(n)}):this._getTranslatedStringFunc("nOrMoreMatchesFound",{num:String(n)})),this.updateLiveRegion(t)}},g.prototype.updateLiveRegion=function(e){t(this._liveRegion).text(e)},g.prototype.cancel=function(){this.closeDropdown()},g.prototype.handleDataProviderEvent=function(e){this._lastSearchTerm=null},g.prototype._fetchFromDataProvider=function(t){var i=!1,n=this._addBusyStateFunc("fetching data");"init"===this._fetchType&&(i=!0,this.isDropdownOpen()||this._lovMainField.setUiLoadingState("start"),this._fetchType=null);var r=null;if(t){if(this._dataProvider){var a=this._dataProvider.getCapability("filter");a&&a.textFilter||o.error("Select: DataProvider does not support text filter.  Filtering results in dropdown may not work correctly.")}r=e.FilterFactory.getFilter({filterDef:{text:t}})}return new Promise(function(e){var a=this._lovDropdown.renderResults(t,r,_.isValueForPlaceholder(this._value)?null:this._value),s=function(){i&&this._lovMainField.setUiLoadingState("stop"),n(),e()}.bind(this);a.then(function(){s()},function(e){o.warn("Select: renderResults promise was rejected: "+e),s()})}.bind(this))},e.__registerWidget("oj.ojSelect2",t.oj.editableValue,{defaultElement:"<input>",widgetEventPrefix:"oj",_ALLOWED_INPUT_TYPES:["email","number","search","tel","text","url"],options:{placeholder:"",data:null,required:!1,virtualKeyboard:"search",readOnly:!1,valueItem:{key:null,data:null,metadata:null},itemText:"label",labelledBy:null},widget:function(){return t(this.OuterWrapper)},_ComponentCreate:function(){this._super(),this._cssOptionDefaults=a.parseJSONFromFontFamily("oj-searchselect-option-defaults")||{},this._fullScreenPopup="phone"===n.getDeviceRenderMode(),this._valueForPlaceholder=null,this._valueItemForPlaceholder={key:null,data:null,metadata:null},this._setupSelectResources()},_AfterCreate:function(){this._super(),e.EditableValueUtils._setInputId(this._GetContentElement()[0],this.OuterWrapper.id,this.options.labelledBy);var t=this._getRootElement();this._focusable({element:t,applyHighlight:!1,afterToggle:this._handleAfterFocusToggle.bind(this,t)})},_IsTextFieldComponent:function(){return!0},_GetContentWrapper:function(){return this._lovMainField.getElement().querySelector(".oj-text-field-middle")},_handleAfterFocusToggle:function(e,t){"focusout"===t&&this._abstractLovBase.isDropdownOpen()&&e.classList.add("oj-focus")},_IsRequired:function(){return this.options.required},_labelledByChangedForInputComp:e.EditableValueUtils._labelledByChangedForInputComp,_AfterSetOptionRequired:e.EditableValueUtils._AfterSetOptionRequired,_GetTranslationsSectionName:function(){return"oj-ojSelectSingle"},_getTemplateSlot:function(t){var i=e.BaseCustomElementBridge.getSlotMap(this.OuterWrapper)[t];return i&&i[0]&&"TEMPLATE"===i[0].tagName?i[0]:null},_setupSelectResources:function(){var e=this.options;this._wrapDataProviderIfNeeded(e.data),this._addDataProviderEventListeners(),this._SetInputType(this._ALLOWED_INPUT_TYPES);var i=this.OuterWrapper,n=this,r=function(){return n.getTranslatedString.apply(n,arguments)},o=function(e){return _.addBusyState(i,e)},a=i.getAttribute("id");a||(a="oj-selectsingle-"+_.nextUid(),i.setAttribute("id",a));var s=a;this._idSuffix=a;var l=!e.disabled;this._lovEnabled=l;var d=e.readOnly||!1,u=this.element;u.prop("disabled",!(l&&!d));var c=this._cssOptionDefaults.showIndicatorDelay;c=parseInt(c,10),c=isNaN(c)?250:c;var h=u.attr("type");this._resolveValueItemLater=!1;var p="oj-searchselect";this._className=p,this._initContainer(p,s,d);var v=new m({className:p,ariaLabel:i.getAttribute("aria-label"),ariaControls:i.getAttribute("aria-controls"),showIndicatorDelay:c,idSuffix:s,inputType:h,enabled:l,readOnly:d,placeholder:e.placeholder,getTranslatedStringFunc:r,addBusyStateFunc:o,forceReadOnly:this._fullScreenPopup,setLoadingFunc:this._SetLoading.bind(this),clearLoadingFunc:this._ClearLoading.bind(this)});this._lovMainField=v,this._initLovMainField(v);var f=v.getElement();i.appendChild(f);var y=this._createFilterInputText(p,s);this._fullScreenPopup||(y.style.visibility="hidden"),this._filterInputText=y,i.appendChild(y);var b=function(e){this._fullScreenPopup&&y.setAttribute("aria-controls",e.id)}.bind(this),E=this._createLovDropdown(s,h,a,r,o,b);this._lovDropdown=E;var w=E.getElement();i.appendChild(w),w.addEventListener("lovDropdownEvent",this._handleLovDropdownEvent.bind(this)),t(v.getInputElem()).attr("aria-owns",w.id);var S=new g({className:p,dataProvider:this._wrappedDataProvider,containerElem:i,fullScreenPopup:this._fullScreenPopup,idSuffix:s,lovMainField:v,filterInputText:y,lovDropdown:E,liveRegion:this._liveRegion,enabled:l,readOnly:d,value:e.value,getTranslatedStringFunc:r,addBusyStateFunc:o,showMainFieldFunc:this._showMainField.bind(this),setFilterFieldTextFunc:this._setFilterFieldText.bind(this)});this._abstractLovBase=S,u.attr("tabindex","-1").hide().attr("aria-hidden",!0),S.hasData()&&this._initSelectedValue(e.valueItem),this._refreshRequired(e.required),this._resolveValueItemLater=this._mergeValueAndValueItem(e.value,e.valueItem),this._updateLabel()},_releaseSelectResources:function(){t(this._filterInputText).remove(),t(this._lovMainField.getElement()).remove(),t(this._liveRegion).remove(),this._abstractLovBase.destroy(),t(this._lovDropdown.getElement()).remove(),this._lovDropdown.destroy();var e=this.OuterWrapper,i=e.classList;i.remove(this._className),i.remove("oj-form-control"),i.remove("oj-component"),i.remove("oj-read-only"),i.remove("oj-enabled"),i.remove("oj-disabled"),t(e).off("change","."+this._className+"-input",_.stopEventPropagation).off(this._containerEventListeners),this._containerEventListeners=null,this.element.removeAttr("aria-hidden tabindex").show();var n=this._$labelElem;n.attr("for",n.attr("data-oj-lov-for")),n.removeAttr("data-oj-lov-for"),this._$labelElem=null,this._removeDataProviderEventListeners(),this._wrappedDataProvider=null,this._liveRegion=null,this._abstractLovBase=null,this._lovMainField=null,this._filterInputText=null,this._lovDropdown=null},_updateLabel:function(){var e=this._GetLabelElement()||t();this._$labelElem=e;var i,n=this.options;e.length>0?(e.attr("id")||e.attr("id",this._className+"-label-"+this._idSuffix),e.attr("data-oj-lov-for",e.attr("for")),i=e.attr("id")):n.labelledBy&&(i=n.labelledBy);var r,o=this._lovMainField;if(o.updateLabel(i),e.length>0){var a=t(o.getInputElem());e.attr("for",a.attr("id"))}if(i&&this._filterInputText.setAttribute("labelled-by",i),e.length>0)i||(r=e.text());else{var s=this.element.attr("aria-label");s&&(r=s)}this._lovDropdown.updateLabel(i,r)},_initContainer:function(e,i,n){var r=this.OuterWrapper,o=t(r),a=r.classList;a.add(e),a.add("oj-form-control"),a.add("oj-component"),n?a.add("oj-read-only"):a.add(this._lovEnabled?"oj-enabled":"oj-disabled");var s=document.createElement("div");s.setAttribute("id","oj-listbox-live-"+i),s.setAttribute("role","region"),s.setAttribute("class","oj-helper-hidden-accessible oj-listbox-liveregion"),s.setAttribute("aria-live","polite"),r.appendChild(s),o.on("change","."+e+"-input",_.stopEventPropagation),this._containerEventListeners={click:_.killEvent,keyup:function(e){10!==e.keyCode&&13!==e.keyCode||o.removeClass("oj-focus")},keydown:this._handleContainerKeyDown.bind(this),mousedown:this._handleContainerMouseDown.bind(this),mouseup:function(){o.removeClass("oj-active")}},o.on(this._containerEventListeners),this._liveRegion=s},_setFilterFieldText:function(e){this._ignoreFilterFieldRawValueChanged=!0,this._filterInputText.value=e,this._ignoreFilterFieldRawValueChanged=!1},_showFilterField:function(i){if(!this._fullScreenPopup){var n=this._filterInputText;if("hidden"===n.style.visibility){var r=this._lovMainField,o=r.getInputElem();i||(this._setFilterFieldText(o.value),_.copyAttribute(o,"aria-describedby",n,"described-by"));var a=t(n).find("input");if(a.length>0){var s=a[0];s.setAttribute("role","combobox"),i||(_.copyAttribute(o,"aria-required",s,"aria-required"),_.copyAttribute(o,"aria-invalid",s,"aria-invalid"))}r.getInputElem().style.visibility="hidden",n.style.visibility="",n.style.top=r.getElement().offsetTop+"px",this.OuterWrapper.appendChild(n)}if(!i)if(e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.IE){var l=_.addBusyState(this.OuterWrapper,"Select transferring focus to filter field");setTimeout(function(){n.focus(),l()},0)}else n.focus()}},_showMainField:function(){if(!this._fullScreenPopup){var e=this._filterInputText;"hidden"!==e.style.visibility&&(this._lovMainField.getInputElem().style.visibility="",e.style.visibility="hidden")}},_handleContainerKeyDown:function(t){if(this._lovEnabled&&!_.isControlOrFunctionKey(t))if(t.which!==_.KEYS.PAGE_UP&&t.which!==_.KEYS.PAGE_DOWN){var i=this._abstractLovBase,n=this._lovDropdown;switch(t.which){case _.KEYS.UP:case _.KEYS.DOWN:if(i.isDropdownOpen())if(e.FocusUtils.focusFirstTabStop(n.getElement()),e.AgentUtils.getAgentInfo().browser===e.AgentUtils.BROWSER.IE){var r=_.addBusyState(this.OuterWrapper,"Select showing filter field while arrowing into dropdown");setTimeout(function(){this._showFilterField(!0),r()}.bind(this),0)}else this._showFilterField(!0);else i.openDropdown();t.preventDefault();break;case _.KEYS.ENTER:t.preventDefault();break;case _.KEYS.TAB:if(i.closeDropdown(),!this._fullScreenPopup&&t.shiftKey)for(var o=this._filterInputText,a=o.parentNode;a.firstChild!==o;)a.appendChild(a.firstChild);break;case _.KEYS.ESC:i.isDropdownOpen()&&(i.cancel(),t.preventDefault())}}else t.preventDefault()},_handleContainerMouseDown:function(i){var n=this._abstractLovBase;this._lovEnabled||i.preventDefault();var r=this.OuterWrapper,o=r.querySelector(".oj-messaging-inline-container");if(!o||!e.DomUtils.isAncestorOrSelf(o,i.target)){var a=t(r),s=!1;if(r.classList.contains("oj-form-control-label-top")){var l=a.children(".oj-label");l.length>0&&e.DomUtils.isAncestorOrSelf(l[0],i.target)&&(s=!0)}var d=0===i.button;d&&(n.isDropdownOpen()?n.closeDropdown():this._lovEnabled&&!s&&(n.openDropdown(),this._fullScreenPopup&&i.preventDefault())),s||(a.addClass("oj-active"),d&&(i.preventDefault(),!this._fullScreenPopup&&this._lovEnabled&&("hidden"===this._filterInputText.style.visibility?this._lovMainField.getInputElem().focus():this._showFilterField())))}},_handleLovDropdownEvent:function(t){var i=t.detail,n=this._abstractLovBase;switch(i.subtype){case"cancelDropdown":n.cancel();break;case"closeDropdown":"escKeyDown"===i.trigger?this._filterInputText.focus():"clickAway"===i.trigger&&(e.DomUtils.isAncestor(this._lovDropdown.getElement(),document.activeElement)&&this._showMainField(),this.OuterWrapper.classList.remove("oj-focus")),n.closeDropdown();break;case"sizeDropdown":n.sizeDropdown();break;case"adjustDropdownPosition":n.adjustDropdownPosition(i.popupElem);break;case"openPopup":var r=i.psOptions;r[e.PopupService.OPTION.LAUNCHER]=this.element,r[e.PopupService.OPTION.POSITION]=n.getDropdownPosition(),e.PopupService.getInstance().open(r);break;case"handleSelection":this._handleSelection(i.valueItem,i.selectionOptions,i.event);break;case"dropdownClosed":this._searchTextOnKeyDown=void 0}},_handleSelection:function(e,t,i){var n,r=this._abstractLovBase;t&&t.trigger&&(n={optionMetadata:{trigger:t.trigger}});var o=_.isValueItemForPlaceholder(e)?this._valueItemForPlaceholder:e;if(this._handleUserSelectedValueItem(o,i,n),!i||"blur"!==i.type){var a=this._lovMainField.getInputElem();this._fullScreenPopup?a.focus():(this._setFilterFieldText(a.value),this._showFilterField())}r.closeDropdown()},_handleUserSelectedValueItem:function(e,t,i){var n=this._abstractLovBase;this._cachedFetchByKeys&&(this._valueHasChanged=!0,this._lovMainField.setUiLoadingState("stop")),_.isValueItemForPlaceholder(e)?this._setValueItem(this._valueItemForPlaceholder):this._resolveValueItemLater=!0;var r=null;_.isValueItemForPlaceholder(e)||(r=e.key),n.setValue(r),this._userSelectedValueItem=e;var o=this._SetValue(r,t,{doValueChangeCheck:!1,_context:i}),a=function(){this._userSelectedValueItem=null}.bind(this);o instanceof Promise?o.then(a,a):a()},_initLovMainField:function(e){t(e.getInputElem()).on({focus:function(e){_.killEvent(e),this._fullScreenPopup||this.options.readOnly||this._showFilterField()}.bind(this)})},_createFilterInputText:function(i,n){var r=this.OuterWrapper.getAttribute("aria-label"),o=this.OuterWrapper.getAttribute("aria-controls"),a=this.options,s=document.createElement("oj-input-text");if(s.setAttribute("id",i+"-filter-"+n),s.setAttribute("class",i+"-filter"),s.setAttribute("clear-icon",this._fullScreenPopup?"always":"never"),s.setAttribute("autocomplete","off"),s.setAttribute("aria-autocomplete","list"),s.setAttribute("data-oj-internal",""),s.setAttribute("data-oj-binding-provider","none"),a.placeholder&&s.setAttribute("placeholder",a.placeholder),r&&s.setAttribute("aria-label",r),!this._fullScreenPopup&&o&&s.setAttribute("aria-controls",o),s.setAttribute("virtual-keyboard",a.virtualKeyboard),this._fullScreenPopup){var l=document.createElement("span");l.setAttribute("slot","start"),l.setAttribute("class",i+"-filter-indicator"),s.appendChild(l);var d=document.createElement("span");d.setAttribute("class",i+"-filter-indicator-icon "+i+"-icon oj-component-icon oj-clickable-icon-nocontext"),l.appendChild(d)}else{var u=document.createElement("a");u.setAttribute("class",i+"-arrow "+i+"-open-icon "+i+"-icon oj-component-icon oj-clickable-icon-nocontext"),u.setAttribute("slot","end"),u.style.visibility="hidden",s.appendChild(u)}var c=t(this.OuterWrapper);return s.addEventListener("rawValueChanged",function(e){this._ignoreFilterFieldRawValueChanged||this._abstractLovBase.updateResults(e)}.bind(this)),s.addEventListener("focus",function(){c.addClass("oj-focus")}),s.addEventListener("blur",function(t){c.removeClass("oj-focus"),this._fullScreenPopup||t.relatedTarget&&e.DomUtils.isAncestor(this._lovDropdown.getElement(),t.relatedTarget)||this._showMainField()}.bind(this)),s},_createLovDropdown:function(e,i,n,r,o,a){return new f({dataProvider:this._wrappedDataProvider,className:"oj-select",parentId:n,idSuffix:e,fullScreenPopup:this._fullScreenPopup,inputType:i,bodyElem:t(this.OuterWrapper).closest("body")[0],itemTemplate:this._getTemplateSlot("itemTemplate"),collectionTemplate:this._getTemplateSlot("collectionTemplate"),getTemplateEngineFunc:this._loadTemplateEngine.bind(this),templateContextComponentElement:this.OuterWrapper,getTranslatedStringFunc:r,addBusyStateFunc:o,itemTextRendererFunc:this._itemTextRenderer.bind(this),filterInputText:this._filterInputText,afterDropdownInitFunc:a})},_loadTemplateEngine:function(){if(!this._templateEngine){var e=_.addBusyState(this.OuterWrapper,"Select loading template engine");return new Promise(function(t,i){n.__getTemplateEngine().then(function(i){this._templateEngine=i,t(i),e()}.bind(this),function(t){i(new Error("Error loading template engine: "+t)),e()})}.bind(this))}return Promise.resolve(this._templateEngine)},_refreshRequired:e.EditableValueUtils._refreshRequired,_AriaRequiredUnsupported:function(){return!1},refresh:function(){this._super(),this._releaseSelectResources(),this._setupSelectResources(),this._initComponentMessaging()},_SetupResources:function(){this._super(),this._bReleasedResources&&(this._bReleasedResources=!1,this._setupSelectResources())},_ReleaseResources:function(){this._super(),this._bReleasedResources=!0,this._releaseSelectResources()},_setOption:function(e,t,i){var n=this._abstractLovBase;if(this._super(e,t,i),"valueItem"===e)this._syncValueWithValueItem(t,this.options.value);else if("value"===e)n.setValue(t),_.isValueForPlaceholder(t)?this._setValueItem(this._valueItemForPlaceholder):this._updateValueItem(t),this._SetDisplayValue();else if("disabled"===e||"readOnly"===e||"placeholder"===e||"data"===e||"itemText"===e)this.refresh();else if("labelledBy"===e){if(this.options.labelledBy){var r=this._GetContentElement()[0].id;this._labelledByChangedForInputComp(this.options.labelledBy,r)}this._updateLabel()}},_AfterSetOption:function(e,t){switch(this._superApply(arguments),e){case"required":this._AfterSetOptionRequired(e);break;case"virtualKeyboard":this._SetInputType(this._ALLOWED_INPUT_TYPES),this.refresh()}},_NotifyDetached:function(){this._superApply(arguments),this._abstractLovBase.closeDropdown()},_NotifyHidden:function(){this._superApply(arguments),this._abstractLovBase.closeDropdown()},_VerifyConnectedForSetup:function(){return!0},_SetInputType:e.EditableValueUtils._SetInputType,_SetDisplayValue:function(e){this._applyValueItem(this.options.valueItem)||this._initSelectedValue(),this._resolveValueItemLater=!1},validate:function(){var e=t(this._lovMainField.getInputElem()).val(),i=this._SetValue(e,null,this._VALIDATE_METHOD_OPTIONS);return i=i instanceof Promise?i.then(function(e){return Promise.resolve(e?"valid":"invalid")}):Promise.resolve(i?"valid":"invalid")},_NotifyContextMenuGesture:function(e,t,i){var n=this._GetMessagingLauncherElement();this._OpenContextMenu(t,i,{launcher:n})},_GetContentElement:function(){return this._lovMainField?t(this._lovMainField.getInputElem()):this.element},_GetDefaultStyleClass:function(){return"oj-select"},_isDataProvider:function(t){return!(!t||!e.DataProviderFeatureChecker)&&e.DataProviderFeatureChecker.isDataProvider(t)},_isTreeDataProvider:function(t){return!(!t||!e.DataProviderFeatureChecker)&&e.DataProviderFeatureChecker.isTreeDataProvider(t)},_wrapDataProviderIfNeeded:function(e){if(this._isDataProvider(e)){var t=e;this._isTreeDataProvider(t)?t instanceof l||(t=new l(t)):t instanceof s||(t=new s(t)),t=new p(t),this._wrappedDataProvider=t}else this._wrappedDataProvider=new p},_addDataProviderEventListeners:function(){var e=this._wrappedDataProvider;if(e){this._removeDataProviderEventListeners();var t=this._handleDataProviderEvent.bind(this);this._savedDataProviderEH=t,e.addEventListener("mutate",t),e.addEventListener("refresh",t)}},_removeDataProviderEventListeners:function(){var e=this._wrappedDataProvider,t=this._savedDataProviderEH;e&&t&&(e.removeEventListener("mutate",t),e.removeEventListener("refresh",t),this._savedDataProviderEH=void 0)},_handleDataProviderEvent:function(t){if(!t.filterCriterionChanged){var i=this.options.value;if("mutate"===t.type)if(null!=t.detail.remove)t.detail.remove.keys.forEach(function(t){e.Object.compareValues(t,i)&&(i=this._valueForPlaceholder,o.warn("Select: selected value removed from data provider"))}.bind(this));this._setOption("value",i),this._abstractLovBase.handleDataProviderEvent(t)}},_mergeValueAndValueItem:function(t,i){var n=!1;return _.isValueForPlaceholder(t)?i&&this._syncValueWithValueItem(i,t):i&&(n=!e.Object.compareValues(t,i.key)),n},_syncValueWithValueItem:function(t,i){var n,r=this._abstractLovBase;if(n=_.isValueItemForPlaceholder(t)?_.isValueForPlaceholder(i)?i:this._valueForPlaceholder:t?t.key:null,!e.Object.compareValues(n,i)){var o={doValueChangeCheck:!1,_context:{internalSet:!0,writeback:!0}};this.option("value",n,o),r.setValue(n),this._AfterSetOptionValue("value",o)}},_initSelectedValue:function(e){if(!this._applyValueItem(e)){var t=e?e.key:this.options.value;this._initSelectionHelper(t,this._updateSelectedOption.bind(this))}},_applyValueItem:function(e){return!this._resolveValueItemLater&&!_.isValueItemForPlaceholder(e)&&(this._updateInputElemValue(e),!0)},_updateSelectedOption:function(e){this._updateInputElemValue(e),this._setValueItem(e)},_setValueItem:function(e){var t=e;e&&!_.isValueItemForPlaceholder(e)&&(t=_.createValueItem(e.key,e.data,e.metadata));this.option("valueItem",t,{_context:{internalSet:!0,changed:!0,writeback:!0}})},_updateValueItem:function(e){this._initSelectionHelper(e,function(e){this._setValueItem(e),this._updateSelectedOption(e)}.bind(this))},_updateInputElemValue:function(e){var i=t(this._lovMainField.getInputElem());this._selectedValueItem=e;var n=null;if(e&&e.data){var r=this._itemTextRenderer(e),o=i.val();void 0!==r&&o!==r&&(n=r)}else n="";null!==n&&i.val(n)},_itemTextRenderer:function(e){var t;if(e&&e.data){var i=this.options.itemText;t="string"==typeof i?e.data[i]:i(e)}return t},_initSelectionHelper:function(e,t){if(_.isValueForPlaceholder(e))t(this._valueItemForPlaceholder);else if(this._abstractLovBase.hasData())if(this._userSelectedValueItem){var i=this._userSelectedValueItem;this._initSelectionFetchByKey({data:[i.data],metadata:[i.metadata]},e,t)}else this._fetchByKeysFromDataProvider([e]).then(function(i){this._initSelectionFetchByKey(i,e,t)}.bind(this),function(){this._initSelectionFetchByKey(null,e,t)}.bind(this))},_initSelectionFetchByKey:function(t,i,n){if(e.Object.compareValues(i,this.options.value)&&!this._valueHasChanged){var r=null,a=null;t&&t.data&&t.data.length>0?(r=t.data[0],a=t.metadata[0]):o.warn("SelectSingle: could not fetch data for selected value: "+i),n(_.createValueItem(i,r,a)),this._valueHasChanged=void 0}},_fetchByKeysFromDataProvider:function(t){var i;if(this._cachedFetchByKeys&&this._cachedFetchByKeys.promise&&e.Object.compareValues(t,this._cachedFetchByKeys.key))i=this._cachedFetchByKeys.promise;else{var n=_.addBusyState(this.OuterWrapper,"fetching selected data"),r=!1;"init"===this._abstractLovBase.getFetchType()&&(r=!0,this._abstractLovBase.isDropdownOpen()||this._lovMainField.setUiLoadingState("start")),i=new Promise(function(e,i){this._wrappedDataProvider.fetchByKeys({keys:new Set(t)}).then(function(t){var i=[],n=[];t.results.forEach(function(e){i.push(e.data),n.push(e.metadata)}),e({data:i,metadata:n})},function(e){i(e)})}.bind(this)),this._cachedFetchByKeys={key:t,promise:i};var a=function(){this._cachedFetchByKeys=void 0,r&&this._lovMainField.setUiLoadingState("stop"),n()}.bind(this);i.then(function(){a()},function(e){o.warn("Select: fetchByKeys promise was rejected: "+e),a()})}return i}}),i.setDefaultOptions({ojSelect2:{displayOptions:{converterHint:["none"]}}}),h.extension._WIDGET_NAME="ojSelect2",h.extension._INNER_ELEM="input",h.extension._ALIASED_PROPS={readonly:"readOnly"},e.CustomElementBridge.register("oj-select-single",{metadata:h})});