/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","require","ojs/ojcontext","ojs/ojconfig","ojs/ojcomponentcore","ojs/ojlogger","ojs/ojdatacollection-common","ojs/ojdomscroller"],function(t,e,i,n,o,r,s,a){"use strict";var l=function(t,e,i){this.m_root=e,this.m_widget=t,this.m_fetching=!1,this.setDataProvider(i),this.Init()};t.Object.createSubclass(l,t.Object,"DataProviderContentHandler"),l.prototype.Init=function(){l.superclass.Init.call(this)},l.prototype.notifyShown=function(){},l.prototype.notifyAttached=function(){},l.prototype.cleanItems=function(t,e){if(void 0===t&&(t=this.getTemplateEngine()),void 0===e&&(e=this.m_root),t&&e)for(var i=e.childNodes,n=0;n<i.length;n++)t.clean(i[n])},l.prototype.Destroy=function(t){null!=this.m_superRoot&&(this.m_root=this.m_superRoot),this.cleanItems(),t&&e(this.m_root).empty(),this.m_widget=null,this.m_root=null,this.m_superRoot=null},l.prototype.IsReady=function(){return!this.m_fetching},l.prototype.setRootAriaProperties=function(){this.shouldUseGridRole()?this.m_root.setAttribute("role","grid"):this.IsHierarchical()?this.m_root.setAttribute("role","tree"):this.m_root.setAttribute("role","listbox")},l.prototype.RenderContent=function(){this.signalTaskStart("rendering content"),this.setRootAriaProperties(),this.fetchRows(!1),this.signalTaskEnd()},l.prototype.GetKey=function(t){return t.key},l.prototype.FindElementByKey=function(i){for(var n=e(this.m_root).find("."+this.m_widget.getItemElementStyleClass()),o=0;o<n.length;o++){var r=n[o];if(i==this.GetKey(r)||t.Object.compareValues(i,this.GetKey(r)))return r}return null},l.prototype.getDataProvider=function(){return this.m_dataProvider},l.prototype.setDataProvider=function(t){this._removeDataSourceEventListeners(),null!=t&&(this.m_handleModelMutateEventListener=this.handleModelMutateEvent.bind(this),this.m_handleModelRefreshEventListener=this.handleModelRefreshEvent.bind(this),t.addEventListener("mutate",this.m_handleModelMutateEventListener),t.addEventListener("refresh",this.m_handleModelRefreshEventListener)),this.m_dataProvider=t},l.prototype._removeDataSourceEventListeners=function(){var e=this.getDataProvider();null!=e&&(e.removeEventListener("mutate",this.m_handleModelMutateEventListener),e.removeEventListener("refresh",this.m_handleModelRefreshEventListener),t.TableDataSourceAdapter&&e instanceof t.TableDataSourceAdapter&&e.destroy())},l.prototype.loadTemplateEngine=function(){var t=this;return null!=this.m_widget.getItemTemplate()&&null==this.m_widget._getItemRenderer()?new Promise(function(e){o.__getTemplateEngine().then(function(i){t.m_engine=i,e(i)},function(t){throw new Error("Error loading template engine: "+t)})}):Promise.resolve(null)},l.prototype.getTemplateEngine=function(){return this.m_engine},l.prototype.fetchRows=function(t){this.m_widget.showStatusText()},l.prototype.GetChildElementTagName=function(){return"LI"},l.prototype.GetReferenceNode=function(t,i){if(-1===i)return null;var n=e(t).children("."+this.m_widget.getItemElementStyleClass()+", ."+this.m_widget.getEmptyTextStyleClass()+", .oj-listview-temp-item");return i===n.length?null:n[i]},l.prototype.addItem=function(t,i,n,o,r,s){var a=document.createElement(this.GetChildElementTagName());e(a).uniqueId();var l=this.GetReferenceNode(t,i);this.m_widget.BeforeInsertItem&&this.m_widget.BeforeInsertItem(),t.insertBefore(a,l);var d=e(t).children().index(a);return this._addOrReplaceItem(a,d,t,i,n,o,r,s,!1)},l.prototype.replaceItem=function(t,i,n,o,r,s,a){this.signalTaskStart("replace item");var l=t.parentNode,d=e(l).children().index(t),h=document.createElement(this.GetChildElementTagName());r&&r.clean(t),e(t).replaceWith(h),this._addOrReplaceItem(h,d,l,i,n,o,r,s,a)},l.prototype._addOrReplaceItem=function(t,i,n,o,r,s,a,l,d){null==l&&(l=this.afterRenderItem.bind(this));var h,m=this.createContext(i,r,s,t),c=this.m_widget._getItemRenderer(),u=this.m_widget.getItemTemplate(),g=!1;if(null!=c){var p=c.call(this,m);null!=p&&(null===p.parentNode||p.parentNode instanceof DocumentFragment?t.appendChild(p):null!=p.parentNode||p.toString&&((h=document.createElement("span")).appendChild(document.createTextNode(p.toString())),t.appendChild(h)))}else if(null!=u&&null!=a)for(var _=this.m_widget.GetRootElement()[0],f=this.GetBindingContext(m),v=this.m_widget.getAs?this.m_widget.getAs():null,y=a.execute(_,u,f,v),w=this.GetChildElementTagName(),S=0;S<y.length;S++){if(y[S].tagName===w){n.replaceChild(y[S],t),g=!0;break}t.appendChild(y[S])}else(h=document.createElement("span")).appendChild(document.createTextNode(null==r?"":r.toString())),t.appendChild(h);var k=n.children?n.children[i]:this._getItemFromDocumentFragment(n,i);return m.parentElement=k,e.data(k,"data",r),l(k,m,g,d),{item:k,context:m}},l.prototype._getItemFromDocumentFragment=function(t,e){for(var i=0,n=t.childNodes,o=0;o<n.length;o++){var r=n[o];if(!r)break;if(1===r.nodeType){if(i===e)return r;i+=1}}return null},l.prototype.GetBindingContext=function(t){var e={};return e.data=t.data,e.index=t.index,e.key=t.key,e.componentElement=t.componentElement,e},l.prototype.afterRenderItem=function(t,i){t.key=i.key;var n=e(t);n.uniqueId();var o=this.m_widget.getSingleFocusableElement(n);if(this.shouldUseGridRole())if(null==i.leaf||i.leaf)if(this.isCardLayout())o.attr("role","gridcell");else if(n.attr("role","row"),o!==n)o.attr("role","gridcell");else{if(0===o.children().length)o.get(0).innerHTML="<div role='gridcell' class='oj-listview-cell-element'></div>";else{var r=document.createElement("div");for(r.setAttribute("role","gridcell"),r.className="oj-listview-cell-element";o[0].firstChild;)r.appendChild(o[0].firstChild);o[0].appendChild(r)}}else n.attr("role","presentation");else o.attr("role",this.IsHierarchical()?"treeitem":"option"),o!==n&&n.attr("role","presentation");o.addClass(this.m_widget.getFocusedElementStyleClass()),this.isFocusable(i)||n.addClass("oj-skipfocus"),n.addClass(this.m_widget.getItemElementStyleClass())},l.prototype.getMetadata=function(t,e,i,n){var o=i.context;return null==o&&(o={}),null==o.index&&(o.index=t),null==o.key&&(o.key=e),o},l.prototype.handleModelMutateEvent=function(t){null!=this.m_root&&this.m_widget.isAvailable()&&(null!=t.detail.remove&&this.handleModelRemoveEvent(t),null!=t.detail.add&&this.handleModelAddEvent(t),null!=t.detail.update&&this.handleModelChangeEvent(t))},l.prototype.handleModelRefreshEvent=function(t){},l.prototype._pushToEventQueue=function(t){null==this.m_eventQueue&&(this.m_eventQueue=[]),this.m_eventQueue.push(t)},l.prototype._processEventQueue=function(){var t;if(null!=this.m_eventQueue&&this.m_eventQueue.length>0){for(var e=0;e<this.m_eventQueue.length;e++)if("refresh"===(t=this.m_eventQueue[e]).type)return void this.handleModelRefreshEvent(t.event);"mutate"===(t=this.m_eventQueue.shift()).type&&this.handleModelMutateEvent(t.event)}},l.prototype._clearEventQueue=function(){null!=this.m_eventQueue&&(this.m_eventQueue.length=0)},l.prototype.addItemsForModelInsert=function(t,e,i,n,o){},l.prototype.handleModelAddEvent=function(t){if(this.IsReady()){this.signalTaskStart("handling model add event"),this.m_superRoot&&0===this.m_root.childNodes.length&&this.m_superRoot.appendChild(this.m_root.parentNode);var e,i,n=t.detail.add,o=n.data,r=[];n.keys.forEach(function(t){r.push(t)});var s=!0;void 0!==n.addBeforeKeys?i=n.addBeforeKeys:void 0!==n.afterKeys&&(i=n.afterKeys,s=!1),i&&(e=[],i.forEach(function(t){e.push(t)}));var a=n.parentKeys,l=n.indexes;null!=o&&null!=r&&r.length>0&&o.length>0&&r.length===o.length&&(null==l||l.length===o.length)&&this.addItemsForModelInsert(o,l,r,a,s,e),this.signalTaskEnd()}else this._pushToEventQueue({type:t.type,event:t})},l.prototype.afterRenderItemForInsertEvent=function(t,i,o){this.signalTaskStart("after render item from model insert event"),t.setAttribute("data-oj-context",""),this.afterRenderItem(t,i,o);var r=e(t),s=t.className;t.className="oj-listview-temp-item oj-listview-item-add-remove-transition",this.shouldUseGridRole()||r.children().wrapAll("<div></div>");var a=r.children().first();a[0].className=s,a[0].key=t.key,this.shouldUseGridRole()||(a.attr("role",t.getAttribute("role")),r[0].hasAttribute("aria-selected")&&a.attr("aria-selected",t.getAttribute("aria-selected")));var l=this;n.getContext(t).getBusyContext().whenReady().then(function(){null!=l.m_widget&&(l.signalTaskStart("kick off animation for insert item"),l.m_widget.StartAnimation(t,"add").then(function(){t.removeAttribute("data-oj-context"),l._handleAddTransitionEnd(i,t)}),l.signalTaskEnd())})},l.prototype._handleAddTransitionEnd=function(t,i){if(null!=this.m_widget&&null!=i.parentNode){var n=i.classList.contains("oj-focus")&&i.classList.contains("oj-focus-highlight"),o=i.children[0].className;i.className=o,n&&(i.classList.add("oj-focus"),i.classList.add("oj-focus-highlight")),this.shouldUseGridRole()?i.children[0].className="oj-listview-cell-element":e(i).children().children().unwrap(),this.m_widget.itemInsertComplete(i,t),this.signalTaskEnd()}else this.signalTaskEnd()},l.prototype.handleModelRemoveEvent=function(t){var e=this,i=t.detail.remove.keys;if(null!=i&&0!==i.size)if(this.IsReady()){if(this.signalTaskStart("handling model remove event"),i.forEach(function(t){var i=e.FindElementByKey(t);null!=i&&(e.signalTaskStart("handling model remove event for item: "+t),i.parentNode.classList.contains("oj-listview-temp-item")&&(i=i.parentNode),e._removeItem(i),e.signalTaskEnd())}),this.isSelectionEnabled()){var n=this.m_widget.options.selected,o=n.delete(i);if(n!==o){var r=[];o.values&&o.values().forEach(function(t){r.push(e.FindElementByKey(t))}),this.m_widget._setSelectionOption(o,null,r)}}this.m_widget.ClearCache(),this.signalTaskEnd()}else this._pushToEventQueue({type:t.type,event:t})},l.prototype._removeItem=function(t){var i=this;this.signalTaskStart("removing an item");var n=document.activeElement,o=t.contains(n),r=e(t).get(0),s=r.className;e(r).children().wrapAll("<div class='"+s+"'></div>"),r.className="oj-listview-item-add-remove-transition",r.children[0].key=t.key,this.signalTaskStart("kick off animation to remove an item"),this.m_widget.StartAnimation(r,"remove").then(function(){i.handleRemoveTransitionEnd(t,o)}),this.signalTaskEnd()},l.prototype.handleRemoveTransitionEnd=function(t,i){if(null!=this.m_widget){var n=e(t),o=n.parent();if(0!==o.length){this.m_widget.itemRemoveComplete(n.get(0),i);var r=this.getTemplateEngine();r&&r.clean(n.get(0)),n.remove(),0===o.get(0).childElementCount&&this.m_widget.renderComplete(),this.isSelectionEnabled()&&this.m_widget.enforceSelectionRequired(),i&&this.m_root.focus(),this.signalTaskEnd()}else this.signalTaskEnd()}else this.signalTaskEnd()},l.prototype.handleModelChangeEvent=function(t){this.signalTaskStart("handling model update event");var e=t.detail.update,i=e.data,n=[];e.keys.forEach(function(t){n.push(t)});for(var o,r=this.getTemplateEngine(),s=e.indexes,a=0;a<n.length;a++){var l=this.FindElementByKey(n[a]);if(null!=l){void 0===o&&l.contains(document.activeElement)&&(o=l),this.signalTaskStart("handling model update event for item: "+n[a]);var d=null==s?-1:s[a];this.replaceItem(l,d,i[a],this.getMetadata(d,n[a],i[a],l.parentNode),r,this.afterRenderItemForChangeEvent.bind(this),null!=o),this.signalTaskEnd(),null!=o&&(o=null)}}this.m_widget.ClearCache(),this.signalTaskEnd()},l.prototype.afterRenderItemForChangeEvent=function(t,e,i,n){var o=this;this.signalTaskStart("after render item for model change event"),this.afterRenderItem(t,e),this.m_widget.StartAnimation(t,"update").then(function(){o._handleReplaceTransitionEnd(t,n)}),this.signalTaskEnd()},l.prototype._handleReplaceTransitionEnd=function(t,i){null!=this.m_widget?(e(t).removeClass("oj-listview-item-add-remove-transition"),i&&this.m_widget.restoreCurrentItemFocus(t),this.signalTaskEnd()):this.signalTaskEnd()},l.prototype.createContext=function(t,e,i,n){var o={};o.parentElement=n,o.index=t,o.data=e,o.component=this.m_widget.getWidgetConstructor(),o.datasource=this.getDataProvider(),o=this.m_widget._FixRendererContext(o);for(var r=Object.keys(i),s=0;s<r.length;s++){var a=r[s];o[a]=i[a]}return o},l.prototype.isSelectionEnabled=function(){return this.m_widget._isSelectionEnabled()},l.prototype.isFocusable=function(t){return this.m_widget.getItemFocusable(t)},l.prototype.isSelectable=function(t){return this.m_widget.getItemSelectable(t)},l.prototype.isCardLayout=function(){return this.m_widget.isCardLayout()},l.prototype.shouldUseGridRole=function(){return this.m_widget.ShouldUseGridRole()},l.prototype.isAsyncRendering=function(){return!1},l.prototype.signalTaskStart=function(t){this.m_widget&&this.m_widget.signalTaskStart("DataSource ContentHandler "+t)},l.prototype.signalTaskEnd=function(){this.m_widget&&this.m_widget.signalTaskEnd()};var d=function t(e,i,n){t.superclass.constructor.call(this,e,i,n)};return t.Object.createSubclass(d,l,"IteratingDataProviderContentHandler"),d.prototype.Init=function(){d.superclass.Init.call(this)},d.prototype.IsHierarchical=function(){return!1},d.prototype.IsReady=function(){return!this.m_fetching&&null==this.m_idleCallback},d.prototype._destroyDomScroller=function(){null!=this.m_domScroller&&(this.m_domScroller.destroy(),this.m_domScroller=null),this._removeLoadingIndicator()},d.prototype.Destroy=function(t){d.superclass.Destroy.call(this,t),this._removeDataSourceEventListeners(),this._destroyDomScroller(),this._cancelIdleCallback(),this.m_loadingIndicator=null,this.m_viewportCheckPromise=null,this.m_checkViewportPromise=null},d.prototype._cancelIdleCallback=function(){null!=this.m_idleCallback&&(window.requestIdleCallback&&window.cancelIdleCallback?(window.cancelIdleCallback(this.m_idleCallback),window.cancelAnimationFrame(this.m_idleCallback)):window.cancelAnimationFrame(this.m_idleCallback),this.m_idleCallback=null)},d.prototype.shouldHandleResize=function(){return this._isLoadMoreOnScroll()},d.prototype.HandleResize=function(t,e){if(this._isLoadMoreOnScroll()){var i=this.m_width,n=this.m_height;this.m_height=e,this.m_width=t,this.m_colCount=void 0;var o=this.isCardLayout();if(o&&this._isSkeletonSupport()&&i!==t)if(null!=this.m_loadingIndicator)this._adjustLoadMoreSkeletons(this._getRootElementWidth(!0));else null!=this.m_root.querySelector(".oj-listview-skeleton-container")&&this.renderInitialSkeletons();(e>n||o&&t>i)&&this.checkViewport()}},d.prototype.notifyShown=function(){this._isLoadMoreOnScroll()&&this.checkViewport()},d.prototype.notifyAttached=function(){var t=this._getFetchTrigger();if(null!=t&&null!=this.m_domScroller){var e=this._getFetchTrigger();t!==e&&this.m_domScroller.setFetchTrigger(e),this.checkViewport()}},d.prototype.setRootAriaProperties=function(){d.superclass.setRootAriaProperties.call(this);var t=this;this.shouldUseGridRole()&&this._isLoadMoreOnScroll()&&this.getDataProvider().getTotalSize().then(function(e){t.m_root.setAttribute("aria-rowcount",-1===e?t._getMaxCount():e)})},d.prototype.unsetRootAriaProperties=function(){d.superclass.unsetRootAriaProperties.call(this),this.m_root.removeAttribute("aria-rowcount")},d.prototype._isLoadMoreOnScroll=function(){return this.m_widget.isLoadMoreOnScroll()},d.prototype._getFetchSize=function(){return Math.max(0,this.m_widget.options.scrollPolicyOptions.fetchSize)},d.prototype._getScroller=function(){var i=this.m_widget.options.scrollPolicyOptions.scroller;return null!=i&&e.contains(i,this.m_root)?(void 0===this._fetchTrigger&&(this._fetchTrigger=t.DomScroller.calculateOffsetTop(i,this.m_root)+this._getLoadingIndicatorHeight()),i):this.m_widget.GetRootElement()[0]},d.prototype._getFetchTrigger=function(){return void 0===this._fetchTrigger&&(this._fetchTrigger=this._getLoadingIndicatorHeight()),this._fetchTrigger},d.prototype._getLoadingIndicatorHeight=function(){var t;if(this._isSkeletonSupport())t=this._getDefaultSkeletonDimension().height;else{var i=e(document.createElement("div"));i.addClass(this.m_widget.getItemStyleClass()).css({visibility:"hidden",overflow:"hidden",position:"absolute"});var n=e(document.createElement("div"));n.addClass("oj-icon oj-listview-loading-icon"),i.append(n),e(this.m_widget.GetRootElement()).append(i),t=i.get(0).offsetHeight,i.remove()}return t},d.prototype._getMaxCount=function(){return this.m_widget.options.scrollPolicyOptions.maxCount},d.prototype._isSkeletonSupport=function(){return this.m_widget.isSkeletonSupport()},d.prototype._adjustSkeletonCardContent=function(t,e,i){t.style.width=e+"px",t.style.height=i+"px"},d.prototype._createSkeletonCard=function(){var t=document.createElement("li"),e=document.createElement("div");return t.className="oj-listview-skeleton-card",e.className="oj-listview-skeleton oj-listview-skeleton-card-content oj-animation-skeleton",t.appendChild(e),t},d.prototype._createSkeletonItem=function(){var t=document.createElement("li"),e=document.createElement("div");return t.className="oj-listview-skeleton-item",this.m_widget._isGridlinesVisible()||t.classList.add("gridline-hidden"),e.className="oj-listview-skeleton oj-listview-skeleton-single-line oj-animation-skeleton",t.appendChild(e),t},d.prototype._createSkeleton=function(t){var e;if(this.isCardLayout())if(t)void 0===this.m_defaultItemSkeleton&&(this.m_defaultItemSkeleton=this._createSkeletonCard()),e=this.m_defaultItemSkeleton;else{if(void 0===this.m_defaultLoadMoreSkeleton){var i=this._createSkeletonCard(),n=this._getCardDimension();this._adjustSkeletonCardContent(i,n.width,n.height),this.m_defaultLoadMoreSkeleton=i}e=this.m_defaultLoadMoreSkeleton}else void 0===this.m_defaultItemSkeleton&&(this.m_defaultItemSkeleton=this._createSkeletonItem()),e=this.m_defaultItemSkeleton;return e.cloneNode(!0)},d.prototype._getDefaultSkeletonDimension=function(){if(null==this.m_defaultSkeletonDim){var t=this.m_widget.GetRootElement()[0],e=this._createSkeleton(!0);e.style.display="block",e.style.visibility="hidden",t.appendChild(e);var i={width:e.offsetWidth,height:e.offsetHeight};return t.removeChild(e),i.height>0&&i.width>0&&(this.m_defaultSkeletonDim=i),i}return this.m_defaultSkeletonDim},d.prototype._getScrollbarWidth=function(){if(isNaN(this.m_scrollbarWidth)){var t=this.m_widget.GetRootElement()[0],e=document.createElement("div");t.appendChild(e),this.m_scrollbarWidth=Math.max(0,a.getDefaultScrollBarWidth(e)),t.removeChild(e)}return this.m_scrollbarWidth},d.prototype._getRootElementHeight=function(){return isNaN(this.m_height)&&(this.m_height=this.m_widget.GetRootElement()[0].offsetHeight),this.m_height},d.prototype._getRootElementWidth=function(t){return isNaN(this.m_width)&&(this.m_width=this.m_widget.GetRootElement()[0].offsetWidth),t?this.m_width-this._getScrollbarWidth():this.m_width},d.prototype.renderInitialSkeletons=function(){this.m_superRoot&&(this.m_root=this.m_superRoot,this.m_superRoot=null),e(this.m_root).empty();var t=this._getRootElementHeight(),i=0,n=this._getDefaultSkeletonDimension();if(n.width>0&&n.height>0)if(this.isCardLayout()){var o=this._getMargin(),r=this._getRootElementWidth(),s=Math.max(1,Math.floor(r/(n.width+o)));i=Math.max(1,Math.floor(t/(n.height+o)))*s}else i=Math.max(1,Math.floor(t/n.height));var a=document.createElement("li");a.setAttribute("role","presentation");var l=document.createElement("ul");l.setAttribute("role","presentation"),l.className="oj-listview-group oj-listview-skeleton-container";for(var d=0;d<i;d++)l.appendChild(this._createSkeleton(!0));a.appendChild(l),this.m_root.appendChild(a)},d.LOAD_MORE_SKELETONS_ROW_COUNT=3,d.prototype._adjustLoadMoreSkeletons=function(t){var e=this._getMargin();0!==Math.floor(t/(this._getCardDimension().width+e))-this.m_loadingIndicator.get(0).firstElementChild.childElementCount&&(this.m_loadingIndicator.get(0).parentNode.removeChild(this.m_loadingIndicator.get(0)),null!=this.m_fillerSkeletons&&this.m_fillerSkeletons.parentNode.removeChild(this.m_fillerSkeletons),this.m_loadingIndicator=null,this.m_fillerSkeletons=null,this._appendLoadingIndicator())},d.prototype._getMargin=function(){if(void 0===this.m_margin){var t=document.createElement("li");t.className=this.m_widget.getItemStyleClass(),this.m_root.appendChild(t);var e=window.getComputedStyle(t);this.m_margin=parseInt(e.marginRight,10),this.m_root.removeChild(t)}return this.m_margin},d.prototype._getCardDimension=function(){if(void 0===this.m_cardDim){var t=this.m_root.querySelector("."+this.m_widget.getItemElementStyleClass());t&&(this.m_cardDim={width:t.offsetWidth,height:t.offsetHeight})}return this.m_cardDim},d.prototype._getColCount=function(){if(void 0===this.m_colCount){var t=this._getCardDimension().width+this._getMargin();this.m_colCount=Math.max(1,Math.floor(this._getRootElementWidth()/t))}return this.m_colCount},d.prototype._renderSkeletons=function(t){var e=this.createLoadingIndicator(),i=document.createElement("ul");i.className=this.isCardLayout()?"oj-listview-skeleton-card-group":"oj-listview-group",e.appendChild(i);for(var n=0;n<t;n++)i.appendChild(this._createSkeleton(!1));return e},d.prototype._fillEmptySpaceWithSkeletons=function(){var t=this.m_root.lastElementChild,e=this._getCardDimension().width+this._getMargin(),i=this._getRootElementWidth(!0),n=Math.floor((i-t.offsetLeft-e)/e);if(n>0){var o=this._renderSkeletons(n);this.m_root.appendChild(o),this.m_fillerSkeletons=o}},d.prototype._createLoadMoreSkeletons=function(){var t;if(this.isCardLayout()){var e=this._getRootElementWidth(!0),i=this._getCardDimension(),n=void 0===i?this._getDefaultSkeletonDimension().width:i.width;t=0===n?0:Math.floor(e/(n+this._getMargin()))}else t=d.LOAD_MORE_SKELETONS_ROW_COUNT;return this._renderSkeletons(t)},d.prototype._createLoadMoreIcon=function(){var t=e(this.createLoadingIndicator());t.uniqueId().attr("role","presentation").addClass(this.m_widget.getItemStyleClass()).addClass("oj-listview-loading-icon-container");var i=e(document.createElement("div"));return i.addClass("oj-icon oj-listview-loading-icon"),t.append(i),t.get(0)},d.prototype.createLoadingIndicator=function(){return document.createElement("li")},d.prototype._appendLoadingIndicator=function(){if(null==this.m_loadingIndicator){this._isSkeletonSupport()&&this.isCardLayout()&&this._fillEmptySpaceWithSkeletons();var t=this._isSkeletonSupport()?this._createLoadMoreSkeletons():this._createLoadMoreIcon();this.m_root.appendChild(t),this.m_loadingIndicator=e(t)}},d.prototype._removeLoadingIndicator=function(){null!=this.m_loadingIndicator&&this.m_loadingIndicator.remove(),this.m_loadingIndicator=null,null!=this.m_fillerSkeletons&&this.m_fillerSkeletons.remove(),this.m_fillerSkeletons=null},d.prototype.hasMoreToFetch=function(){return null!=this.m_loadingIndicator},d.prototype.afterRenderItem=function(t,i,n){d.superclass.afterRenderItem.call(this,t,i,n),e(t).addClass(this.m_widget.getItemStyleClass()),!n&&this.m_widget.getItemLayoutStyleClass&&t.classList.add(this.m_widget.getItemLayoutStyleClass()),this.isSelectionEnabled()&&this.isSelectable(i)&&this.m_widget.getFocusItem(e(t)).attr("aria-selected",!1),this._isLoadMoreOnScroll()&&e(t).attr("aria-rowindex",i.index+1),this.m_widget.itemRenderComplete(t,i)},d.prototype._handleScrollerMaxRowCount=function(){s.error("max count reached")},d.prototype._prepareRootElement=function(){if(this.m_superRoot&&(this.m_root=this.m_superRoot,this.m_superRoot=null),e(this.m_root).empty(),this.shouldUseGridRole()&&this.isCardLayout()){var t=document.createElement("li"),i=document.createElement("ul");t.appendChild(i),e(t).attr("role","presentation").css("width","100%"),e(i).attr("role","row").addClass(this.m_widget.getGroupStyleClass()),this.m_root.appendChild(t),this.m_superRoot=this.m_root,this.m_root=i}},d.prototype._setFetching=function(t){this.m_root.setAttribute("aria-busy",t),this.m_fetching=t},d.prototype.fetchRows=function(e){var i=0;if(this.signalTaskStart("fetching rows"),this.IsReady()){var n=this;this._setFetching(!0),d.superclass.fetchRows.call(this,e);var o=this.loadTemplateEngine();this.signalTaskStart("first fetch");var r={};r.size=this._isLoadMoreOnScroll()?this._getFetchSize():-1,this.m_dataProviderAsyncIterator=this.getDataProvider().fetchFirst(r)[Symbol.asyncIterator]();var s=this.m_dataProviderAsyncIterator.next();n.fetchSize=r.size;return Promise.all([s,o]).then(function(t){return function t(e){return e[0].done||-1!==n.fetchSize||"function"==typeof n.getDataProvider().getPageCount?e:n.m_dataProviderAsyncIterator.next().then(function(i){return e[0].done=i.done,e[0].value.data=e[0].value.data.concat(i.value.data),e[0].value.metadata=e[0].value.metadata.concat(i.value.metadata),t(e)},function(t){n._handleFetchError(t),n.signalTaskEnd()})}(t)},function(t){n._handleFetchError(t),n.signalTaskEnd()}).then(function(e){if(n.m_fetching){if(null==n.m_widget)return;var o=e[0],r=e[1],s=n.getDataProvider();if(t.TableDataSourceAdapter&&s instanceof t.TableDataSourceAdapter&&(i=s.offset),0===i){if(r&&n.cleanItems(r),n._isSkeletonSupport()){var a=n.m_root.querySelector(".oj-animation-skeleton");if(null!=a)return void a.addEventListener("animationiteration",function(){if(null!=n.m_widget){var t=n.m_root.querySelector(".oj-listview-skeleton-container");t.addEventListener("animationend",function(){null!=n.m_widget&&(n._prepareRootElement(),n._handleFetchedData(o,r))}),t.classList.add("oj-animation-skeleton-fade-out")}})}n._prepareRootElement()}n._handleFetchedData(o,r)}},function(t){n._handleFetchError(t),n.signalTaskEnd()}),void this.signalTaskEnd()}this.signalTaskEnd()},d.prototype._handleFetchError=function(t){s.error(t),this._setFetching(!1),null!=this.m_widget?(this._isLoadMoreOnScroll()&&this._removeLoadingIndicator(),this.m_widget.renderComplete()):s.info("handleFetchError: widget has already been destroyed")},d.prototype._renderItemsWhenIdle=function(t,e,i,n,o){var r=this;function s(s){window.requestAnimationFrame(function(){null!=r.m_widget&&r.m_root.appendChild(s),r._renderItemsWhenIdle(t,e,i,n,o)})}0!==t.length&&0!==e.length?!o&&window.requestIdleCallback&&window.cancelIdleCallback?this.m_idleCallback=window.requestIdleCallback(function(o){for(var a=o.timeRemaining(),l=0,d=document.createDocumentFragment();a>l&&0!==t.length&&0!==e.length;){var h=t.shift(),m=e.shift();r.addItem(d,-1,h,r.getMetadata(i,m,h),n),i+=1,l=a-o.timeRemaining(),a=o.timeRemaining()}s(d)}):this.m_idleCallback=window.requestAnimationFrame(function(){var o=document.createDocumentFragment(),a=t.shift(),l=e.shift();r.addItem(o,-1,a,r.getMetadata(i,l,a),n),i+=1,s(o)}):window.requestAnimationFrame(function(){r.m_idleCallback&&(r._appendLoadingIndicator(),r.afterItemsInserted(),r.signalTaskEnd()),r.m_idleCallback=null})},d.prototype._isOverflow=function(){return this._isLoadMoreOnScroll()&&this.m_domScroller&&this.m_domScroller.isOverflow()},d.prototype._handleFetchSuccess=function(t,e,i,n,o){if(null==this.m_widget)return!0;var r=this.m_root.childElementCount;if(r>0&&!i&&this._isOverflow()&&null==this.m_widget.m_scrollPosition)return this.signalTaskStart("render items during idle time"),this._renderItemsWhenIdle(t.slice(0),e.slice(0),r,n,o),!0;for(var s=document.createDocumentFragment(),a=0;a<t.length;a++){var l=t[a];this.addItem(s,-1,l,this.getMetadata(r,e[a],l),n),r+=1}return this.m_root.appendChild(s),!1},d.prototype.handleDomScrollerFetchedData=function(t){null!=t?(this.signalTaskStart("handle results from DomScroller"),this._removeLoadingIndicator(),this.IsReady()&&this.signalTaskStart("dummy task"),this._handleFetchedData(t,this.getTemplateEngine()),t.value&&t.value.data&&this.m_widget.updateStatusFetchEnd(t.value.data.length),this.m_widget.m_scrollHeight=null,this.signalTaskEnd(),this.signalTaskEnd()):(this._removeLoadingIndicator(),this.signalTaskEnd())},d.prototype._registerDomScroller=function(){var e=this,i={fetchSize:this._getFetchSize(),fetchTrigger:this._getFetchTrigger(),maxCount:this._getMaxCount(),asyncIterator:this.m_dataProviderAsyncIterator,initialRowCount:this.m_root.childElementCount,success:function(t){e.handleDomScrollerFetchedData(t),null!=e.m_root&&null!=t.value||(e.signalTaskEnd(),null!=e.m_root&&e.m_widget.renderComplete())},error:this.signalTaskEnd.bind(this),localKeyValidator:function(t){return!!e.m_widget&&null!=e.m_widget.FindElementByKey(t)},beforeFetch:function(){return e.handleBeforeFetch(),e.m_viewportCheckPromise=null,null==e.m_idleCallback&&(e.m_widget.updateStatusFetchStart(),e.signalTaskStart("starts high-water mark scrolling"),!0)}};this.m_domScroller=new t.DomScroller(this._getScroller(),this.getDataProvider(),i)},d.prototype.handleBeforeFetch=function(){},d.prototype._clearEventQueue=function(){null!=this.m_eventQueue&&(this.m_eventQueue.length=0)},d.prototype._getIndex=function(t,i){if(null==t||0===t.length||i>=t.length)return-1;var n=t[i],o=this.FindElementByKey(n);return null!=o?e(this.m_root).children().index(o):-1},d.prototype.GetReferenceNode=function(t,e){var i=d.superclass.GetReferenceNode.call(this,t,e);return null==i&&null!=this.m_loadingIndicator?this.m_loadingIndicator.get(0):i},d.prototype._getMaxIndexForInsert=function(){var t=Number.MAX_VALUE;if(this._isLoadMoreOnScroll()&&this.hasMoreToFetch()){t=e(this.m_root).children("li."+this.m_widget.getItemElementStyleClass()).length;var i=this._getFetchSize(),n=i;this.m_widget.getMinimumCountForViewport&&(n=Math.ceil(this.m_widget.getMinimumCountForViewport()/i)*i),t=Math.max(t,n)}return t},d.prototype.addItemsForModelInsert=function(t,e,i,n,o,r){for(var s=this._getMaxIndexForInsert(),a=this.getTemplateEngine(),l=0;l<t.length;l++){var d;this.signalTaskStart("handling model add event for item: "+i[l]),null!=e?d=e[l]:(d=this._getIndex(r,l))>-1?d=o?d:d+1:this._isLoadMoreOnScroll()&&this.hasMoreToFetch()&&(d=s),d<s&&this.addItem(this.m_root,d,t[l],this.getMetadata(d,i[l],t[l]),a,this.afterRenderItemForInsertEvent.bind(this)),this.signalTaskEnd()}this.IsReady()&&this.signalTaskStart("dummy task"),this.fetchEnd()},d.prototype.handleModelRefreshEvent=function(t){null!=this.m_root&&(this._cancelIdleCallback(),this.IsReady()?(this.signalTaskStart("handling model reset event"),this._clearEventQueue(),this.m_widget.ClearCache(),this._destroyDomScroller(),this.m_widget.adjustScrollPositionValueOnRefresh&&this.m_widget.adjustScrollPositionValueOnRefresh(),this.fetchRows(!0),this.signalTaskEnd()):this._pushToEventQueue({type:t.type,event:t}))},d.prototype._handleFetchedData=function(t,e){if(null==this.m_root||null==t.value)return!1;var i=t.value.data,n=t.value.metadata.map(function(t){return t.key});if(i.length===n.length){var o=this._handleFetchSuccess(i,n,t.done||t.maxCountLimit,e,t.isMouseWheel);this._isLoadMoreOnScroll()&&(t.done||(null!=n&&0===n.length&&s.info("handleFetchedData: zero data returned while done flag is false"),o||t.maxCountLimit||(null==this.m_domScroller&&(this._registerDomScroller(),this._getRootElementHeight()),this._appendLoadingIndicator())),t.maxCountLimit&&this._handleScrollerMaxRowCount()),this.fetchEnd(o),this.disableAllTabbableElements()}return!1},d.prototype.disableAllTabbableElements=function(){var t=this.m_root.childElementCount;this.m_root.lastElementChild&&"presentation"===this.m_root.lastElementChild.getAttribute("role")&&(t-=1);var e=this;n.getContext(this.m_root).getBusyContext().whenReady().then(function(){if(null!=e.m_root)for(var i=e.m_root.children,n=t;n<i.length;n++)e.m_widget.disableAllTabbableElements(i[n])})},d.prototype.afterItemsInserted=function(){if(this.m_widget){this.m_widget.renderComplete(),this._processEventQueue();var t=this,e=this.checkViewport();e&&this._isLoadMoreOnScroll()&&e.then(function(e){if(null==e){var i=n.getContext(t.m_root).getBusyContext().whenReady();i.then(function(){null!=t.m_viewportCheckPromise&&t.checkViewport()}),t.m_viewportCheckPromise=i}})}},d.prototype.fetchEnd=function(t){this._setFetching(!1),t||this.afterItemsInserted(),this.signalTaskEnd()},d.prototype._checkHorizontalViewport=function(){if(this.isCardLayout()){for(var t,e=this.m_root.children,i=this.m_widget.getItemElementStyleClass(),n=e.length-1;n>=0;n--)if(e[n].classList.contains(i)){t=e[n];break}if(t){var o=this._getScroller(),r=o===this.m_root?this._getRootElementHeight():o.offsetHeight,s=o.scrollTop,a=t.offsetTop;if(a>s&&a<s+r)return this.m_domScroller._fetchMoreRows()}}return null},d.prototype.checkViewport=function(){var t,e=this;return this.m_checkViewportPromise?null:(this.signalTaskStart("checking viewport"),null!=this.m_domScroller&&this.IsReady()&&(null!=(t=this.m_domScroller.checkViewport())&&(this.signalTaskStart("got promise from checking viewport"),t.then(function(i){null!=e.m_widget&&(null!=i?(e.m_checkViewportPromise=null,e.handleDomScrollerFetchedData(i)):null!=(t=e._checkHorizontalViewport())?(e.signalTaskStart("got promise from checking horizontal viewport"),t.then(function(t){e.m_checkViewportPromise=null,null!=e.m_widget&&null!=t&&e.handleDomScrollerFetchedData(t),e.signalTaskEnd()},null)):e.m_checkViewportPromise=null,e.signalTaskEnd())},null)),this.m_checkViewportPromise=t),this.signalTaskEnd(),t)},{DataProviderContentHandler:l,IteratingDataProviderContentHandler:d}});