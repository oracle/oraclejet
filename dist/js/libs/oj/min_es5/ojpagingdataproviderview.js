/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojeventtarget","ojs/ojdataprovider"],function(t,e){function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function r(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}var a=function(){function e(t){i(this,e),this.dataProvider=t,this._KEY="key",this._KEYS="keys",this._STARTINDEX="startIndex",this._PAGESIZE="pageSize",this._OFFSET="offset",this._SIZE="size",this._PAGE="page",this._PAGECOUNT="pageCount",this._TOTALSIZE="totalsize",this._PREVIOUSPAGE="previousPage",this._BEFOREPAGE="beforePage",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this.AsyncIterable=function(){return function t(e,n){i(this,t),this._parent=e,this._asyncIterator=n,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(e,n,r){i(this,t),this._parent=e,this._nextFunc=n,this._params=r}return r(t,[{key:"next",value:function(){var t=this._nextFunc(this._params);return Promise.resolve(t)}}]),t}(),this.AsyncIteratorYieldResult=function(){return function t(e,n){i(this,t),this._parent=e,this.value=n,this[e._VALUE]=n,this[e._DONE]=!1}}(),this.AsyncIteratorReturnResult=function(){return function t(e,n){i(this,t),this._parent=e,this.value=n,this[e._VALUE]=n,this[e._DONE]=!0}}(),this.FetchListParameters=function(){return function t(e,n,r,a){i(this,t),this._parent=e,this.size=n,this.sortCriteria=r,this.filterCriterion=a,this[e._SIZE]=n,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=a}}(),this.FetchListResult=function(){return function t(e,n,r,a){i(this,t),this._parent=e,this.fetchParameters=n,this.data=r,this.metadata=a,this[e._FETCHPARAMETERS]=n,this[e._DATA]=r,this[e._METADATA]=a}}(),this.FetchByOffsetParameters=function(){return function t(e,n,r,a,s){i(this,t),this._parent=e,this.offset=n,this.size=r,this.sortCriteria=a,this.filterCriterion=s,this[e._SIZE]=r,this[e._SORTCRITERIA]=a,this[e._OFFSET]=n,this[e._FILTERCRITERION]=s}}(),this.FetchByOffsetResults=function(){return function t(e,n,r,a){i(this,t),this._parent=e,this.fetchParameters=n,this.results=r,this.done=a,this[e._FETCHPARAMETERS]=n,this[e._RESULTS]=r,this[e._DONE]=a}}(),this.FetchByKeysResults=function(){return function t(e,n,r){i(this,t),this._parent=e,this.fetchParameters=n,this.results=r,this[e._FETCHPARAMETERS]=n,this[e._RESULTS]=r}}(),this.ContainsKeysResults=function(){return function t(e,n,r){i(this,t),this._parent=e,this.containsParameters=n,this.results=r,this[e._CONTAINSPARAMETERS]=n,this[e._RESULTS]=r}}(),this.ItemMetadata=function(){return function t(e,n){i(this,t),this._parent=e,this.key=n,this[e._KEY]=n}}(),this.DataProviderMutationEventDetail=function(){return function t(e,n,r,a){i(this,t),this._parent=e,this.add=n,this.remove=r,this.update=a,this[e._ADD]=n,this[e._REMOVE]=r,this[e._UPDATE]=a}}(),this.DataProviderOperationEventDetail=function(){return function t(e,n,r,a,s){i(this,t),this._parent=e,this.keys=n,this.metadata=r,this.data=a,this.indexes=s,this[e._KEYS]=n,this[e._METADATA]=r,this[e._DATA]=a,this[e._INDEXES]=s}}(),this.DataProviderAddOperationEventDetail=function(){return function t(e,n,r,a,s,u,o){i(this,t),this._parent=e,this.keys=n,this.afterKeys=r,this.addBeforeKeys=a,this.metadata=s,this.data=u,this.indexes=o,this[e._KEYS]=n,this[e._AFTERKEYS]=r,this[e._ADDBEFOREKEYS]=a,this[e._METADATA]=s,this[e._DATA]=u,this[e._INDEXES]=o}}();var n=this;this._addEventListeners(t),this._currentPage=-1,this._pageSize=-1,this._pageCount=-1,this._offset=0,this._totalSize=-1,this._skipCriteriaCheck=!1,this._isInitialized=new Promise(function(t){n._resolveFunc=t}),this._isInitialDataLoaded=new Promise(function(t){n._dataResolveFunc=t}),this._hasMutated=!1,this._mustRefetch=!1,this._isFetchingForMutation=!1,this._mutationEventQueue=[],this._isMutating=null,this._mutationFunc=null,this._doRefreshEvent=!1,this._mutatingTotalSize=null,this._fetchMore=!1,this._isUnknownRowCount=!1}return r(e,[{key:"containsKeys",value:function(t){var e=this;return this._checkIfDataInitialized(function(){return e.dataProvider[e._CONTAINSKEYS](t).then(function(i){var n=i.results;if(e._isGlobal(t))return new e.ContainsKeysResults(e,t,n);var r=new Set,a=e._getCurrentPageKeys();return n.forEach(function(t){-1!=a.indexOf(t)&&r.add(t)}),new e.ContainsKeysResults(e,t,r)})})}},{key:"fetchByKeys",value:function(t){var e=this;return this._checkIfDataInitialized(function(){var i=t.keys;if(e._isGlobal(t)){if(e.dataProvider[e._FETCHBYKEYS])return e.dataProvider[e._FETCHBYKEYS](t);throw new Error("Global scope not supported for this dataprovider")}return e._fetchByOffset(new e.FetchByOffsetParameters(e,e._offset,e._pageSize,e._currentSortCriteria,e._currentFilterCriteria)).then(function(n){var r=n.results,a=new Map;return r.map(function(t){if(i.has(t[e._METADATA][e._KEY]))return t}).forEach(function(t){t&&a.set(t[e._METADATA][e._KEY],t)}),new e.FetchByKeysResults(e,t,a)})})}},{key:"fetchByOffset",value:function(t){var e=this;return this._checkIfDataInitialized(function(){var i=null!=t&&t[e._OFFSET]>0?t[e._OFFSET]:0;return t=new e.FetchByOffsetParameters(e,e._offset,e._pageSize,e._currentSortCriteria,e._currentFilterCriteria),e._fetchByOffset(t).then(function(n){var r=n.results.filter(function(t,e){return e>=i});return new e.FetchByOffsetResults(e,e._getLocalParams(t),r,n.done)})})}},{key:"fetchFirst",value:function(t){var e=this,i=null!=t?t[e._SORTCRITERIA]:null,n=null!=t?t[e._FILTERCRITERION]:null,r={};e._skipCriteriaCheck?e._skipCriteriaCheck=!1:e._isSameCriteria(i,n)||(e._currentSortCriteria=i,e._currentFilterCriteria=n,e._offset=0,0!=e._currentPage&&(r[e._PREVIOUSPAGE]=e._currentPage,e._currentPage=0,r[e._PAGE]=e._currentPage));var a=e._offset,s=e._pageSize;return new e.AsyncIterable(e,new e.AsyncIterator(e,function(){var t=new e.FetchByOffsetParameters(e,a,s,e._currentSortCriteria,e._currentFilterCriteria);return e._checkIfDataInitialized(function(){return e._fetchByOffset(t).then(function(t){var i=t.results,n=i.map(function(t){return t[e._DATA]}),s=i.map(function(t){return t[e._METADATA]});a+=s.length,null!=r[e._PAGE]&&(e.dispatchEvent(new CustomEvent(e._PAGE,{detail:r})),r={}),e._skipCriteriaCheck=!1;var u=new e.FetchByOffsetParameters(e,t.fetchParameters.offset,e._pageSize,e._currentSortCriteria);return t[e._DONE]?Promise.resolve(new e.AsyncIteratorReturnResult(e,new e.FetchListResult(e,u,n,s))):Promise.resolve(new e.AsyncIteratorYieldResult(e,new e.FetchListResult(e,u,n,s)))})})},t))}},{key:"getCapability",value:function(t){return this.dataProvider.getCapability(t)}},{key:"getTotalSize",value:function(){var t=this;return this._checkIfInitialized(function(){return new Promise(function(e){e(t._pageSize)})})}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"getPage",value:function(){return this._currentPage}},{key:"setPage",value:function(e,i){var n=this;return this._mutationBusyContext(function(){e=parseInt(e,10);var r={};r[n._PAGE]=e,r[n._PREVIOUSPAGE]=n._currentPage,n.dispatchEvent(new CustomEvent(n._BEFOREPAGE,{detail:r})),null!=i[n._PAGESIZE]&&(n._pageSize=i[n._PAGESIZE]),n._offset=parseInt(e,10)*n._pageSize,n._currentPage=e,null!=n._isInitialized&&(n._resolveFunc(!0),n._updateTotalSize());var a=new n.FetchByOffsetParameters(n,n._offset,n._pageSize,n._currentSortCriteria,n._currentFilterCriteria);return n._fetchByOffset(a).then(function(i){var a=i.results;0!==a.length?(n._endItemIndex=n._offset+a.length-1,n._skipCriteriaCheck=!0,n.dispatchEvent(new CustomEvent(n._PAGE,{detail:r})),n._updateTotalSize()):0!==n._currentPage?(n._currentPage=r[n._PREVIOUSPAGE],n._offset=n._currentPage*n._pageSize,n.dispatchEvent(new CustomEvent(n._PAGECOUNT,{detail:{previousValue:e,value:e}})),n._doRefreshEvent=!1):(n._offset=0,n._endItemIndex=0),n._doRefreshEvent?(n._hasMutated=!0,n.dispatchEvent(new t.DataProviderRefreshEvent)):(n._dataResolveFunc(!0),n._doRefreshEvent=!0)})})}},{key:"getStartItemIndex",value:function(){return this._offset}},{key:"getEndItemIndex",value:function(){return this._endItemIndex}},{key:"getPageCount",value:function(){return this._pageCount}},{key:"totalSize",value:function(){return this._totalSize}},{key:"totalSizeConfidence",value:function(){return this._totalSizeConfidence?this._totalSizeConfidence:-1===this._totalSize?"unknown":"actual"}},{key:"getGlobalIndex",value:function(t){return this._offset+t}},{key:"getLocalIndex",value:function(t){return t-this._offset}},{key:"_getLocalParams",value:function(t){return new this.FetchByOffsetParameters(this,this.getLocalIndex(t.offset),t.size,t.sortCriteria,t.filterCriterion)}},{key:"_updateTotalSize",value:function(){var t=this,e=t._totalSize,i=t._pageCount;return this._checkIfInitialized(function(){return t.dataProvider.getTotalSize().then(function(n){if(t._totalSize=n,t._pageCount=-1,-1!==t._totalSize){if(t._isUnknownRowCount&&(t._isUnknownRowCount=!1,t._totalSizeConfidence="atLeast"),t._pageCount=Math.ceil(t._totalSize/t._pageSize),t._offset>=t._totalSize){t._offset=t._totalSize-t._totalSize%t._pageSize,t._endItemIndex=t._totalSize-1;var r=Math.floor(t._totalSize/t._pageSize);if(t._currentPage!=r){var a={};a[t._PAGE]=r,a[t._PREVIOUSPAGE]=t._currentPage,t.dispatchEvent(new CustomEvent(t._PAGE,{detail:a})),t._currentPage=r}}i!=t._pageCount?t.dispatchEvent(new CustomEvent(t._PAGECOUNT,{detail:{previousValue:i,value:t._pageCount}})):e!=t._totalSize&&t.dispatchEvent(new CustomEvent(t._TOTALSIZE,{detail:{previousValue:e,value:t._totalSize}}))}return t._pageSize})})}},{key:"_mutationBusyContext",value:function(t){var e=this;return this._isMutating?e._isMutating.then(function(){return e._isMutating=null,t()}):t()}},{key:"_setupMutationBusyContext",value:function(){var t=this;this._isMutating=new Promise(function(e){t._mutationFunc=e})}},{key:"_checkIfInitialized",value:function(t){var e=this;return this._isInitialized?e._isInitialized.then(function(i){if(i&&-1!=e._currentPage)return e._isInitialized=null,t();throw e._isInitialized=null,new Error("Paging DataProvider View incorrectly initialized")}):t()}},{key:"_checkIfDataInitialized",value:function(t){var e=this;return this._isInitialDataLoaded?e._isInitialDataLoaded.then(function(i){if(i&&-1!=e._currentPage)return e._isInitialDataLoaded=null,t();throw e._isInitialDataLoaded=null,new Error("Paging DataProvider View incorrectly initialized")}):t()}},{key:"_getCurrentPageKeys",value:function(){var t=this;return this._currentResults.map(function(e){return e[t._METADATA][t._KEY]})}},{key:"_isSameParams",value:function(t){return this._currentParams[this._SIZE]===t[this._SIZE]&&this._currentParams[this._OFFSET]===t[this._OFFSET]&&this._currentParams[this._SORTCRITERIA]===t[this._SORTCRITERIA]&&this._currentParams[this._FILTERCRITERION]===t[this._FILTERCRITERION]}},{key:"_isSameCriteria",value:function(t,e){if(t){if(!this._currentSortCriteria||t[0].attribute!=this._currentSortCriteria[0].attribute||t[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(e){if(!this._currentFilterCriteria||e[0].op!=this._currentFilterCriteria[0].op||e[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}},{key:"_isGlobal",value:function(t){return null!=t.scope&&"global"===t.scope}},{key:"_getCurrentPageData",value:function(){var t=this;return t._currentParams&&t._currentParams.offset===t._offset&&t._currentParams.size===t._pageSize?t._currentResults&&!t._hasMutated?new Promise(function(e){e(new t.FetchByOffsetResults(t,t._getLocalParams(t._currentParams),t._currentResults,t._currentIsDone))}):t._fetchByOffset(t._currentParams).then(function(t){return t}):t._fetchByOffset(new t.FetchByOffsetParameters(t,t._offset,t._pageSize,t._currentSortCriteria,t._currentFilterCriteria)).then(function(t){return t})}},{key:"_fetchByOffset",value:function(t){var e=this;return this._checkIfInitialized(function(){return e._currentParams&&e._isSameParams(t)&&!e._hasMutated?new Promise(function(t){t(new e.FetchByOffsetResults(e,e._getLocalParams(e._currentParams),e._currentResults,e._currentIsDone))}):0===(t=e._cleanFetchParams(t)).size?(e._currentIsDone=!0,e._currentResults=[],e._currentParams=t,new Promise(function(i){i(new e.FetchByOffsetResults(e,e._getLocalParams(t),[],e._currentIsDone))})):e._fetchByOffsetHelper(t)})}},{key:"_fetchByOffsetHelper",value:function(t){var e=this;return e.dataProvider[e._FETCHBYOFFSET](t).then(function(i){e._currentIsDone=i.done,e._fetchMore?e._currentResults=e._currentResults.concat(i.results):(e._currentResults=i.results,e._currentParams=t),e._fetchMore=!1;var n=e._currentResults.length,r=e._offset+n;if(i.done)e._pageCount=Math.ceil(r/e._pageSize),e._totalSizeConfidence&&(e._totalSizeConfidence=null);else if(!i.done&&r>=e._totalSize&&e._totalSize>-1&&t.size===e._pageSize)e._totalSizeConfidence="atLeast",e._pageCount=e._pageCount+1;else{if(!i.done&&n<e._pageSize){e._fetchMore=!0;var a=new e.FetchByOffsetParameters(e,r,e._pageSize-n,e._currentSortCriteria,e._currentFilterCriteria);return e._fetchByOffsetHelper(a)}i.done||-1!==e._totalSize||(e._isUnknownRowCount=!0)}return(e._pageSize==e._currentResults.length||r>=e._totalSize&&e._totalSize>-1)&&(e._currentIsDone=!0),e._hasMutated=!1,new e.FetchByOffsetResults(e,e._getLocalParams(e._currentParams),e._currentResults,e._currentIsDone)}).catch(function(t){return e._hasMutated=!1,e._fetchMore=!1,e._currentIsDone=null,e._currentResults=null,e._currentParams=null,Promise.reject(t)})}},{key:"_cleanFetchParams",value:function(t){var e=t.offset;(e>=this._offset+this._pageSize||e<this._offset)&&(e=this._offset);var i=t.size;i<=0&&(i=this._pageSize),e+i>this._offset+this._pageSize&&(i=this._offset+this._pageSize-e);var n=null===this._mutatingTotalSize?this._totalSize:this._mutatingTotalSize;return n>0&&"atLeast"!==this._totalSizeConfidence&&e+i>n&&(i=n-e),new this.FetchByOffsetParameters(this,e,i,t.sortCriteria,t.filterCriterion)}},{key:"_mutationEventDataFetcher",value:function(t){var e=this;this.dataProvider.getTotalSize().then(function(i){i>0&&(e._mutatingTotalSize=i,e._offset>=i&&(e._offset=i-(i-1)%e._pageSize-1,e._endItemIndex=i-1)),e._getCurrentPageData().then(function(i){e._mustRefetch?(e._mustRefetch=!1,e._hasMutated=!0,e._mutationEventDataFetcher(t)):t(i)}).catch(function(i){if(!e._mustRefetch)return Promise.reject(i);e._mustRefetch=!1,e._hasMutated=!0,e._mutationEventDataFetcher(t)})})}},{key:"_processMutationEventsByKey",value:function(e){var i=[],n=[],r=[],a=new Set,s=[],u=[],o=[],_=new Set,h=[],c=[],f=[],l=new Set,d=this._currentResultsForMutation.map(function(t,e){return{item:t,index:e}}),E=e.results.map(function(t,e){return{item:t,index:e}}),v=d.map(function(t){return t.item.metadata.key}),S=E.map(function(t){return t.item.metadata.key}),m=d.filter(function(t){return S.indexOf(t.item.metadata.key)<0}),P=E.filter(function(t){return v.indexOf(t.item.metadata.key)<0}),p=this._mutationEventQueue.filter(function(t){return!t.detail.add&&!t.detail.remove&&t.detail.update}).map(function(t){return t.detail.update.indexes});p=(p=p.reduce(function(t,e){return t.concat(e)},[])).filter(function(t,e){return p.indexOf(t)===e});var g=d.filter(function(t){var e=S.indexOf(t.item.metadata.key);return p.indexOf(e)>-1});this._mutationEventQueue=[],P.length>0&&(P.forEach(function(t){s.push(E[t.index].item.metadata),u.push(E[t.index].item.data),o.push(t.index)}),s.map(function(t){_.add(t.key)})),m.length>0&&(m.forEach(function(t){i.push(d[t.index].item.metadata),n.push(d[t.index].item.data),r.push(t.index)}),i.map(function(t){a.add(t.key)})),g.length>0&&(g.forEach(function(t){h.push(d[t.index].item.metadata),c.push(d[t.index].item.data),f.push(t.index)}),h.map(function(t){l.add(t.key)}));var y=null,I=null,R=null;if(o.length>0&&(y=new this.DataProviderAddOperationEventDetail(this,_,null,null,s,u,o)),r.length>0&&(I=new this.DataProviderOperationEventDetail(this,a,i,n,r)),f.length>0&&(R=new this.DataProviderOperationEventDetail(this,l,h,c,f)),null!=y||null!=I||null!=R){var C=new this.DataProviderMutationEventDetail(this,y,I,R);this.dispatchEvent(new t.DataProviderMutationEvent(C))}}},{key:"_addEventListeners",value:function(e){var i=this;e.addEventListener(this._REFRESH,function(e){i._hasMutated||(i._hasMutated=!0,i._updateTotalSize().then(function(){i.setPage(0,{pageSize:i._pageSize}).then(function(){0===i._endItemIndex&&i.dispatchEvent(new t.DataProviderRefreshEvent)})}))}),e.addEventListener(this._MUTATE,function(t){i._mutationEventQueue.push(t),i._setupMutationBusyContext(),i._isFetchingForMutation?i._mustRefetch=!0:(i._isFetchingForMutation=!0,i._currentResultsForMutation=i._currentResults,i._hasMutated=!0,i._mutationEventDataFetcher(function(t){i._isFetchingForMutation=!1,i._updateTotalSize().then(function(){i._mutatingTotalSize=null,0===t.results.length?(i._mutationFunc(!0),i.setPage(i._currentPage,{pageSize:i._pageSize})):(i._processMutationEventsByKey(t),i._mutationFunc(!0))})}))})}}]),e}();return t.PagingDataProviderView=a,t.PagingDataProviderView=a,t.EventTargetMixin.applyMixin(a),a});