/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojset","ojs/ojeventtarget","ojs/ojdataprovider","ojs/ojkeyset","ojs/ojobservable","ojs/ojmap"],function(t,e,a,i,r,n,s,h){function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function d(t,e,a){return e&&o(t.prototype,e),a&&o(t,a),t}var c=function(){function e(t,a){u(this,e),this.dataProvider=t,this.options=a,this._DATAPROVIDER="dataprovider",this._EXPANDED="expanded",this._KEY="key",this._PARENTKEY="parentKey",this._INDEXFROMPARENT="indexFromParent",this._TREEDEPTH="treeDepth",this._ISLEAF="isLeaf",this._KEYS="keys",this._OFFSET="offset",this._SIZE="size",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._ATTRIBUTES="attributes",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=function(){return function t(e,a){u(this,t),this._parent=e,this._asyncIterator=a,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(e,a,i){u(this,t),this._parent=e,this._nextFunc=a,this._params=i}return d(t,[{key:"next",value:function(){var t=this._nextFunc(this._params);return Promise.resolve(t)}}]),t}(),this.AsyncIteratorYieldResult=function(){return function t(e,a){u(this,t),this._parent=e,this.value=a,this[e._VALUE]=a,this[e._DONE]=!1}}(),this.AsyncIteratorReturnResult=function(){return function t(e,a){u(this,t),this._parent=e,this.value=a,this[e._VALUE]=a,this[e._DONE]=!0}}(),this.Item=function(){return function t(e,a,i){u(this,t),this._parent=e,this.metadata=a,this.data=i,this[e._METADATA]=a,this[e._DATA]=i}}(),this.FlattenedTreeItemMetadata=function(){return function t(e,a,i,r,n,s){u(this,t),this._parent=e,this.key=a,this.parentKey=i,this.indexFromParent=r,this.treeDepth=n,this.isLeaf=s,this[e._KEY]=a,this[e._PARENTKEY]=i,this[e._INDEXFROMPARENT]=r,this[e._TREEDEPTH]=n,this[e._ISLEAF]=s}}(),this.FetchListParameters=function(){return function t(e,a,i,r){u(this,t),this._parent=e,this.size=a,this.sortCriteria=i,this.filterCriterion=r,this[e._SIZE]=a,this[e._SORTCRITERIA]=i,this[e._FILTERCRITERION]=r}}(),this.FetchListResult=function(){return function t(e,a,i,r){u(this,t),this._parent=e,this.fetchParameters=a,this.data=i,this.metadata=r,this[e._FETCHPARAMETERS]=a,this[e._DATA]=i,this[e._METADATA]=r}}(),this.FetchByOffsetParameters=function(){return function t(e,a,i,r,n,s){u(this,t),this._parent=e,this.offset=a,this.size=i,this.sortCriteria=r,this.filterCriterion=n,this.attributes=s,this[e._OFFSET]=a,this[e._SIZE]=i,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=n,this[e._ATTRIBUTES]=s}}(),this.FetchByOffsetResults=function(){return function t(e,a,i,r){u(this,t),this._parent=e,this.fetchParameters=a,this.results=i,this.done=r,this[e._FETCHPARAMETERS]=a,this[e._RESULTS]=i,this[e._DONE]=r}}(),this.FetchByKeysResults=function(){return function t(e,a,i){u(this,t),this._parent=e,this.fetchParameters=a,this.results=i,this[e._FETCHPARAMETERS]=a,this[e._RESULTS]=i}}(),this.ContainsKeysResults=function(){return function t(e,a,i){u(this,t),this._parent=e,this.containsParameters=a,this.results=i,this[e._CONTAINSPARAMETERS]=a,this[e._RESULTS]=i}}(),this.DataProviderMutationEventDetail=function(){return function t(e,a,i,r){u(this,t),this._parent=e,this.add=a,this.remove=i,this.update=r,this[e._ADD]=a,this[e._REMOVE]=i,this[e._UPDATE]=r}}(),this.DataProviderOperationEventDetail=function(){return function t(e,a,i,r,n){u(this,t),this._parent=e,this.keys=a,this.metadata=i,this.data=r,this.indexes=n,this[e._KEYS]=a,this[e._METADATA]=i,this[e._DATA]=r,this[e._INDEXES]=n}}(),this.DataProviderAddOperationEventDetail=function(){return function t(e,a,i,r,n,s,h){u(this,t),this._parent=e,this.keys=a,this.afterKeys=i,this.addBeforeKeys=r,this.metadata=n,this.data=s,this.indexes=h,this[e._KEYS]=a,this[e._AFTERKEYS]=i,this[e._ADDBEFOREKEYS]=r,this[e._METADATA]=n,this[e._DATA]=s,this[e._INDEXES]=h}}();null==this.options&&(this.options={}),this.options.expanded||(this.options.expanded=new n.ExpandedKeySet([])),this._expandedObservable=new s.BehaviorSubject(this._getExpandedObservableValue(this.options.expanded,Promise.resolve())),this.dataProvider.addEventListener("mutate",this._handleUndelryingMutation.bind(this)),this.dataProvider.addEventListener("refresh",this._handleUndelryingRefresh.bind(this)),this._cache=[],this._iterators=new h,this._done=!1}return d(e,[{key:"_handleUndelryingMutation",value:function(e){var a=this,i=null,r=null,n=null,s=e.detail.add;if(s&&s.data&&s.data.length){var h=[],u=[],o=[],d=[],c=[],l=new Set,f=new Set;s.parentKeys.forEach(function(t,e){if(null===t||a._isExpanded(t)&&a._getItemByKey(t)){var i;if(null!=s.addBeforeKeys)i=a._getItemIndexByKey(s.addBeforeKeys[e])-1;else if(null!=s.indexes){var r=a._getItemIndexByKey(t);i=-1===r?s.indexes[e]:r+s.indexes[e]}else i=a._getItemIndexByKey(a._getLastItemByParentKey(t).metadata.key)+1;var n=a._updateItemMetadata(new a.Item(a,s.metadata[e],s.data[e]),t,s.indexes[e]);a._spliceItemToCache(n,i),u.push(n.data),h.push(n.metadata),o.push(i),d.push(s.addBeforeKeys[e]),c.push(t),l.add(s.addBeforeKeys[e]),f.add(s.metadata[e].key),a._incrementIteratorOffset()}}),i=new a.DataProviderAddOperationEventDetail(a,f,l,d,h,u,o)}var _=e.detail.remove;if(_&&_.data&&_.data.length){var y=_.metadata.map(function(t){return t.key}),E=[],v=[],m=[],p=new Set;y.forEach(function(t){var e=a._getLocalDescendentCount(t)+1,i=a._getItemIndexByKey(t);a._cache.splice(i,e).forEach(function(t,e){p.add(t.metadata.key),E.push(t.metadata),v.push(t.data),m.push(i+e),a._decrementIteratorOffset(i)})}),r=new a.DataProviderOperationEventDetail(a,p,E,v,m)}var I=e.detail.update;if(I&&I.data&&I.data.length){var T=[],R=[],O=[],A=new Set;I.metadata.forEach(function(t,e){var i=a._getItemByKey(t.key);if(null!=i){var r=a._getItemIndexByKey(t.key),n=I.data[e],s=new a.FlattenedTreeItemMetadata(a,i.metadata.key,i.metadata.parentKey,i.metadata.indexFromParent,i.metadata.treeDepth,null===a.getChildDataProvider(i.metadata.key));a._cache.splice(r,1,new a.Item(a,s,n)),A.add(i.metadata.key),T.push(i.metadata),R.push(i.data),O.push(r)}}),n=new a.DataProviderOperationEventDetail(a,A,T,R,O)}var S=new a.DataProviderMutationEventDetail(a,i,r,n);a.dispatchEvent(new t.DataProviderMutationEvent(S))}},{key:"_handleUndelryingRefresh",value:function(){this._clearCache(),this.dispatchEvent(new t.DataProviderRefreshEvent)}},{key:"_getExpandedObservableValue",value:function(t,e){return{value:t,completionPromise:e}}},{key:"getChildDataProvider",value:function(t,e){return this.dataProvider.getChildDataProvider(t,e)}},{key:"containsKeys",value:function(t){return this.dataProvider.containsKeys(t)}},{key:"fetchByKeys",value:function(t){var e=this;return this.dataProvider.fetchByKeys(t).then(function(t){var a=new h;return t.results.forEach(function(t,i){var r=e._getItemByKey(i);r?a.set(i,r):a.set(i,t)}),new e.FetchByKeysResults(e,t.fetchParameters,a)})}},{key:"fetchByOffset",value:function(t){var e=this,a=null!=t?t[this._SIZE]:-1,i=null!=t?t[this._SORTCRITERIA]:null,r=null!=t&&t[this._OFFSET]>0?t[this._OFFSET]:0,n=null!=t?t[this._FILTERCRITERION]:null,s=null!=t?t[this._ATTRIBUTES]:null;if(t=new e.FetchByOffsetParameters(e,r,a,i,n,s),e._isSameCriteria(i,n)){if(e._checkCacheByOffset(t))return new Promise(function(a){a(e._getFetchByOffsetResultsFromCache(t))})}else e._clearCache(),e._currentSortCriteria=i,e._currentFilterCriteria=n;return e._fetchByOffset(t)}},{key:"fetchFirst",value:function(t){var e=this,a=null!=t?t[this._SIZE]:-1,i=null!=t?t[this._SORTCRITERIA]:null,r=null!=t?t[this._FILTERCRITERION]:null,n=null!=t?t[this._ATTRIBUTES]:null;e._isSameCriteria(i,r)||(e._currentSortCriteria=i,e._currentFilterCriteria=r,e._clearCache());var s=new e.AsyncIterable(e,new e.AsyncIterator(e,function(){var t=e._iterators.get(s),h=new e.FetchByOffsetParameters(e,t,a,i,r,n);return e.fetchByOffset(h).then(function(a){var i=a.results,r=i.map(function(t){return t[e._DATA]}),n=i.map(function(t){return t[e._METADATA]}),u=0===r.length||a[e._DONE];return e._iterators.set(s,t+n.length),u?Promise.resolve(new e.AsyncIteratorReturnResult(e,new e.FetchListResult(e,h,r,n))):Promise.resolve(new e.AsyncIteratorYieldResult(e,new e.FetchListResult(e,h,r,n)))})},t));return e._iterators.set(s,0),s}},{key:"getCapability",value:function(t){return this.dataProvider.getCapability(t)}},{key:"getTotalSize",value:function(){return Promise.resolve(-1)}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"_isSameCriteria",value:function(t,e){if(t){if(!this._currentSortCriteria||t[0].attribute!=this._currentSortCriteria[0].attribute||t[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(e){if(!this._currentFilterCriteria||e[0].op!=this._currentFilterCriteria[0].op||e[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}},{key:"_checkCacheByOffset",value:function(t){return-1===t[this._SIZE]&&!0===this._done||this._cache.length>=t[this._OFFSET]+t[this._SIZE]&&-1!==t[this._SIZE]}},{key:"_getFetchByOffsetResultsFromCache",value:function(t){var e=this._cache.slice(t[this._OFFSET],-1===t[this._SIZE]?void 0:t[this._OFFSET]+t[this._SIZE]);return new this.FetchByOffsetResults(this,t,e,!1)}},{key:"_clearCache",value:function(){this._cache=[]}},{key:"_fetchByOffset",value:function(t){if(0===this._cache.length){var e=-1===t[this._SIZE]?-1:t[this._OFFSET]+t[this._SIZE],a=new this.FetchByOffsetParameters(this,0,e,t[this._SORTCRITERIA],t[this._FILTERCRITERION],t[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromDataProvider(a,this.dataProvider,null,t)}var i=this._getLastEntry(),r=i.metadata.key,n=0;!i.metadata.isLeaf&&this._isExpanded(r)||(r=i.metadata.parentKey,n=i.metadata.indexFromParent+1);var s=null===r?this.dataProvider:this.getChildDataProvider(r),h=this._getRemainingSize(t),u=new this.FetchByOffsetParameters(this,n,h,t[this._SORTCRITERIA],t[this._FILTERCRITERION],t[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromAncestors(u,s,r,t)}},{key:"_fetchChildrenByOffsetFromAncestors",value:function(t,e,a,i){var r=this;return r._fetchChildrenByOffsetFromDataProvider(t,e,a,i).then(function e(n,s){var h=s.results;if(r._checkCacheByOffset(i)||s[r._DONE]||null===a)return Promise.resolve();var u=r._getItemByKey(n),o=u.metadata.parentKey,d=u.metadata.indexFromParent,c=null===o?r.dataProvider:r.getChildDataProvider(o),l=new r.FetchByOffsetParameters(r,d+1,r._getRemainingSize(i),t[r._SORTCRITERIA],t[r._FILTERCRITERION],t[r._ATTRIBUTES]);return r._fetchChildrenByOffsetFromDataProvider(l,c,o,i).then(e.bind(r,o,new r.FetchByOffsetResults(r,t,h,!1)))}.bind(r,a)).then(r._getFetchByOffsetResultsFromCache.bind(r,i))}},{key:"_fetchChildrenByOffsetFromDataProvider",value:function(t,e,a,i){var r=this;return e.fetchByOffset(t).then(function e(n){var s=n.results;if(0===s.length||r._checkCacheByOffset(i))return Promise.resolve();var h=s.shift(),u=r._updateItemMetadata(h,a);if(r._pushItemToCache(u,a),r._isExpanded(u.metadata.key)){var o=r.getChildDataProvider(u.metadata.key);if(null!=o){var d=new r.FetchByOffsetParameters(r,0,r._getRemainingSize(i),t[r._SORTCRITERIA],t[r._FILTERCRITERION],t[r._ATTRIBUTES]);return r._fetchChildrenByOffsetFromDataProvider(d,o,u.metadata.key,i).then(e.bind(r,new r.FetchByOffsetResults(r,t,s,!1)))}}return e(new r.FetchByOffsetResults(r,t,s,!1))}).then(r._getFetchByOffsetResultsFromCache.bind(r,i))}},{key:"_sequence",value:function(t,e){return t.reduce(function(t,a){return t.then(function(){return e(a)})},Promise.resolve())}},{key:"_getRemainingSize",value:function(t){return-1===t[this._SIZE]?-1:t[this._SIZE]+t[this._OFFSET]-this._cache.length}},{key:"_getExpandedKeysFromResults",value:function(t){var e=this;return t.map(function(t){return t.metadata.key}).filter(function(t){return e._isExpanded(t)})}},{key:"_isExpanded",value:function(t){return this.options[this._EXPANDED].has(t)}},{key:"setExpanded",value:function(e){var a=this,i=a.createOptimizedKeySet(),r=a.createOptimizedKeySet();a._oldExpanded=a.options.expanded,a.options.expanded=e;var n=a._oldExpanded,s=a.options.expanded;if(s.isAddAll()||n.isAddAll()){if(!s.isAddAll()||!n.isAddAll())return a._clearCache(),a.dispatchEvent(new t.DataProviderRefreshEvent),void a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,Promise.resolve()));var h=s.deletedValues(),u=n.deletedValues();h.forEach(function(t){n.has(t)&&r.add(t)}),u.forEach(function(t){s.has(t)&&i.add(t)})}else{var o=s.values(),d=n.values();o.forEach(function(t){n.has(t)||i.add(t)}),d.forEach(function(t){s.has(t)||r.add(t)})}var c=a._expand(i),l=a._collapse(r),f=new Promise(function(e){c.then(function(i){var r=new a.DataProviderMutationEventDetail(a,i,l,null);a.dispatchEvent(new t.DataProviderMutationEvent(r)),e()})});a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,f))}},{key:"getExpandedObservable",value:function(){return this._expandedObservable}},{key:"_isExpandAll",value:function(){return this.options[this._EXPANDED].isAddAll()}},{key:"_pushItemToCache",value:function(t,e){var a=this._getLastItemByParentKey(e),i=null==a?this._getItemIndexByKey(e):this._getItemIndexByKey(a.metadata.key)+this._getLocalDescendentCount(a.metadata.key);this._cache.splice(i+1,0,t)}},{key:"_spliceItemToCache",value:function(t,e){this._cache.splice(e+1,0,t)}},{key:"_updateItemMetadata",value:function(t,e,a){var i=0,r=this._getLastItemByParentKey(e),n=null==r?0:r.metadata[this._INDEXFROMPARENT]+1;(null!=a&&(n=a),null!=e)&&(i=this._getItemByKey(e).metadata.treeDepth+1);return new this.Item(this,new this.FlattenedTreeItemMetadata(this,t.metadata.key,e,n,i,null===this.getChildDataProvider(t.metadata.key)),t.data)}},{key:"_getItemByKey",value:function(t){var e=null;return this._cache.some(function(a){if(a.metadata.key===t)return e=a,!0}),e}},{key:"_getItemIndexByKey",value:function(t){var e=-1;return this._cache.some(function(a,i){if(a.metadata.key===t)return e=i,!0}),e}},{key:"_getLastEntry",value:function(){return this._cache[this._getLastIndex()]}},{key:"_getEntry",value:function(t){return this._cache[t]}},{key:"_getLastItemByParentKey",value:function(t){var e=null;return this._cache.slice().reverse().some(function(a){if(a.metadata.parentKey===t)return e=a,!0}),e}},{key:"_getLastIndex",value:function(){return this._cache.length-1}},{key:"_getLocalDescendentCount",value:function(t){var e=this._getItemByKey(t),a=0;if(null!=e)for(var i=this._getItemIndexByKey(t),r=e.metadata.treeDepth,n=this._getLastIndex(),s=i+1;s<=n;s++){if(!(this._getEntry(s).metadata.treeDepth>r))return a;a+=1}return a}},{key:"_expand",value:function(t){var e=[],a=this;return t.forEach(function(t){var i=new a.FetchByOffsetParameters(a,0,-1,a._currentSortCriteria,a._currentFilterCriteria,null),r=a.getChildDataProvider(t);e.push(a._fetchChildrenByOffsetFromDataProvider(i,r,t,i))}),Promise.all(e).then(function(){var e=a.createOptimizedKeySet(),i=a.createOptimizedKeySet(),r=[],n=[],s=[];return t.forEach(function(t){var h=a._getLocalDescendentCount(t);if(h>0){var u=a._getItemIndexByKey(t)+1,o=null;a._cache.slice(u,u+h).forEach(function(t,h){e.add(t.metadata.key),i.add(o),r.push(t.metadata),n.push(t.data),s.push(u+h),o=t.metadata.key,a._incrementIteratorOffset()})}}),new a.DataProviderAddOperationEventDetail(a,e,i,[],r,n,s)})}},{key:"_collapse",value:function(t){var e=this,a=[],i=[],r=[],n=e.createOptimizedKeySet();return t.forEach(function(t){var s=e._getLocalDescendentCount(t);if(s>0){var h=e._getItemIndexByKey(t);e._cache.splice(h+1,s).forEach(function(t,s){n.add(t.metadata.key),a.push(t.metadata),i.push(t.data),r.push(h+s+1),e._decrementIteratorOffset(h+1)})}}),new e.DataProviderOperationEventDetail(e,n,a,i,r)}},{key:"_decrementIteratorOffset",value:function(t){var e=this;e._iterators.forEach(function(a,i){t<a&&e._iterators.set(i,a-1)})}},{key:"_incrementIteratorOffset",value:function(){var t=this;t._iterators.forEach(function(e,a){t._iterators.set(a,e+1)})}},{key:"createOptimizedKeySet",value:function(t){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(t):new a(t)}},{key:"createOptimizedKeyMap",value:function(t){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(t);if(t){var e=new h;return t.forEach(function(t,a){e.set(a,t)}),e}return new h}}]),e}();
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return t.FlattenedTreeDataProviderView=c,t.FlattenedTreeDataProviderView=c,t.EventTargetMixin.applyMixin(c),c});