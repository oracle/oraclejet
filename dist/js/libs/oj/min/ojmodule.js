/**
 * @license
 * Copyright (c) 2014, 2022, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","knockout","ojs/ojlogger","ojs/ojcontext"],function(e,n,t,o){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o;const i={};return e._registerLegacyNamespaceProp("ModuleBinding",i),i.defaults={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"},i._EMPTY_MODULE="oj:blank",function(){function l(e,t,o){var i=t||e,l=[];o&&e===i&&(o.parentNode.removeChild(o),l.push(o)),n.virtualElements.setDomNodeChildren(i,l)}function r(e,n){e.forEach(function(e){n.appendChild(e)})}function a(e,t){for(var o,i=0;i<e.length&&!(o=n.contextFor(e[i]));i++);return o&&o.$module&&o.$module===t}function d(e,n,t){var o={};t[0]&&(o.viewModel=t[0]),t[1]&&(o.view=t[1]);var i=new CustomEvent(n,{detail:o});e.dispatchEvent(i)}function u(e,t,o){if(e&&e[t]){var i={element:o[0],valueAccessor:o[1]};return o.length>2&&(i.viewModel=o[2],o.length>3&&(i["boolean"==typeof o[3]?"fromCache":"cachedNodes"]=o[3])),n.ignoreDependencies(e[t],e,[i])}}function s(e,t,o){if(null!=e){var l=i.defaults[t];if(null!=l&&e){var r,a=e[l];if("function"==typeof a)return o&&(r={element:o[0],valueAccessor:o[1]},o.length>2&&(r["boolean"==typeof o[2]?"fromCache":"cachedNodes"]=o[2])),n.ignoreDependencies(a,e,[r])}}}function c(e,t,o){if(e&&t){var i=e[t];"function"==typeof i&&n.ignoreDependencies(i,e,[o])}}function f(e,t,o){for(var i=e;null!=i;){var l=n.virtualElements.nextSibling(i),r=i.nodeType;i===t||1!==r&&8!==r||o(i),i=l}}function v(e,t){for(var o=t.length-1;o>=0;o--)n.virtualElements.prepend(e,t[o])}function p(e,n){if(n)for(var t=0;t<e.length;t++){var o=e[t];1===o.nodeType&&n(o)}}function h(e,n,o){var i=e||require,l=new Promise(function(e,n){i([o],e,n)});return l=l.catch(function(e){throw t.error("ojModule failed to load "+o),e})}n.bindingHandlers.ojModule={init:function(m,w,g,b,C){var y,M,E,P,j,N,V,D,A={},H=-1,O=m.parentNode&&"OJ-MODULE"===m.parentNode.nodeName,$=O?function(){}:s,_=O?function(){}:u,x=O?c:function(){},T=O?d:function(){};function F(){N&&(N(),N=null)}var S=function(e){$(e,"disposeMethod",[m,w])},B=function(){S(y)};n.utils.domNodeDisposal.addDisposeCallback(m,function(){B();for(var e=Object.keys(A),n=0;n<e.length;n++){var t=A[e[n]].model;S(t)}F()});var L=new Error("Promise cancelled because ojModule is fetching new View and ViewModel"),k=function(e){if(e!==H)throw L},q=m;return 8===m.nodeType&&(q=m.parentNode,n.virtualElements.setDomNodeChildren(m,[]),j=m.nextSibling),n.computed(function(){if(H+=1,!N){var d=o.getContext(q).getBusyContext();N=d.addBusyState({description:"ojModule binding on a node with the Id "+m.id+"is loading the module. Binding evaluator: "+w.toString()})}var u,s,c,g,b,S,I,U,z,J,Y,K,R,W,G=0===H,Q=n.utils.unwrapObservable,X=Q(w());"string"==typeof X?u=X:(u=Q(X.name),s=Q(X.viewName),c=Q(X.params),g=Q(X.viewModelFactory),b=Q(X.createViewFunction),S=Q(X.cacheKey),I=Q(X.lifecycleListener),U=Q(X.animation),K=Q(X.view),R=Q(X.viewModel),z=Q(X.require),W=Q(X.cleanupMode)),null==z||z instanceof Function||(Y=z.viewPath,J=z.modelPath,z=z.instance),s=null==s?u:s;var Z,ee,ne,te,oe=i._EMPTY_MODULE===s,ie=_(I,"activated",[m,w]);if(T(q,"ojTransitionStart",[R]),oe?(Z=Promise.resolve([]),ee=Promise.resolve(null)):null!=(ne=null==S?null:A[S])&&(delete A[S],Z=Promise.resolve(ne.view),ee=Promise.resolve(ne.model)),null==Z&&null!=K&&(Z=Promise.resolve(K)),null==ee&&(null!=R?ee=Promise.resolve(R):null!=g&&(ee=n.ignoreDependencies(g.createViewModel,g,[c,w])),null==ee&&null!=u&&(null==J&&(J=i.defaults.modelPath),ee=h(z,"viewModel",J+u)),null!=ee&&(ee=ee.then(function(e,n){return k(e),n="function"==typeof n?new n(c):$(n,"initializeMethod",[m,w])||n}.bind(null,H)),null==Z&&null!=b&&(Z=ee.then(function(e,n){if(k(e),null==n)throw F(),new Error("createViewFunction option cannot be used when the ViewModel is null");var t=n[b];if(null==t)throw F(),new Error("function specified by the createViewFunction option was not found on the ViewModel");return t.call(n)}.bind(null,H)))),null==Z)){if(null==s)throw F(),new Error("View name or view instance must be specified");null==Y&&(Y=i.defaults.viewPath),Z=h(z,"view",Y+s+i.defaults.viewSuffix)}if(null==Z)throw F(),new Error("ojModule is missing a View");null!=ee&&(te=ee.then(function(e,n){return k(e),$(n,"activatedHandler",[m,w])}.bind(null,H))),Promise.all([Z,ee,ie,te,M]).then(function(o,i){if(o===H){var d=i[0];if(null==d)throw F(),new Error("The module's View was resolved to null");var u=function(e,t){var o=e;if("string"==typeof o)o=n.utils.parseHtmlFragment(o,document);else if(function(e){if(window.DocumentFragment)return e instanceof DocumentFragment;return e&&11===e.nodeType}(o))o=n.utils.arrayPushAll([],o.childNodes);else{if(!Array.isArray(o))throw t(),new Error("The View ("+o+") has an unsupported type");o=n.utils.arrayPushAll([],o)}return o}(d,F),s=i[1];!function(e,n,t,o,i){if(o&&n.length>0&&!a(n,t)){if(n[0]._oj_module_used_view)throw i(),new Error("The oj-module with id '"+e.id+"' cannot apply binding on a previously cleaned view.");Object.defineProperty(n[0],"_oj_module_used_view",{value:!0})}}(m,u,s,O,F);var h,g=!1,b=function(e,t,o){for(var i=[],l=n.virtualElements.firstChild(e);null!=l&&l!==o;l=l.nextSibling)l!==t&&i.push(l);return i}(m,P,j),N=function(e,t){var o=[];return f(n.virtualElements.firstChild(e),t,function(e){o.push(e)}),o}(m,P);null==E||V?O&&(h=b):(g=!0,h=b,P||((P=document.createElement("div")).className="oj-helper-module-cache",n.virtualElements.prepend(m,P)));var L=!1,k=function(t){if(!L){if(L=!0,g)r(b,P),l(m,t||m,P);else if(O&&"none"===D)for(var o=0;o<h.length;o++){var i=h[o];i.parentNode.removeChild(i)}else N.forEach(function(e){n.cleanNode(e)}),l(m,t||m,P);G||(_(I,"detached",[m,w,y,h]),$(y,"detachedHandler",[m,w,h]),x(y,"disconnected",h),T(q,"ojViewDisconnected",[y,h]),_(I,"deactivated",[m,w,y]),$(y,"deactivatedHandler",[m,w])),g?(p(h,e.Components?e.Components.subtreeHidden:null),A[E]={model:y,view:h}):O&&"none"===D?p(h,e.Components?e.Components.subtreeDetached:null):B(),y=s,E=S,V=oe,D=W}},z=function(){_(I,"transitionCompleted",[m,w,s]),$(s,"transitionCompletedHandler",[m,w]),x(s,"transitionCompleted",u),T(q,"ojTransitionEnd",[s]),F()};if(null!=U){var J=function(o,i,l,a,d,u,s){var c,f,h=o,m=i.canAnimate;if(null!=m&&!m.call(i,h))return;var w=i.prepareAnimation.call(i,h);w&&(c=w.newViewParent,f=w.oldViewParent);var g=c||l;f&&f!==l?r(a,f):g===l&&u(null);g!==l&&n.virtualElements.setDomNodeChildren(g,[]);d(g);var b=Array.prototype.slice.call(g.childNodes),C=!1,y=function(){if(!C&&(C=!0,l!==g)){v(l,b);var n=l.parentNode&&"OJ-MODULE"===l.parentNode.nodeName;e.Components&&!n&&(p(b,e.Components.subtreeDetached),p(b,e.Components.subtreeAttached))}},M=u.bind(null,f);h.newViewParent=c,h.oldViewParent=f,h.oldViewNodes=a,h.removeOldView=M,h.insertNewView=y;var E=function(){M(),y(),s()};return i.animate.call(i,h).then(E,function(){E(),t.error("ojModule animation promise was rejected")})}(function(e,n,t,o,i,l){return{node:l?e.parentNode:e,valueAccessor:l?null:n,isInitial:t,oldViewModel:o,newViewModel:i}}(m,w,G,y,s,O),U,m,b,Y,k,z);M=function(e){if(!e)return e;return new Promise(function(n,t){e.then(n,n)})}(J)}else M=void 0;M||(k(null),Y(null),z())}function Y(t){var o=t||m,i=O&&a(u,s);v(o,u);var l=null!=ne;if(l?p(u,e.Components?e.Components.subtreeShown:null):i&&p(u,e.Components?e.Components.subtreeAttached:null),_(I,"attached",[o,w,s,l]),$(s,"attachedHandler",[o,w,l]),x(s,"connected",u),T(q,"ojViewConnected",[s]),!l&&!i){var r=C.createChildContext(s,void 0,function(e){e.$module=s,e.$params=c});O&&(r.$parent=void 0,r.$parents=void 0,r.$parentContext=void 0,r.$props=void 0,r.$properties=void 0,r.$slotNodeCounts=void 0,r.$slotCounts=void 0,r.$unique=void 0,r.$uniqueId=void 0,r.$provided=void 0),function(e,t,o,i){var l=n.bindingProvider.instance,r=l.preprocessNode;r&&(f(t,i,function(e){r.call(l,e)}),t=n.virtualElements.firstChild(e));f(t,i,function(e){n.applyBindings(o,e)})}(o,u[0],r,P),_(I,"bindingsApplied",[o,w,s]),$(s,"bindingsAppliedHandler",[o,w])}}}.bind(null,H),function(e,n){n!==L&&null!=n&&(F(),t.error(n))}.bind(null,H))},null,{disposeWhenNodeIsRemoved:m}),{controlsDescendantBindings:!0}}},n.virtualElements.allowedBindings.ojModule=!0}(),i});
//# sourceMappingURL=ojmodule.js.map