/**
 * @license
 * Copyright (c) 2014, 2023, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojcore-base","ojs/ojdatagridprovider","ojs/ojeventtarget","ojs/ojdatacollection-common"],function(e,t,s,a,r){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;class i{constructor(e,t){if(this.dataProvider=e,this.options=t,this.version=0,this.keyCache=[],this.lastRowKeyCached=!1,this.GridItem=class{constructor(e,t){this.metadata=e,this.data=t}},this.GridBodyItem=class{constructor(e,t,s,a,r,i){this.rowExtent=e,this.columnExtent=t,this.rowIndex=s,this.columnIndex=a,this.metadata=r,this.data=i}},this.GridHeaderItem=class{constructor(e,t,s,a,r,i){this.index=e,this.extent=t,this.level=s,this.depth=a,this.metadata=r,this.data=i}},this.GridHeaderMetadata=class{constructor(e,t,s,a){this.sortDirection=e,this.expanded=t,this.treeDepth=s,this.showRequired=a}},this.FetchByOffsetGridResults=class{constructor(e,t,s,a,r,i,o,n,d,l,h,u){this.fetchParameters=e,this.rowDone=t,this.columnDone=s,this.rowOffset=a,this.columnOffset=r,this.rowCount=i,this.columnCount=o,this.totalRowCount=n,this.totalColumnCount=d,this.results=l,this.version=h,this.next=u}},this.sortable=t?.sortable,this.sortCriteria=null,this.supportsFilteredRowCount="exact"===e.getCapability("fetchFirst")?.totalFilteredRowCount,t?.expandedObservable){t?.expandedObservable.subscribe(e=>{this.expandedState=e.value})}e.addEventListener("mutate",this._handleUnderlyingMutation.bind(this)),e.addEventListener("refresh",this._handleUnderlyingRefresh.bind(this))}async fetchByOffset(e){const t=e.rowOffset;let s=e.rowCount,a={results:[],done:!1,fetchParameters:null};0!=s&&(a=await this.dataProvider.fetchByOffset({offset:t,size:s}));let r=-1;if(!this.isSameFetchParameters(a.fetchParameters)||null==this.totalRowCount){if(this.supportsFilteredRowCount){let e=await this.dataProvider.fetchFirst({size:1,includeFilteredRowCount:"enabled"})[Symbol.asyncIterator]().next();null!=e.value.totalFilteredRowCount&&(r=e.value.totalFilteredRowCount)}else this.isUnfiltered(a.fetchParameters)&&(r=await this.dataProvider.getTotalSize());this.totalRowCount=r}this.updateKeyCache(a,t),this.setupLayout(a.results),this.sortCriteria=a.fetchParameters?.sortCriteria;const i=e.columnOffset,o=i+e.columnCount>=this.columns.databody.length,n=Math.max(Math.min(e.columnCount,this.columns.databody.length-i),0);s=Math.min(e.rowCount,a.results.length);const d=a.done;this.lastRowKeyCached=a.done;const l=this.version,h=e.fetchRegions,u=null==h||h.has("all"),c=u||h?.has("databody"),m=u||h?.has("rowHeader"),f=u||h?.has("columnHeader"),p=u||h?.has("rowEndHeader"),w=u||h?.has("columnEndHeader"),y=u||h?.has("rowHeaderLabel"),C=u||h?.has("columnHeaderLabel"),b=u||h?.has("rowEndHeaderLabel"),v=u||h?.has("columnEndHeaderLabel"),H=c?this.getDatabodyResults(a.results,t,s,i,n):void 0,g=m?this.getRowHeaderResults("rowHeader",a.results,t,s):void 0,R=p?this.getRowHeaderResults("rowEndHeader",a.results,t,s):void 0,E=f?this.getColumnHeaderResults("column",i,n):void 0,x=w?this.getColumnHeaderResults("columnEnd",i,n):void 0,L=y?this.getRowHeaderLabelResults():void 0,O=b?this.getRowEndHeaderLabelResults():void 0,P={databody:H,columnHeader:E,columnHeaderLabel:C?this.getColumnHeaderLabelResults("column"):void 0,columnEndHeader:x,columnEndHeaderLabel:v?this.getColumnHeaderLabelResults("columnEnd"):void 0,rowHeader:g,rowHeaderLabel:L,rowEndHeader:R,rowEndHeaderLabel:O};return new this.FetchByOffsetGridResults(e,d,o,t,i,s,n,this.totalRowCount,this.columns.databody.length,P,l,null)}updateKeyCache(e,t){let s=e.fetchParameters;this.isSameFetchParameters(s)||this._clearKeyCache(),this.currentFetchParameters=s,e.results.forEach((e,s)=>{this.keyCache[t+s]=e.metadata.key})}_clearKeyCache(){this.keyCache=[]}isKeyCacheSparse(){for(let e=0;e<this.keyCache.length;e++)if(void 0===this.keyCache[e])return!0;return!1}isSameFetchParameters(e){let s=e?.sortCriteria,a=e?.filterCriterion,r=this.currentFetchParameters?.sortCriteria,i=this.currentFetchParameters?.filterCriterion;return!!t.Object.compareValues(s,r)&&!!t.Object.compareValues(a,i)}isUnfiltered(e){return null==e||null==e.filterCriterion}setupLayout(e){this.setupColumns(e),this.setupColumnHeaders(),this.setupHeaderLabels()}setupColumns(e){if(null==this.columns){this.columns={};const t=e[0];if(this.columns.rowHeader=this.getFromOptions(this.options?.columns?.rowHeader,t),this.columns.rowEndHeader=this.getFromOptions(this.options?.columns?.rowEndHeader,t),this.options?.columns?.databody){let e=this.options.columns.databody;this.columns.databody="function"==typeof e?e(t):e}else if(null==t)this.columns.databody=[];else{const e=Object.keys(t.data);this.columns.databody=e.filter(e=>!this.columns.rowHeader?.includes(e)&&!this.columns.rowEndHeader?.includes(e))}}}setupColumnHeaders(){if(null==this.columnHeaders){this.columnHeaders={};const e=this.getFromOptions(this.options?.columnHeaders?.column,this.columns?.databody,this.columns?.databody,e=>({data:e}));this.columnHeaders.column=this.parseNestedHeaders(e);const t=this.getFromOptions(this.options?.columnHeaders?.columnEnd,this.columns?.databody,this.columns?.databody,e=>({data:e}));this.columnHeaders.columnEnd=this.parseNestedHeaders(t)}}setupHeaderLabels(){null==this.headerLabels&&(this.headerLabels={},this.headerLabels.row=this.getFromOptions(this.options?.headerLabels?.row,this.columns?.rowHeader,this.columns?.rowHeader,e=>e),this.headerLabels.rowEnd=this.getFromOptions(this.options?.headerLabels?.rowEnd,this.columns?.rowEndHeader,this.columns?.rowEndHeader,e=>e),this.headerLabels.column=this.getFromOptions(this.options?.headerLabels?.column,this.columnHeaders?.column?.headerArray),this.headerLabels.columnEnd=this.getFromOptions(this.options?.headerLabels?.columnEnd,this.columnHeaders?.columnEnd?.headerArray))}getFromOptions(e,t,s,a){if(null!=e)return"function"==typeof e?e(t):s&&"attributeName"===e?s.map(a):e}parseNestedHeaders(e){if(null==e)return;"string"==typeof e[0]&&(e=e.map(e=>({data:e})));let t=[],s=1;const a=(e,r,i)=>{let o=0;return e.forEach(e=>{let n=e.depth||1,d=1;e.children&&(d=a(e.children,r,i+n));let l={index:r,extent:d,level:i,depth:n,data:e.data};t.push(l),s=Math.max(s,i+1),o+=d,r+=d}),o};return a(e,0,0),{headerArray:t,levelCount:s}}getCapability(e){return"version"===e?"monotonicallyIncreasing":null}isEmpty(){return"unknown"}setDataProvider(e){this.dataProvider=e}getDatabodyResults(e,t,s,a,r){if(e?.length>0){const i=[];for(let o=0;o<s;o++){const s=e[o];for(let e=0;e<r;e++){const r=this.columns.databody[a+e],n={data:s.data[r]};let d={rowItem:s};const l=new this.GridBodyItem(1,1,t+o,a+e,d,n);i.push(l)}}return i}}getRowHeaderResults(e,t,s,a){const r=this.columns[e];if(t?.length>0&&r?.length>0){const e=[];for(let i=r.length-1;i>=0;i--){const o=r[i];for(let r=0;r<a;r++){const a=s+r,n=t[r],d={data:n.data[o]};let l,h=n.metadata.treeDepth;this.expandedState&&!1===n.metadata.isLeaf&&(l=this.expandedState.has(n.metadata.key)?"expanded":"collapsed");const u={rowItem:n,expanded:l,treeDepth:h},c=new this.GridHeaderItem(a,1,i,1,u,d);e.push(c)}}return e}}getSortState(e){let t=this.columns.databody[e];if(this.sortCriteria&&this.sortCriteria.length>0&&t){let e=this.sortCriteria[0];if(e.attribute===t)return e.direction}return"unsorted"}getColumnHeaderResults(e,t,s){if(this.columnHeaders?.[e]){const a=[],r=[],i=this.columnHeaders[e].levelCount;for(let o=0;o<s;o++){const s=t+o;for(let t=0;t<i;t++){if(r[s]?.[t])continue;const o=this.getColumnHeaderItem(s,t,this.columnHeaders[e].headerArray),n={data:o.data},d=o.index,l=o.extent,h=o.level,u=o.depth;let c;c=this.sortable&&"column"===e&&t+u===i?new this.GridHeaderMetadata(this.getSortState(d)):{};const m=new this.GridHeaderItem(d,l,h,u,c,n);a.push(m);for(let e=d;e<d+l;e++){null==r[e]&&(r[e]=[]);for(let s=t;s<t+u;s++)r[e][s]=!0}}}return a}}getColumnHeaderItem(e,t,s){return s.find(s=>{let a=s.index,r=s.extent,i=s.level,o=s.depth;return e>=a&&e<a+r&&t>=i&&t<i+o})}getRowHeaderLabelResults(){let e;if("attributeName"===this.headerLabels?.row?e=this.columns.rowHeader:this.headerLabels?.row&&(e=this.headerLabels.row),e){let t=[];for(let s=e.length-1;s>=0;s--)t.push(new this.GridItem({},{data:e[s]}));return t}}getRowEndHeaderLabelResults(){let e;if("attributeName"===this.headerLabels?.rowEnd?e=this.columns.rowEndHeader:this.headerLabels?.rowEnd&&(e=this.headerLabels.rowEnd),e){let t=[];for(let s=e.length-1;s>=0;s--)t.push(new this.GridItem({},{data:e[s]}));return t}}getColumnHeaderLabelResults(e){if(this.headerLabels?.[e]){let t=[];for(let s=this.headerLabels[e].length-1;s>=0;s--)t.push(new this.GridItem({},{data:this.headerLabels[e][s]}));return t}}_handleUnderlyingMutation(e){this.version++;let t,a,i,o,n=e.detail,d=!1,l=this.isKeyCacheSparse(),h=this.lastRowKeyCached&&!l;if(n.remove&&n.remove.keys.size>0&&([d,t,o]=this._convertEventDetail(n.remove,"remove",l)),o?.sort((e,t)=>t.index-e.index).forEach(e=>{this.keyCache.splice(e.index,1),-1!==this.totalRowCount&&(this.totalRowCount-=1)}),!d&&n.add&&n.add.keys.size>0){let e=r.getAddEventKeysResult(this.keyCache,n.add,h);if(d=l&&e.length!==this.keyCache.length+n.add.keys.size,!d){let t=[];n.add.keys.forEach(s=>{let a=e.indexOf(s),r=t.find(e=>a===e.offset+e.count);r?r.count+=1:t.push({offset:a,count:1}),-1!==this.totalRowCount&&(this.totalRowCount+=1)}),i={axis:"row",ranges:t,version:this.version},this.keyCache=e}}!d&&n.update&&n.update.keys.size>0&&([d,a]=this._convertEventDetail(n.update,"update",l)),d?(this.resetInternal(),this.dispatchEvent(new s.DataGridProviderRefreshEvent)):(t&&this.dispatchEvent(new s.DataGridProviderRemoveEvent(t)),i&&this.dispatchEvent(new s.DataGridProviderAddEvent(i)),a&&this.dispatchEvent(new s.DataGridProviderUpdateEvent(a)))}_convertEventDetail(e,t,s){let a,r=[],i=!1,o=0;if(e.keys.forEach(t=>{let a=e.indexes?.[o],n=this.keyCache.indexOf(t);-1!=n?r.push({index:n,key:t}):null!=a?r.push({index:a,key:t}):s&&(i=!0),o++}),r.length>0)if("remove"===t||"add"===t){a={axis:"row",ranges:r.map(e=>({offset:e.index,count:1})),version:this.version}}else if("update"===t){a={ranges:r.map(e=>({rowOffset:e.index,rowCount:1,columnOffset:0,columnCount:-1})),version:this.version}}return[i,a,r]}_handleUnderlyingRefresh(e){this.version++;let t,a=this.isKeyCacheSparse(),r=!0;if(null!=e?.detail?.disregardAfterKey){const s=this.keyCache.indexOf(e.detail.disregardAfterKey);if(-1!==s)t={disregardAfterRowOffset:s},this.keyCache.length=s+1,this.totalRowCount=-1===this.totalRowCount?-1:s+1,this.lastRowKeyCached=!1,r=!1;else if(!a)return}r&&this.resetInternal();const i=new s.DataGridProviderRefreshEvent(t);this.dispatchEvent(i)}resetInternal(){this._clearKeyCache(),this.totalRowCount=null,this.currentFetchParameters=null,this.sortCriteria=null,this.lastRowKeyCached=!1}}a.EventTargetMixin.applyMixin(i),e.RowDataGridProvider=i,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ojrowdatagridprovider.js.map