/**
 * @license
 * Copyright (c) 2014, 2023, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","preact","ojs/ojcore-base","ojs/ojcustomelement-utils","ojs/ojcustomelement-registry","ojs/ojmetadatautils","ojs/ojlogger"],function(e,t,o,r,s,n,a){"use strict";o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o;const i=Symbol("row");class l{static renderNodes(e,o){const s=o.parentStub;let n=()=>Array.from(s.childNodes);o.nodes&&(n=l._getRetrieveNodesFunction(o.nodes));const a=console.error;console.error=(e,t)=>{-1===e.indexOf("Improper nesting of table.")&&a.apply(console,arguments)};try{t.render(e,s)}finally{console.error=a}const c=n();c.forEach(e=>{e.setAttribute?e.setAttribute("data-oj-vdom-template-root",""):e._oj_vdom_template_root=!0,e[i]=o,e[r.CACHED_BINDING_PROVIDER]="preact"}),o.vnode=e,o.nodes=c}static clean(e){var o;const r=e[i];if(!r.cleaned){r.cleaned=!0;const e=l._getInsertNodesFunction(r.nodes);t.render(null,r.parentStub),e(r.nodes),null===(o=r.computedVNode)||void 0===o||o.dispose();const s=r.template,n=s._cachedRows.indexOf(r);s._cachedRows.splice(n,1)}}static findTemplateRoots(e){let t=e&&e.querySelectorAll?Array.from(e.querySelectorAll('[data-oj-vdom-template-root=""]')):[];if(e&&e.hasAttribute&&e.hasAttribute("data-oj-vdom-template-root")&&t.push(e),0===t.length){const o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let r=o.currentNode;for(;r;)r._oj_vdom_template_root&&t.push(r),r=o.nextNode()}return t}static _getInsertNodesFunction(e){const t=e[e.length-1],o=t.parentNode,r=t.nextSibling;return e=>{e.forEach(e=>o.insertBefore(e,r))}}static _getRetrieveNodesFunction(e){const t=e[0],o=e[e.length-1],r=t.parentNode,s=t.previousSibling,n=o.nextSibling;return()=>{const e=[];for(let t=s?s.nextSibling:r.firstChild;t!==n;t=t.nextSibling)e.push(t);return e}}static resolveVDomTemplateProps(e,t,o,r,n,a,i){const d=s.getPropertiesForElementTag(o),[u,p]=l.extendTemplate(e,l._COMPUTED_PROPS_CACHE_FACTORY,e=>{for(const t of u)t.recalculateValue(e)}),_=new c(e=>l._computeProps(e,o,d,r,n,i),t,a,p);return u.add(_),_}static _computeProps(e,t,o,s,a,i){const l=e(a),c=(Array.isArray(l)?l:[l]).find(e=>e.type===t);if(!c)throw new Error("Item template must contain an element named {elementTagName}");const d={},u=c.props;return Object.keys(u).forEach(e=>{s.has(e)&&(d[e]=r.transformPreactValue(null,n.getPropertyMetadata(e,o),c.props[e]))}),d}static extendTemplate(e,t,o){if(!e._cachedRows){let r=e.render;Object.defineProperties(e,{_cachedRows:{writable:!0,value:t()},render:{enumerable:!0,get:()=>r,set(e){r=e,e&&o(e)}}})}return e._cachedRows}}l._COMPUTED_PROPS_CACHE_FACTORY=()=>{const e=new Set;return[e,e.delete.bind(e)]},l._ROW_CACHE_FACTORY=()=>[];class c{constructor(e,t,o,r){this._calculate=e,this._defaultProps=o,this._disposeCallback=r,this._value=e(t),this._merged=this._getMergedValue(this._value)}peek(){return this._merged}subscribe(e){if(this._sub)throw new Error("Resolved property observable does not support multiple subscribers");this._sub=e}dispose(){this._disposeCallback(this)}recalculateValue(e){const t=this._calculate(e),r=this._value;this._value=t,this._sub&&!o.Object.compareValues(t,r)&&(this._merged=this._getMergedValue(t),this._sub(this._merged))}_getMergedValue(e){return Object.assign({},this._defaultProps,e)}}class d{static getContext(e,t,o,r,s,n){if(e){let i=o.__ojBindingContext?o.__ojBindingContext:e.__ContextFor(o);return i||(a.info("Binding context not found when processing template for element with id: "+t.id+". Using binding context for element instead."),i=e.__ContextFor(t)),e.__ExtendBindingContext(i,r,s,n,t)}const i={$current:r};return n&&(i[n]=r),i}static getResolvedDefaultProps(e,t,o){let r=e.get(t);if(!r){const s=document.createElement(t);r=d.getStaticPropertyMap(s,o,document.body),e.set(t,r)}return r}static getStaticPropertyMap(e,t,o){const r={};if(e){const s=e.style;s.display="none",s.position="absolute",e.setAttribute("data-oj-binding-provider","none"),o.appendChild(e),t.forEach(function(t){void 0!==e[t]&&(r[t]=e[t])}),o.removeChild(e)}return r}static createPropertyBackedByObservable(e,t,o,r,s){const n=e.__Observable(r);Object.defineProperty(t,o,{get:()=>n(),set:e=>{n(e),s&&s(e)},enumerable:!0})}}e.PreactTemplate=l,e.TemplateEngineUtils=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ojtemplateengine-utils.js.map