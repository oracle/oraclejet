/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojdatasource-common","ojs/ojmodel"],function(e,t){e.CollectionTableDataSource=function(t,a){if(this.data={},!(t instanceof e.Collection)){var n=e.TableDataSource._LOGGER_MSG._ERR_DATA_INVALID_TYPE_SUMMARY,l=e.TableDataSource._LOGGER_MSG._ERR_DATA_INVALID_TYPE_DETAIL;throw new Error(n+"\n"+l)}e.CollectionTableDataSource.superclass.constructor.call(this,t,a),this._collection=t,this._addCollectionEventListeners(),this.Init(),(null==a||"enabled"!=a.startFetch&&null!=a.startFetch)&&null!=a||(this._startFetchEnabled=!0)},e.Object.createSubclass(e.CollectionTableDataSource,e.TableDataSource,"oj.CollectionTableDataSource"),e.CollectionTableDataSource.prototype.comparator=null,e.CollectionTableDataSource.prototype.Init=function(){e.CollectionTableDataSource.superclass.Init.call(this)},e.CollectionTableDataSource.prototype.at=function(t,a){(a=a||{}).deferred=!0;var n,l=this._collection.at(t,a),o=this;return o._isFetchingForAt=!0,new Promise(function(a,i){null!=l?l.then(function(e){o._isFetchingForAt=!1,n={data:e.attributes,index:t,key:e.id},a(n)},function(t){o._isFetchingForAt=!1,e.TableDataSource.superclass.handleEvent.call(o,e.TableDataSource.EventType.ERROR,t),i(t)}):a(null)})},e.CollectionTableDataSource.prototype.fetch=function(e){return"init"!=(e=e||{}).fetchType||this._startFetchEnabled?this._fetchInternal(e):Promise.resolve()},e.CollectionTableDataSource.prototype.get=function(t,a){(a=a||{}).deferred=!0;var n,l,o=this._collection.get(t,a),i=this;return new Promise(function(t,a){null!=o?o.then(function(e){l=i._wrapWritableValue(e,e.attributes),n={data:l,index:e.index,key:e.id},t(n)},function(t){e.TableDataSource.superclass.handleEvent.call(i,e.TableDataSource.EventType.ERROR,t),a(t)}):t(null)})},e.CollectionTableDataSource.prototype.sort=function(e){null==e?e=this.sortCriteria:this.sortCriteria=e;var t=this.comparator,a=this;return new Promise(function(n,l){null==t?(a._collection.comparator=e.key,"ascending"==e.direction?a._collection.sortDirection=1:a._collection.sortDirection=-1):a._collection.comparator=t,a._collection.sort(null),n({header:e.key,direction:e.direction})})},e.CollectionTableDataSource.prototype.totalSize=function(){var e=this._collection.totalResults>=0?this._collection.totalResults:-1;if(e>-1){var t=this._collection.size();return t>e?t:e}if(this._fetchResultSize>0)e=this._fetchResultSize;else if("atLeast"==this.totalSizeConfidence())return this._collection.size();return e},e.CollectionTableDataSource.prototype.totalSizeConfidence=function(){return this._collection.totalResults>=0?"actual":this._collection.hasMore?"atLeast":"unknown"},e.CollectionTableDataSource.prototype._addCollectionEventListeners=function(){var a=this;this._collection.on(e.Events.EventType.SYNC,function(t){if(t instanceof e.Model)e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.CHANGE,{data:[t.attributes],keys:[t.id],indexes:[t.index]});else if(t instanceof e.Collection&&!a._isFetchingForAt&&!a._isFetching){var n=t.offset,l=t.lastFetchCount||t.lastFetchSize;if(l>0||a._collection.IsVirtual()){a._startIndex=n,a._pageSize=l;var o=0;(a._collection.totalResults>0||a._collection.hasMore)&&(o=n+l),a._isFetchingForAt=!0,t.IterativeAt(n,o).then(function(e){a._isFetchingForAt=!1;var t,l,o,i=[],c=[];for(t=0;t<e.length;t++)null!=e[t]&&(l=e[t],o=a._wrapWritableValue(l,l.attributes),i.push(o),c.push(l.id));var r={data:i,keys:c,startIndex:n};a._endFetch.call(a,{silent:!1},r,null)})}else{var i=a._getRowArray();a._endFetch.call(a,{silent:!1},i,null)}}}),this._collection.on(e.Events.EventType.ALLADDED,function(t,n){var l,o,i,c=[],r=[],s=[];for(l=0;l<n.length;l++)o=n[l],i=a._wrapWritableValue(o,o.attributes),c.push(i),r.push(o.id),s.push(o.index);e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.ADD,{data:c,keys:r,indexes:s})}),this._collection.on(e.Events.EventType.ALLREMOVED,function(t,n){var l,o,i=[],c=[],r=[];for(l=0;l<n.length;l++)o=n[l],i.push(o.attributes),c.push(o.id),r.push(o.index);e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.REMOVE,{data:i,keys:c,indexes:r})}),this._collection.on(e.Events.EventType.RESET,function(t){e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.RESET,t)}),this._collection.on(e.Events.EventType.SORT,function(n,l){if(null==l||!l.add){var o={};null==n||null==!n.comparator||t.isFunction(n.comparator)||(o.header=n.comparator,o.direction=1===n.sortDirection?"ascending":"descending"),e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.SORT,o)}}),this._collection.on(e.Events.EventType.CHANGE,function(t){e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.CHANGE,{data:[t.attributes],keys:[t.id],indexes:[t.index]})}),this._collection.on(e.Events.EventType.DESTROY,function(t){e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.DESTROY,t)}),this._collection.on(e.Events.EventType.REFRESH,function(t){e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.REFRESH,t)}),this._collection.on(e.Events.EventType.ERROR,function(t,n,l){e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.ERROR,t,n,l)}),this._collection.on(e.Events.EventType.REQUEST,function(t){a._isFetching||e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.REQUEST,t)})},e.CollectionTableDataSource.prototype._fetchInternal=function(e){this._startFetch(e),e=e||{};var t=this;return this._isPaged=e.pageSize>0,this._startIndex=null==e.startIndex?this._startIndex:e.startIndex,this._pageSize=e.pageSize>0?e.pageSize:-1,e.pageSize=this._pageSize,e.startIndex=this._startIndex,e.refresh=!0,new Promise(function(a,n){var l=t._pageSize;t._isPaged||(l=25),t._collection.setRangeLocal(t._startIndex,l).then(function(n){var l;if(t._isPaged||t._collection.IsVirtual()){var o,i,c,r=[],s=[];for(o=0;o<n.models.length;o++)i=n.models[o],c=t._wrapWritableValue(i,i.attributes),r[o]=c,s[o]=i.id;l={data:r,keys:s,startIndex:t._startIndex},n.models.length<t._pageSize?t.totalSize()<0&&(t._fetchResultSize=t._startIndex+n.models.length):t._fetchResultSize=null}else l=t._getRowArray();t._endFetch.call(t,e,l,null),a(l)},function(a){t._endFetch.call(t,e,null,a),n(a)})})},e.CollectionTableDataSource.prototype._startFetch=function(t){this._isFetching=!0,t.silent||e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.REQUEST,{startIndex:t.startIndex})},e.CollectionTableDataSource.prototype._endFetch=function(t,a,n){this._isFetching=!1,null!=n?e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.ERROR,n):t.silent||e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.SYNC,a)},e.CollectionTableDataSource.prototype._getRowArray=function(){var e,t,a,n=this._collection.size()-1,l=[],o=[];for(e=0;e<=n;e++)a=this._collection.at(e),t=this._wrapWritableValue(a,a.attributes),l[e]=t,o[e]=a.id;return{data:l,keys:o,startIndex:this._startIndex}},e.CollectionTableDataSource.prototype.getCapability=function(e){return null},e.CollectionTableDataSource.prototype._wrapWritableValue=function(e,t){var a,n={};for(a in t)t.hasOwnProperty(a)&&function(){var t=a,l=e;Object.defineProperty(n,a,{get:function(){return l.get(t)},set:function(e){l.set(t,e,{silent:!0})},enumerable:!0})}();return n}});