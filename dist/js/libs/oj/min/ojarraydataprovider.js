/**
 * @license
 * Copyright (c) 2014, 2023, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojmap","ojs/ojset","ojs/ojdataprovider","ojs/ojeventtarget","ojs/ojlogger"],function(t,e,s,i,r,a){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class n{constructor(t,e){var s;this.data=t,this.options=e,this.Item=class{constructor(t,e){this.metadata=t,this.data=e,this[n._METADATA]=t,this[n._DATA]=e}},this.ItemMetadata=class{constructor(t){this.key=t,this[n._KEY]=t}},this.FetchByKeysResults=class{constructor(t,e){this.fetchParameters=t,this.results=e,this[n._FETCHPARAMETERS]=t,this[n._RESULTS]=e}},this.ContainsKeysResults=class{constructor(t,e){this.containsParameters=t,this.results=e,this[n._CONTAINSPARAMETERS]=t,this[n._RESULTS]=e}},this.FetchByOffsetResults=class{constructor(t,e,s,i){this.fetchParameters=t,this.results=e,this.done=s,this.totalFilteredRowCount=i,this[n._FETCHPARAMETERS]=t,this[n._RESULTS]=e,this[n._DONE]=s,"enabled"===t?.includeFilteredRowCount&&(this[n._TOTALFILTEREDROWCOUNR]=i)}},this.FetchListParameters=class{constructor(t,e,s,i){this.size=t,this.sortCriteria=e,this.filterCriterion=s,this.attributes=i,this[n._SIZE]=t,this[n._SORTCRITERIA]=e,this[n._FILTERCRITERION]=s,this[n._ATTRIBUTES]=i}},this.FetchListResult=class{constructor(t,e,s){this.fetchParameters=t,this.data=e,this.metadata=s,this[n._FETCHPARAMETERS]=t,this[n._DATA]=e,this[n._METADATA]=s}},this.AsyncIterable=(s=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=()=>this._asyncIterator}},Symbol.asyncIterator,s),this.AsyncIterator=class{constructor(t,e,s,i,r){this._parent=t,this._nextFunc=e,this._params=s,this._offset=i,this._signal=r,this._clientId=s&&s.clientId||Symbol(),t._mapClientIdToIteratorInfo.set(this._clientId,{offset:i,rowKey:null,data:null,filterCriterion:s?.filterCriterion,sortCriteria:s?.sortCriteria,fetchedRowKeys:[]}),this._cacheObj={},this._cacheObj[n._MUTATIONSEQUENCENUM]=t._mutationSequenceNum}next(){const t=this._signal;if(this._signal){const t=this._signal.reason;if(this._signal.aborted)return Promise.reject(new DOMException(t,"AbortError"))}return new Promise((e,s)=>{if(t){const e=t.reason;t.addEventListener("abort",t=>s(new DOMException(e,"AbortError")))}const i=this._parent._mapClientIdToIteratorInfo.get(this._clientId),r=i?i.offset:null,a=this._nextFunc(this._params,r,!1,this._cacheObj);Object.defineProperty(a.result.value,"totalFilteredRowCount",{get:()=>{if("enabled"===this._params?.includeFilteredRowCount)return(void 0===this._totalFilteredRowCount||this._parent._resetTotalFilteredRowCount)&&(this._totalFilteredRowCount=this._parent._getTotalFilteredRowCount(this._params),this._parent._resetTotalFilteredRowCount=!1),this._totalFilteredRowCount},enumerable:!0});const n=a.result.value.metadata?.length>0?a.result.value.metadata[a.result.value.metadata.length-1]?.key:null,o=a.result.value.data?.length>0?a.result.value.data[a.result.value.data.length-1]:null,l=a.result.value.metadata?.map(t=>t.key);return this._parent._mapClientIdToIteratorInfo.set(this._clientId,{offset:a.offset,rowKey:n,data:o,filterCriterion:this._params?.filterCriterion,sortCriteria:this._params?.sortCriteria,fetchedRowKeys:l?i?.fetchedRowKeys?i.fetchedRowKeys.concat(l):l:[]}),e(a.result)})}},this.AsyncIteratorYieldResult=class{constructor(t){this.value=t,this[n._VALUE]=t,this[n._DONE]=!1}},this.AsyncIteratorReturnResult=class{constructor(t){this.value=t,this[n._VALUE]=t,this[n._DONE]=!0}},this.DataProviderMutationEventDetail=class{constructor(t,e,s,i){this._parent=t,this.add=e,this.remove=s,this.update=i,this[n._ADD]=e,this[n._REMOVE]=s,this[n._UPDATE]=i,Object.defineProperty(this,n._PARENT,{value:t,enumerable:!1})}},this.DataProviderOperationEventDetail=class{constructor(t,e,s,i,r){this._parent=t,this.keys=e,this.metadata=s,this.data=i,this.indexes=r,this[n._KEYS]=e,this[n._METADATA]=s,this[n._DATA]=i,this[n._INDEXES]=r,Object.defineProperty(this,n._PARENT,{value:t,enumerable:!1})}},this.DataProviderAddOperationEventDetail=class{constructor(t,e,s,i,r,a,o){this._parent=t,this.keys=e,this.afterKeys=s,this.addBeforeKeys=i,this.metadata=r,this.data=a,this.indexes=o,this[n._KEYS]=e,this[n._AFTERKEYS]=s,this[n._ADDBEFOREKEYS]=i,this[n._METADATA]=r,this[n._DATA]=a,this[n._INDEXES]=o,Object.defineProperty(this,n._PARENT,{value:t,enumerable:!1})}},this._sequenceNum=0,this._mutationSequenceNum=0,this._mapClientIdToIteratorInfo=new Map,this._subscribeObservableArray(t),null!=e&&null!=e[n._KEYS]&&(this._keysSpecified=!0,this._keys=e[n._KEYS])}containsKeys(t){return this.fetchByKeys(t).then(e=>{const i=new s;return t[n._KEYS].forEach(t=>{null!=e[n._RESULTS].get(t)&&i.add(t)}),Promise.resolve(new this.ContainsKeysResults(t,i))})}fetchByKeys(s){const i=s?s.signal:void 0;if(i){const t=i.reason;if(i.aborted)return Promise.reject(new DOMException(t,"AbortError"))}return new Promise((r,a)=>{if(i){const t=i.reason;i.addEventListener("abort",e=>a(new DOMException(t,"AbortError")))}this._generateKeysIfNeeded();const o=new e,l=this._getKeys(),h=null!=s?s[n._ATTRIBUTES]:null;let u,c=0;if(s){const e=this._getRowData();return s[n._KEYS].forEach(s=>{for(u=null,c=0;c<l.length;c++)if(t.Object.compareValues(l[c],s)){u=c;break}if(null!=u&&u>=0){let t=e[u];if(h&&h.length>0){const e={};this._filterRowAttributes(h,t,e),t=e}o.set(s,new this.Item(new this.ItemMetadata(s),t))}}),r(new this.FetchByKeysResults(s,o))}return a("Keys are a required parameter")})}fetchByOffset(t){const e=t?t.signal:void 0;if(e){const t=e.reason;if(e.aborted)return Promise.reject(new DOMException(t,"AbortError"))}return new Promise((s,i)=>{if(e){const t=e.reason;e.addEventListener("abort",e=>i(new DOMException(t,"AbortError")))}const r=null!=t?t[n._SIZE]:-1,a=null!=t?t[n._SORTCRITERIA]:null,o=null!=t&&t[n._OFFSET]>0?t[n._OFFSET]:0,l=null!=t?t[n._ATTRIBUTES]:null,h=null!=t?t[n._FILTERCRITERION]:null;this._generateKeysIfNeeded();let u,c=[],_=!0;if(t){const e=new this.FetchListParameters(r,a,h,l),i=this._fetchFrom(e,o,!0).result;e[n._SORTCRITERIA]&&(t[n._SORTCRITERIA]=e[n._SORTCRITERIA]);const d=i[n._VALUE];_=i[n._DONE];const f=d[n._DATA],E=d[n._METADATA].map(t=>t[n._KEY]);return c=f.map((t,e)=>new this.Item(new this.ItemMetadata(E[e]),t)),"enabled"===t.includeFilteredRowCount&&(u=this._getTotalFilteredRowCount(t)),s(new this.FetchByOffsetResults(t,c,_,u))}return i("Offset is a required parameter")})}_getTotalFilteredRowCount(t){const e=this._getRowData(),s=t?t[n._FILTERCRITERION]:null;let r=-1;if(s){r=0;let t=i.FilterFactory.getFilter({filterDef:s,filterOptions:this.options});for(let s=0;s<e.length;s++)t.filter(e[s])&&++r}else r=e.length;return r}fetchFirst(t){const e=t?t.signal:void 0;return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0,e))}getCapability(t){return n.getCapability(t)}static _getFetchCapability(){const t=new Set;return t.add("exclusion"),{caching:"all",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:t}}}}static getCapability(t){return"sort"===t?{attributes:"multiple"}:"fetchByKeys"===t?Object.assign({implementation:"lookup"},n._getFetchCapability()):"fetchByOffset"===t?Object.assign({implementation:"randomAccess",totalFilteredRowCount:"exact"},n._getFetchCapability()):"fetchFirst"===t?Object.assign({iterationSpeed:"immediate",totalFilteredRowCount:"exact"},n._getFetchCapability()):"fetchCapability"===t?n._getFetchCapability():"filter"===t?{operators:["$co","$eq","$ew","$pr","$gt","$ge","$lt","$le","$ne","$regex","$sw","$exists"],attributeExpression:["*"],textFilter:{},textFilterMatching:{matchBy:["startsWith","contains","phrase"]},nestedFilter:{},collationOptions:{sensitivity:["base","accent","case","variant"]}}:null}getTotalSize(){return Promise.resolve(this._getRowData().length)}isEmpty(){return this._getRowData().length>0?"no":"yes"}createOptimizedKeySet(t){return new s(t)}createOptimizedKeyMap(t){if(t){const s=new e;return t.forEach((t,e)=>{s.set(e,t)}),s}return new e}_getRowData(){return this[n._DATA]instanceof Array?this[n._DATA]:this[n._DATA]()}_getKeys(){return null==this._keys||this._keys instanceof Array?this._keys:this._keys()}_indexOfKey(e,s){let i,r=-1;for(i=0;i<s.length;i++)if(t.Object.compareValues(s[i],e)){r=i;break}return r}_adjustIteratorOffset(t,e){const s=t?.indexes,i=e?.indexes;this._mapClientIdToIteratorInfo.forEach((r,a)=>{if(r.offset>0){const n=r.filterCriterion,o=r.sortCriteria,l=o?this._getSortComparator(o):null;s&&s.forEach((e,s)=>{const i=Array.from(t.keys)[s],a=this._indexOfKey(i,r.fetchedRowKeys);a>-1&&(--r.offset,r.fetchedRowKeys.splice(a,1))}),i&&i.forEach((t,s)=>{const i=e.data[s],a=Array.from(e.keys)[s];if(!n||!n.filter||i&&n.filter(i))if(l){if(i&&r.data&&l({value:r.data},{value:i})>0){++r.offset;this._indexOfKey(a,r.fetchedRowKeys)<0&&r.fetchedRowKeys.splice(t,0,a)}}else{if(t<this._indexOfKey(r.rowKey,this._getKeys())){++r.offset;this._indexOfKey(a,r.fetchedRowKeys)<0&&r.fetchedRowKeys.splice(t,0,a)}}}),this._mapClientIdToIteratorInfo.set(a,r)}})}_subscribeObservableArray(e){if(!(e instanceof Array)){if(!this._isObservableArray(e))throw new Error("Invalid data type. ArrayDataProvider only supports Array or observableArray.");e.subscribe(e=>{let i,r,n,o,l,h=[],u=[],c=[],_=[];const d=[];this._mutationSequenceNum++;let f=!0,E=!0;this._resetTotalFilteredRowCount=!0,e.forEach(t=>{"deleted"===t.status?(f=!1):"added"===t.status&&(E=!1)});const p=[],T=[];let R=null,A=null,y=null;const m=this._generateKeysIfNeeded();if(!f&&!E){for(i=0;i<e.length;i++){o=e[i].index,l=e[i].status;const s=this._getId(e[i].value);for(r=0;r<e.length;r++)r!==i&&o===e[r].index&&l!==e[r].status&&p.indexOf(i)<0&&T.indexOf(i)<0&&(null==s||t.Object.compareValues(s,this._getId(e[r].value)))&&("deleted"===l?(T.push(i),p.push(r)):(T.push(r),p.push(i)))}for(i=0;i<e.length;i++)if(p.indexOf(i)>=0){const t=this._getKeys()[e[i].index];u.push(t),h.push(e[i].value),c.push(e[i].index)}if(u.length>0){_=u.map(t=>new this.ItemMetadata(t));const t=new s;u.forEach(e=>{t.add(e)}),R=new this.DataProviderOperationEventDetail(this,t,_,h,c)}}if(h=[],u=[],c=[],!f){for(i=0;i<e.length;i++)"deleted"===e[i].status&&p.indexOf(i)<0&&T.indexOf(i)<0&&(n=this._getId(e[i].value),null==n&&(n=m?e[i].index:this._getKeys()[e[i].index]),u.push(n),h.push(e[i].value),c.push(e[i].index));if(u.length>0&&u.forEach(t=>{const e=this._indexOfKey(t,this._getKeys());e>=0&&this._keys.splice(e,1)}),u.length>0){_=u.map(t=>new this.ItemMetadata(t));const t=new s;u.forEach(e=>{t.add(e)}),y=new this.DataProviderOperationEventDetail(this,t,_,h,c)}}if(h=[],u=[],c=[],!E){const t=null==this._getKeys()||!(this._getKeys().length>0);for(i=0;i<e.length;i++)"added"===e[i].status&&p.indexOf(i)<0&&T.indexOf(i)<0&&(n=this._getId(e[i].value),null==n&&(m||this._keysSpecified)&&(n=this._getKeys()[e[i].index]),null==n?(n=this._sequenceNum,this._sequenceNum++,this._keys.splice(e[i].index,0,n)):t||-1===this._indexOfKey(n,this._getKeys())?this._keys.splice(e[i].index,0,n):m||this._keysSpecified||(a.warn("added row has duplicate key "+n),this._keys.splice(e[i].index,0,n)),u.push(n),h.push(e[i].value),c.push(e[i].index));for(i=0;i<e.length;i++)if("added"===e[i].status&&p.indexOf(i)<0&&T.indexOf(i)<0){let t=this._getKeys()[e[i].index+1];t=null==t?null:t,d.push(t)}if(u.length>0){_=u.map(t=>new this.ItemMetadata(t));const t=new s;u.forEach(e=>{t.add(e)});const e=new s;d.forEach(t=>{e.add(t)}),A=new this.DataProviderAddOperationEventDetail(this,t,e,d,_,h,c)}}this._fireMutationEvent(A,y,R)},null,"arrayChange"),e.subscribe(t=>{if(this._mutationEvent){const t=this._mutationEvent.detail;this._adjustIteratorOffset(t.remove,t.add),this.dispatchEvent(this._mutationEvent)}else if(this._mutationRemoveEvent||this._mutationAddEvent||this._mutationUpdateEvent){if(this._mutationRemoveEvent){const t=this._mutationRemoveEvent.detail;this._adjustIteratorOffset(t.remove,null),this.dispatchEvent(this._mutationRemoveEvent)}if(this._mutationAddEvent){const t=this._mutationAddEvent.detail;this._adjustIteratorOffset(null,t.add),this.dispatchEvent(this._mutationAddEvent)}this._mutationUpdateEvent&&this.dispatchEvent(this._mutationUpdateEvent)}else this.dispatchEvent(new i.DataProviderRefreshEvent);this._mutationEvent=null,this._mutationRemoveEvent=null,this._mutationAddEvent=null,this._mutationUpdateEvent=null},null,"change")}}_fireMutationEvent(t,e,s){const r=new this.DataProviderMutationEventDetail(this,t,e,s);this._mutationEvent=new i.DataProviderMutationEvent(r)}_hasSamePropValue(e,s,i){const r="_hasSamePropValue is true";try{e&&e[i]&&e[i].forEach(e=>{s&&s[i]&&s[i].forEach(s=>{if(t.Object.compareValues(e,s))throw r})})}catch(t){if(t===r)return!0;throw t}return!1}_isObservableArray(t){return"function"==typeof t&&t.subscribe&&!(void 0===t.destroyAll)}_generateKeysIfNeeded(){if(null==this._keys){const t=null!=this.options?this.options[n._KEYATTRIBUTES]||this.options[n._IDATTRIBUTE]:null;this._keys=[];const e=this._getRowData();let s,i=0;for(i=0;i<e.length;i++)s=this._getId(e[i]),null!=s&&"@index"!==t||(s=this._sequenceNum,this._sequenceNum++),this._keys[i]=s;return!0}return!1}_getId(t){let e,s=null;if(null!=this.options&&(null!=this.options[n._KEYATTRIBUTES]?s=this.options[n._KEYATTRIBUTES]:null!=this.options[n._IDATTRIBUTE]&&(s=this.options[n._IDATTRIBUTE])),null!=s){if(Array.isArray(s)){let i;for(e=[],i=0;i<s.length;i++)e[i]=this._getVal(t,s[i])}else e="@value"===s?this._getAllVals(t):this._getVal(t,s);return e}return null}_getVal(t,e){if("string"==typeof e){const s=e.indexOf(".");if(s>0){const i=e.substring(0,s),r=e.substring(s+1),a=t[i];if(a)return this._getVal(a,r)}}return"function"==typeof t[e]?t[e]():t[e]}_getAllVals(t){return"string"==typeof t||"number"==typeof t||"boolean"==typeof t?t:Object.keys(t).map(e=>this._getVal(t,e))}_fetchFrom(t,e,s,r){const a=null!=t?t[n._ATTRIBUTES]:null;this._generateKeysIfNeeded();const o=null!=t?t[n._SORTCRITERIA]:null,l=this._getCachedIndexMap(o,r),h=this._getRowData(),u=l.map(t=>h[t]),c=l.map(t=>this._getKeys()[t]),_=null!=t?t[n._SIZE]>0?t[n._SIZE]:t[n._SIZE]<0?this._getKeys().length:25:25;let d=e+_<u.length;const f=this._mergeSortCriteria(o);null!=f&&((t=t||{})[n._SORTCRITERIA]=f);let E,p=[],T=[],R=0;if(null!=t&&t[n._FILTERCRITERION]){let s=null;s=i.FilterFactory.getFilter({filterDef:t[n._FILTERCRITERION],filterOptions:this.options});let r=0;for(;p.length<_&&r<u.length;)s.filter(u[r])&&(R>=e&&(p.push(u[r]),T.push(c[r])),R++),r++;d=r<u.length}else p=u.slice(e,e+_),T=c.slice(e,e+_);R=e+p.length,E=p.map(t=>{if(a&&a.length>0){const e={};this._filterRowAttributes(a,t,e),t=e}return t});let A=T.map(t=>new this.ItemMetadata(t)),y=new this.FetchListResult(t,E,A);return(s?d:y.data.length>0)?{result:new this.AsyncIteratorYieldResult(y),offset:R}:{result:new this.AsyncIteratorReturnResult(y),offset:R}}_getCachedIndexMap(t,e){if(e&&e.indexMap&&e[n._MUTATIONSEQUENCENUM]===this._mutationSequenceNum)return e.indexMap;const s=this._getRowData().map((t,e)=>e),i=this._sortData(s,t);return e&&(e.indexMap=i,e[n._MUTATIONSEQUENCENUM]=this._mutationSequenceNum),i}_sortData(t,e){const s=this._getRowData(),i=t.map(t=>({index:t,value:s[t]}));return null!=e&&i.sort(this._getSortComparator(e)),i.map(t=>t.index)}_getSortComparator(t){return(e,s)=>{const r=null!=this.options?this.options[n._SORTCOMPARATORS]:null;let a,o,l,h,u,c;for(a=0;a<t.length;a++){o=t[a][n._DIRECTION],l=t[a][n._ATTRIBUTE],h=null,null!=r&&(h=r[n._COMPARATORS].get(l)),u=this._getVal(e.value,l),c=this._getVal(s.value,l),h||(h=i.SortUtils.getNaturalSortComparator());const _="descending"===o?-1:1,d=h(u,c)*_;if(0!==d)return d}return 0}}_mergeSortCriteria(t){const e=null!=this.options?this.options[n._IMPLICITSORT]:null;return null==e?t:null==t?e:void 0}_filterRowAttributes(t,e,s){if(Array.isArray(t)){let i,r=!1;t.forEach(t=>{t!==n._ATDEFAULT&&t.name!==n._ATDEFAULT||(r=!0)}),Object.keys(e).forEach(a=>{if(r){let r,n=!1,o=a;for(i=0;i<t.length;i++)if(r=t[i]instanceof Object?t[i].name:t[i],r.startsWith("!")){if(r=r.substr(1,r.length-1),r===a){n=!0;break}}else if(r===a){o=t[i];break}n||this._filterRowAttributes(o,e,s)}else t.forEach(t=>{let i;i=t instanceof Object?t.name:t,i.startsWith("!")||i!==a||this._filterRowAttributes(t,e,s)})})}else if(t instanceof Object){const i=t.name,r=t.attributes;if(i&&!i.startsWith("!"))if(e[i]instanceof Object&&!Array.isArray(e[i])&&r){const t={};this._filterRowAttributes(r,e[i],t),s[i]=t}else if(Array.isArray(e[i])&&r){let t;s[i]=[],e[i].forEach((e,a)=>{t={},this._filterRowAttributes(r,e,t),s[i][a]=t})}else this._proxyAttribute(s,e,i)}else this._proxyAttribute(s,e,t)}_proxyAttribute(t,e,s){t&&e&&Object.defineProperty(t,s,{get:()=>e[s],set(t){e[s]=t},enumerable:!0})}}return n._KEY="key",n._KEYS="keys",n._AFTERKEYS="afterKeys",n._ADDBEFOREKEYS="addBeforeKeys",n._DIRECTION="direction",n._ATTRIBUTE="attribute",n._ATTRIBUTES="attributes",n._SORT="sort",n._SORTCRITERIA="sortCriteria",n._FILTERCRITERION="filterCriterion",n._DATA="data",n._METADATA="metadata",n._INDEXES="indexes",n._OFFSET="offset",n._SIZE="size",n._IDATTRIBUTE="idAttribute",n._IMPLICITSORT="implicitSort",n._KEYATTRIBUTES="keyAttributes",n._SORTCOMPARATORS="sortComparators",n._COMPARATORS="comparators",n._COMPARATOR="comparator",n._RESULTS="results",n._CONTAINS="contains",n._FETCHPARAMETERS="fetchParameters",n._CONTAINSPARAMETERS="containsParameters",n._VALUE="value",n._DONE="done",n._ADD="add",n._REMOVE="remove",n._UPDATE="update",n._DETAIL="detail",n._FETCHLISTRESULT="fetchListResult",n._ATDEFAULT="@default",n._MUTATIONSEQUENCENUM="mutationSequenceNum",n._PARENT="_parent",n._TOTALFILTEREDROWCOUNR="totalFilteredRowCount",r.EventTargetMixin.applyMixin(n),t._registerLegacyNamespaceProp("ArrayDataProvider",n),n});
//# sourceMappingURL=ojarraydataprovider.js.map