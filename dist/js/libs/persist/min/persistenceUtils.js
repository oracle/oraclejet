define(["./impl/logger"],function(a){"use strict";function b(a){return a.headers.has("x-oracle-jscpt-cache-expiration-date")}function c(a){return a.headers.has("x-oracle-jscpt-etag-generated")}function d(a,c){var d=c.headers.get("Content-Type"),f=a.responseType;return e(c.headers)?"text":b(c)||"blob"===f?"blob":d&&d.indexOf("image/")!==-1||"arraybuffer"===f?"arraybuffer":d&&d.indexOf("multipart/form-data")!==-1?"multipart":"text"}function e(a){var b=a.get("Content-Type");return!(!b||!b.match(/.*text\/.*/)&&!b.match(/.*application\/.*json.*/))}function f(a){var b=a.get("Content-Type");return b&&b.indexOf("multipart/")!==-1}function g(b,c){a.log("Offline Persistence Toolkit persistenceUtils: requestToJSON()"),c&&c._noClone||(b=b.clone());var d={};return h(b,d,["body","headers","signal"]),d.headers=j(b.headers),l(b,d)}function h(a,b,c){for(var d in a)"function"==typeof a[d]||i(d)||c.indexOf(d)!==-1||(b[d]=a[d])}function i(a){return 0===a.indexOf("_")}function j(a){var b={};if(a.entries){var c,d,e,f=a.entries();do c=f.next(),c.value&&(d=c.value[0],e=c.value[1],b[d]=e);while(!c.done)}else a.forEach&&a.forEach(function(a,c){b[c]=a});return k(b),b}function k(b){var c=b.date;c||(a.log("Offline Persistence Toolkit persistenceUtils: Setting HTTP date header since it's null or not exposed"),c=(new Date).toUTCString(),b.date=c)}function l(a,b){return b.body={},a instanceof Request&&f(a.headers)?m(a,b):a instanceof Request||e(a.headers)?a.text().then(function(a){return b.body.text=a,b}):a instanceof Request||"function"!=typeof a.arrayBuffer?Promise.reject(new Error({message:"payload body type is not supported"})):a.arrayBuffer().then(function(a){return a.byteLength>0&&(b.body.arrayBuffer=a),b})}function m(b,c){if(a.log("Offline Persistence Toolkit persistenceUtils: Copying multipart payload"),"function"==typeof b.formData)return b.formData().then(function(a){var b,d,e,f,g={},h=a.entries();do b=h.next(),d=b.value,d&&(e=d[0],f=d[1],g[e]=f);while(!b.done);return c.body.formData=g,c});var d=b.headers.get("Content-Type");return b.text().then(function(a){for(var b=v(a,d),e={},f=0;f<b.length;f++)e[b[f].headers.name]=b[f].data;return c.body.formData=e,c})}function n(b,c){a.log("Offline Persistence Toolkit persistenceUtils: responseToJSON()"),c&&c._noClone||(b=b.clone());var d={};return h(b,d,["body","headers"]),d.headers=j(b.headers),c&&c.excludeBody?Promise.resolve(d):l(b,d)}function o(b){a.log("Offline Persistence Toolkit persistenceUtils: requestFromJSON()");var c={};h(b,c,["headers","body","signal"]);var d=p(b,c);return c.headers=q(b,d),r(b,c)}function p(a,b){var c=!1,d=a.body;if(d.text&&d.text.length>0)b.body=d.text;else if(d.arrayBuffer)b.body=d.arrayBuffer;else if(d.formData){c=!0;var e=new FormData,f=d.formData;Object.keys(f).forEach(function(a){e.append(a,f[a])}),b.body=e}return c}function q(a,b){var c=new Headers;return Object.keys(a.headers).forEach(function(d){("content-type"!==d||!b&&"content-type"===d)&&c.append(d,a.headers[d])}),c}function r(a,b){return Promise.resolve(new Request(a.url,b))}function s(b){a.log("Offline Persistence Toolkit persistenceUtils: responseFromJSON()");var c={};return h(b,c,["headers","body"]),c.headers=q(b,!1),t(b,c)}function t(a,b){var c,d=a.body;return d&&d.text?c=new Response(d.text,b):d&&d.arrayBuffer?(b.responseType="blob",c=new Response(d.arrayBuffer,b)):d&&d.blob?(b.responseType="blob",c=new Response(d.blob,b)):c=new Response(null,b),Promise.resolve(c)}function u(b,c){return a.log("Offline Persistence Toolkit persistenceUtils: setResponsePayload()"),n(b).then(function(a){var b=a.body;return b.arrayBuffer=null,b.blob=null,b.text=null,c instanceof ArrayBuffer?b.arrayBuffer=c:c instanceof Blob?b.blob=c:b.text=JSON.stringify(c),s(a)})}function v(b,c){a.log("Offline Persistence Toolkit persistenceUtils: parseMultipartFormData()");var d=c.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!d)throw new Error("not a valid multipart form data value.");var e,f=function(a){for(var b={},c={},d=a.split("\r\n"),e=0;e<d.length;e++){var f=d[e];if(0!==f.length){var g=f.split(";");if(1===g.length&&0===g[0].indexOf("Content-Type"))b.contentType=g[0].split(":")[1].trim();else for(var h=0;h<g.length;h++)if(g[h].indexOf("=")!==-1){var i=g[h].split("=");c[i[0].trim()]=i[1].substring(1,i[1].length-1)}}}return b.headers=c,b},g=function(a,b){var c=a.split("\r\n");return b&&b.indexOf("image")>=0?h(c[0],b):c[0]},h=function(a,b){var c=null;try{c=atob(a)}catch(a){return null}for(var d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);var g=new Blob([d],{type:b});return g},i=d[1]||d[2],j="string"==typeof b;if(j)e=b;else{var k=new Uint8Array(b);e=String.fromCharCode.apply(null,k)}for(var l=e.split(new RegExp(i)),m=[],n=1;n<l.length-1;n++){var o={},p=l[n],q=p.split("\r\n\r\n"),r=q[0],s=q[1],t=f(r);o.headers=t.headers,o.data=g(s,t.contentType),m.push(o)}return m}function w(b){a.log("Offline Persistence Toolkit persistenceUtils: buildEndpointKey() for Request with url: "+b.url);var c={url:b.url,id:Math.random().toString(36).replace(/[^a-z]+/g,"")};return JSON.stringify(c)}function x(a){return g(a,{_noClone:!0}).then(function(a){return o(a).then(function(a){return a})})}function y(a,b){return b=b||{},n(a,{_noClone:!0}).then(function(a){return s(a).then(function(a){return null!=b.url&&b.url.length>0&&null==a.headers.get("x-oracle-jscpt-response-url")&&a.headers.set("x-oracle-jscpt-response-url",b.url),a})})}function z(a,b,c){var d=a||[],e=b||[];if(c){d=[],e=[];var f,g=null!=a?a.length:b.length;for(f=0;f<g;f++){var h=null!=a?{key:a[f]}:{key:null},i=null!=b?{metadata:h,data:b[f]}:{metadata:h,data:null},j=c.mapFields(i);d[f]=j.metadata.key,e[f]=j.data}}return{keys:d,data:e}}function A(a,b,c){var d=a||[],e=b||[];if(c){d=[],e=[];var f,g=null!=a?a.length:b.length;for(f=0;f<g;f++){var h=null!=a?{key:a[f]}:{key:null},i=null!=b?{metadata:h,data:b[f]}:{metadata:h,data:null},j=c.unmapFields(i);d[f]=j.metadata.key,e[f]=j.data}}return{keys:d,data:e}}function B(a,b){if(a&&b){var c=C(a.selector);c&&(a.selector=D(b.mapFilterCriterion(c)))}return a}function C(a){if(a){var b={};return Object.keys(a).forEach(function(c){if(c.startsWith("value.")){var d=a[c];d instanceof Object?(b.op=Object.keys(d)[0],b.value=d[b.op]):(b.op="$eq",b.value=d),b.attribute=c.substr(6,c.length)}else{var e=c;"$and"!=e&&"$or"!=e||(b.op=e,b.value=[],a[e].forEach(function(a,c){b.value[c]=C(a)}))}}),b}return null}function D(a){if(a){var b={},c=a.op;return"$and"==c||"$or"==c?(b[c]=[],a.value.forEach(function(a,d){b[c][d]=D(a)})):(b["value."+a.attribute]={},b["value."+a.attribute][a.op]=a.value),b}return null}return{requestToJSON:g,requestFromJSON:o,responseToJSON:n,responseFromJSON:s,setResponsePayload:u,parseMultipartFormData:v,isCachedResponse:b,isGeneratedEtagResponse:c,_isTextPayload:e,buildEndpointKey:w,_cloneRequest:x,_cloneResponse:y,_derivePayloadType:d,_mapData:z,_unmapData:A,_mapFindQuery:B}});