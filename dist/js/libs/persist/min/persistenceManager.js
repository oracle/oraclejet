define(["./impl/PersistenceXMLHttpRequest","./impl/PersistenceSyncManager","./impl/offlineCacheManager","./impl/logger","./impl/fetch"],function(a,b,c,d){"use strict";function e(){Object.defineProperty(this,"_registrations",{value:[],writable:!0}),Object.defineProperty(this,"_eventListeners",{value:[],writable:!0}),Object.defineProperty(this,"_forceOffline",{value:!1,writable:!0}),Object.defineProperty(this,"_isOffline",{value:!1,writable:!0}),Object.defineProperty(this,"_cache",{value:null,writable:!0}),Object.defineProperty(this,"_persistenceSyncManager",{value:new b(this.isOnline.bind(this),this.browserFetch.bind(this),this.getCache.bind(this))})}function f(a){var b=a;g()&&!b._addedBrowserEventListeners&&(d.log("Offline Persistence Toolkit PersistenceManager: Adding browser event listeners"),window.addEventListener("offline",function(a){b._isOffline=!0},!1),window.addEventListener("online",function(a){b._isOffline=!1},!1),b._addedBrowserEventListeners=!0)}function g(){return"undefined"!=typeof window&&null!=window}function h(a,b,c){var e,f,g,h,i=null,j=a._registrations,k=null!=j?j.length:0;for(e=0;e<k;e++)if(g=j[e],null!=c.request.url.match(g.scope)){for(h=g._eventListeners.length,f=0;f<h;f++)if(g._eventListeners[f].type==b)if("fetch"==b)null===i&&c._setPromiseCallbacks instanceof Function&&(i=new Promise(function(a,b){c._setPromiseCallbacks(a,b)})),d.log("Offline Persistence Toolkit PersistenceManager: Calling fetch event listener"),g._eventListeners[f].listener(c);else if(d.log("Offline Persistence Toolkit PersistenceManager: Calling event listener"),!1===g._eventListeners[f].listener(c))return!1;if(null!=i)return i}return!0}function i(a){a._cache=c.open("systemCache")}function j(b){p()&&(d.log("Offline Persistence Toolkit PersistenceManager: Replacing Safari Browser APIs"),Object.defineProperty(b,"_browserRequestConstructor",{value:self.Request,writable:!1}),Object.defineProperty(b,"_persistenceRequestConstructor",{value:n(b),writable:!1}),self.Request=b._persistenceRequestConstructor,g()||(Object.defineProperty(b,"_browserFetchFunc",{value:self.fetch,writable:!1}),self.fetch=o(b))),!g()||b._browserFetchFunc||b._browserXMLHttpRequest||(d.log("Offline Persistence Toolkit PersistenceManager: Replacing browser APIs"),Object.defineProperty(b,"_browserFetchFunc",{value:window.fetch,writable:!1}),Object.defineProperty(b,"_browserXMLHttpRequest",{value:window.XMLHttpRequest,writable:!1}),window.fetch=m(b),window.XMLHttpRequest=function(){return null!=b._browserFetchRequest?new b._browserXMLHttpRequest:new a(b._browserXMLHttpRequest)})}function k(a,b){var c=a,d=c._registrations.indexOf(b);return d>-1&&(c._registrations.splice(d,1),!0)}function l(a,b){Object.defineProperty(this,"scope",{value:a,enumerable:!0}),Object.defineProperty(this,"_persistenceManager",{value:b}),Object.defineProperty(this,"_eventListeners",{value:[],writable:!0})}function m(a){function b(a){Object.defineProperty(this,"isReload",{value:!1,enumerable:!0}),Object.defineProperty(this,"clientId",{value:null,enumerable:!0}),Object.defineProperty(this,"client",{value:null,enumerable:!0}),Object.defineProperty(this,"request",{value:a,enumerable:!0}),Object.defineProperty(this,"_resolveCallback",{value:null,writable:!0}),Object.defineProperty(this,"_rejectCallback",{value:null,writable:!0})}return b.prototype.respondWith=function(a){var b=this;if(a instanceof Promise)a.then(function(a){b._resolveCallback(a)},function(a){b._rejectCallback(a)});else if("function"==typeof a){var c=a();b._resolveCallback(c)}},b.prototype._setPromiseCallbacks=function(a,b){this._resolveCallback=a,this._rejectCallback=b},function(c,d){var e;return e=Request.prototype.isPrototypeOf(c)&&!d?c:new Request(c,d),a.getRegistration(e.url).then(function(c){if(null!=c){var d=new b(e),f=h(a,"fetch",d);if(null!=f&&f instanceof Promise)return f}return a.browserFetch(e)})}}function n(a){function b(c,e){var f=this,g=c,h=e;if(d.log("Offline Persistence Toolkit persistenceRequest: Create New Request"),c._input){d.log("Offline Persistence Toolkit persistenceRequest: Input is a PersistenceRequest"),g=c._input,h=Object.assign({},c._init);for(var i in e)e.hasOwnProperty(i)&&(h[i]=e[i]);if(c.headers&&h&&h.body&&h.body instanceof FormData)if(h.headers){var j=c.headers.get("Content-Type");h.headers.set("Content-Type",j)}else h.headers=c.headers}this._browserRequest=new a._browserRequestConstructor(g,h),this._input=g,this._init=h;var k;for(k in this._browserRequest)"body"!=k&&"function"==typeof this._browserRequest[k]||function(a){var b=Object.getOwnPropertyDescriptor(f._browserRequest,a);b&&(b.writable||b.set)?Object.defineProperty(f,a,{get:function(){return f._browserRequest[a]},set:function(b){f._browserRequest[a]=b},enumerable:!0}):Object.defineProperty(f,a,{get:function(){return f._browserRequest[a]},enumerable:!0})}(k);var l=this.headers.get("Content-Type");null!=l&&l.indexOf("boundary=")>-1&&l.indexOf("form-data")>-1&&(l=l.split("boundary="),this._boundary="--"+l[l.length-1]),this.arrayBuffer=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called arrayBuffer()");var a=this;try{return a._init&&a._init.body&&a._init.body instanceof FormData?s(a._init.body,a._boundary).then(function(a){return q(a)}):a._browserRequest.arrayBuffer()}catch(a){return Promise.reject(a)}},this.blob=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called blob()");var a=this;try{return a._init&&a._init.body&&a._init.body instanceof FormData?s(a._init.body,a._boundary).then(function(b){return new Blob([b],{type:a.headers.get("Content-Type")})}):a._browserRequest.blob()}catch(a){return Promise.reject(a)}},this.formData=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called formData()");var a=this;try{return a._init&&a._init.body&&a._init.body instanceof FormData?Promise.resolve(a._init.body):a._browserRequest.formData()}catch(a){return Promise.reject(a)}},this.json=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called json()");var a=this;try{return a._init&&a._init.body&&a._init.body instanceof FormData?Promise.reject(new SyntaxError("Unexpected number in JSON at position 1")):a._browserRequest.json()}catch(a){return Promise.reject(a)}},this.text=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called text()");var a=this;try{return a._init&&a._init.body&&a._init.body instanceof FormData?s(a._init.body,a._boundary):a._browserRequest.text()}catch(a){return Promise.reject(a)}},this.clone=function(){d.log("Offline Persistence Toolkit persistenceRequest: Called clone()");var a=this;a.headers&&a._init&&a._init.body&&a._init.body instanceof FormData&&(a._init.headers=a.headers);var c=new b(a._input,a._init);return c._browserRequest=a._browserRequest.clone(),c},this.toString=function(){return d.log("Offline Persistence Toolkit persistenceRequest:requestToString()"),this._input.url?this._input.url:this._input}}return b}function o(a){function b(a){Object.defineProperty(this,"isReload",{value:!1,enumerable:!0}),Object.defineProperty(this,"clientId",{value:null,enumerable:!0}),Object.defineProperty(this,"client",{value:null,enumerable:!0}),Object.defineProperty(this,"request",{value:a,enumerable:!0}),Object.defineProperty(this,"_resolveCallback",{value:null,writable:!0}),Object.defineProperty(this,"_rejectCallback",{value:null,writable:!0})}return b.prototype.respondWith=function(a){var b=this;if(a instanceof Promise)a.then(function(a){b._resolveCallback(a)},function(a){b._rejectCallback(a)});else if("function"==typeof a){var c=a();b._resolveCallback(c)}},b.prototype._setPromiseCallbacks=function(a,b){this._resolveCallback=a,this._rejectCallback=b},function(b,c){var e;return e=Request.prototype.isPrototypeOf(b)&&!c?b:new Request(b,c),d.log("Offline Persistence Toolkit serviceWorkerFetch:"+e.url),e._browserRequest&&(e=e._browserRequest),new Promise(function(b,c){a._browserFetchFunc.call(self,e).then(function(a){b(a)},function(a){c(a)})})}}function p(){var a=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),b=/\((iPad|iPhone)/i.test(navigator.userAgent);return a||b}function q(a){return(new TextEncoder).encode(a).buffer}function r(a,b,c){return new Promise(function(d,e){var f;switch(a.constructor.name){case"File":var g=new FileReader;g.onload=function(e){f='\r\nContent-Disposition: form-data; name="'+b.toString()+'"; filename="'+a.name+'"\r\nContent-Type: '+a.type+"\r\n\r\n"+e.target.result+"\r\n"+c,d(f)},g.onerror=function(){g.abort(),e(new DOMException("Problem parsing input file."))},g.readAsText(a);break;case"String":f='\r\nContent-Disposition: form-data; name="'+b+'"\r\n\r\n'+a+"\r\n"+c,d(f);break;default:f='\r\nContent-Disposition: form-data; name="'+b.toString()+'"\r\n\r\n'+a.toString()+"\r\n"+c,d(f)}})}function s(a,b){return new Promise(function(c,d){var e=[],f=b;a.forEach(function(a,c){e.push(r(a,c,b))}),Promise.all(e).then(function(a){a.forEach(function(a){f+=a}),f+="--",c(f)}).catch(function(a){d(a)})})}return e.prototype.init=function(){return d.log("Offline Persistence Toolkit PersistenceManager: Initilizing"),j(this),f(this),i(this),Promise.resolve()},e.prototype.forceOffline=function(a){d.log("Offline Persistence Toolkit PersistenceManager: forceOffline is called with value: "+a),this._forceOffline=a},e.prototype.getCache=function(){return this._cache},e.prototype.isOnline=function(){var a=navigator.onLine;return navigator.network&&navigator.network.connection&&navigator.network.connection.type==Connection.NONE&&(a=!1,d.log("Offline Persistence Toolkit PersistenceManager: Cordova network info plugin is returning online value: "+a)),a&&!this._isOffline&&!this._forceOffline},e.prototype.register=function(a){a=a||{};var b=new l(a.scope,this);return this._registrations.push(b),Promise.resolve(b)},e.prototype.getRegistration=function(a){var b,c,d=this._registrations.length;for(b=0;b<d;b++)if(c=this._registrations[b],a.match(c.scope))return Promise.resolve(c);return Promise.resolve()},e.prototype.getRegistrations=function(){return Promise.resolve(this._registrations.slice())},e.prototype.getSyncManager=function(){return this._persistenceSyncManager},e.prototype.browserFetch=function(a){var b=this;d.log("Offline Persistence Toolkit PersistenceManager: browserFetch() for Request with url: "+a.url);var c=a;return g()?(Object.defineProperty(this,"_browserFetchRequest",{value:a,writable:!0}),new Promise(function(e,f){d.log("Offline Persistence Toolkit PersistenceManager: Calling browser fetch function for Request with url: "+a.url),a._browserRequest&&(c=a._browserRequest),b._browserFetchFunc.call(window,c).then(function(a){e(a)},function(a){f(a)}),b._browserFetchRequest=null})):(a._browserRequest&&(c=a._browserRequest),fetch(c))},l.prototype.addEventListener=function(a,b){this._eventListeners.push({type:a.toLowerCase(),listener:b})},l.prototype.unregister=function(){return Promise.resolve(k(this._persistenceManager,this))},new e});