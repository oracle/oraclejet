define(["./keyValuePersistenceStore","../persistenceStoreManager","./logger"],function(a,b,c){"use strict";function d(a,b,c,d,f){return new Promise(function(g,h){a._directory.getFile(b,{create:!0,exclusive:!1},function(a){a.createWriter(function(a){a.onwriteend=function(){e(c,b,d).then(function(){g()})},a.onerror=function(a){h(a)},"JSON"==d.data_type&&(f=JSON.stringify(f)),a.write(f)})})})}function e(a,b,c){return f().then(function(d){return d.upsert(a,c,{filename:b,metadata:c})})}function f(){var a={index:["key"]};return b.openStore("fileIndex",a)}function g(a,b){return new Promise(function(c,d){a._directory.getFile(b,{create:!1,exclusive:!1},function(a){c(a)},function(a){a.code===FileError.NOT_FOUND_ERR||a.code===FileError.SYNTAX_ERR?c(null):d(a)})})}function h(a,b){var c=new DataView(a.slice(b));return new Blob([c])}function i(a){return f().then(function(b){return b.findByKey(a)})}function j(a){return f().then(function(b){return b.removeByKey(a)})}function k(a,b){return g(a,b).then(function(a){return!!a&&new Promise(function(b,c){a.remove(function(){b(!0)},function(a){b(!1)})})})}function l(){return f().then(function(a){return a.keys()})}function m(){return f().then(function(a){return a.delete()})}function n(a){var b=/[<>\:"\/\\\|\?\*\~]/g,c=/^\.+$/,d=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,e=/[\x00-\x1f\x80-\x9f]/g,f="",g=255,h=a.replace(b,f),i=h.replace(c,f),j=i.replace(d,f),k=j.replace(e,f);return k.length>g?k.slice(0,g):k}var o=function(b){a.call(this,b),this._directoryName=n(b),this._directory=null};return o.prototype=new a,o.prototype.Init=function(b){var c=this;return a.prototype.Init.call(c,b).then(function(){return c._directoryName=n(c._name+c._version),new Promise(function(a,b){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(b){b.root.getDirectory(c._directoryName,{create:!0},function(b){c._directory=b,a()})},function(a){b(a)})})})},o.prototype._insert=function(a,b,c){var e=this;return this.removeByKey(a).then(function(){c instanceof Blob?b.data_type="Blob":b.data_type="JSON";var f=e._directory.createReader();return new Promise(function(g,h){f.readEntries(function(f){for(var h=function(a){var b=f.filter(function(b){return b.name==a});return b.length>0},i=Math.floor(1e8*Math.random())+".pds";h(i);)i=Math.floor(1e8*Math.random())+".pds";d(e,i,a,b,c).then(function(){g()})})})})},o.prototype.getItem=function(a){c.log("Offline Persistence Toolkit fileSystemPersistenceStore: getItem() with key: "+a);var b=this;return i(a).then(function(a){if(a){var c=a.filename,d=a.metadata;return g(b,c).then(function(a){if(a)return new Promise(function(b,c){a.file(function(a){var c=new FileReader;c.onloadend=function(a){var c=h(this.result,0);if("JSON"==d.data_type){var e=new FileReader;e.onloadend=function(){b({metadata:d,value:JSON.parse(this.result)})},e.readAsText(c)}else b({metadata:d,value:c})},c.readAsArrayBuffer(a)},function(a){c(a)})})})}})},o.prototype.removeByKey=function(a){c.log("Offline Persistence Toolkit fileSystemPersistenceStore: removeByKey() with key: "+a);var b=this;return i(a).then(function(c){return c?j(a).then(function(){return k(b,c.filename)}):Promise.resolve(!1)})},o.prototype.keys=function(){return c.log("Offline Persistence Toolkit fileSystemPersistenceStore: keys()"),l()},o.prototype.deleteAll=function(){c.log("Offline Persistence Toolkit fileSystemPersistenceStore: deleteAll()");var a=this;return m().then(function(){var b=[],c=a._directory.createReader();return b.push(new Promise(function(d,e){c.readEntries(function(c){c.map(function(c){b.push(k(a,c.name))}),d()})})),Promise.all(b)})},o.prototype.updateKey=function(a,b){c.log("Offline Persistence Toolkit FileSystemPersistenceStore: updateKey() with currentKey: "+a+" and new key: "+b);return i(a).then(function(a){if(a){var c=a.filename,d=a.metadata;return e(b,c,d)}return Promise.reject("No existing key found to update")}).then(function(){return j(a)})},o});